name: Rebase feature branches on develop update

on:
  push:
    branches:
      - develop

jobs:
  rebase-feature-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all branches
        run: git fetch --all

      - name: Rebase all feature branches onto develop
        run: |
          conflict_found=false

          for branch in $(git branch -r | grep 'origin/feature/' | sed 's|origin/||'); do
            echo "ğŸ”„ Rebasing $branch onto develop..."
            git checkout $branch
            if ! git rebase origin/develop; then
              echo "âŒ Rebase conflict detected in $branch"
              echo "ğŸ” Conflicted files:"
              git diff --name-only --diff-filter=U

              echo ""
              echo "ğŸ§© Conflict details:"
              # ê° ì¶©ëŒ íŒŒì¼ì˜ ì‹¤ì œ diff ë‚´ìš© ì¶œë ¥
              for file in $(git diff --name-only --diff-filter=U); do
                echo "----- $file -----"
                git diff $file
                echo ""
              done

              git rebase --abort
              conflict_found=true
            else
              git push --force-with-lease origin $branch
            fi
          done

          if [ "$conflict_found" = true ]; then
            echo "âŒ One or more branches failed to rebase. Marking workflow as failed."
            exit 1
          else
            echo "âœ… All feature branches successfully rebased onto develop."
          fi
