<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="oss.fosslight.repository.VulnerabilityMapper">

	<sql id="limitPage">
		LIMIT #{startIndex}, #{pageListSize}
	</sql>
    <sql id="orderby">
    	<if test="!@oss.fosslight.util.StringUtil@isEmpty(sidx)">
    		<choose>
    		<when test="@oss.fosslight.util.StringUtil@equals('VERSION', sidx)">
    			<if test="!@oss.fosslight.util.StringUtil@isEmpty(sord)">
<!--     			<choose>
						<when test="@oss.fosslight.util.StringUtil@equals('asc', sord)">
							ORDER BY<if test="vulnerabilityCheckFlag != null"> CASE WHEN VULNERABILITY_RESOLUTION = 'Fixed' THEN 1 ELSE 0 END,</if> A.SEQ ASC
									, A.MAJOR_VERSION ASC
									, BINARY ( CASE WHEN A.VERSION REGEXP '^[a-zA-Z]+' THEN VERSION END ) ASC
									, A.ASCII ASC
									, A.MINOR_VERSION ASC
									, A.PATCH_VERSION ASC
									, A.VERSION_LEN ASC
						</when>
						<when test="@oss.fosslight.util.StringUtil@equals('desc', sord)">
							ORDER BY <if test="vulnerabilityCheckFlag != null"> CASE WHEN VULNERABILITY_RESOLUTION = 'Fixed' THEN 1 ELSE 0 END,</if> A.SEQ DESC
									, A.MAJOR_VERSION DESC
									, BINARY ( CASE WHEN A.VERSION REGEXP '^[a-zA-Z]+' THEN VERSION END ) DESC
									, A.ASCII DESC
									, A.MINOR_VERSION DESC
									, A.PATCH_VERSION DESC
									, A.VERSION_LEN DESC
						</when>
					</choose> -->
    			</if>
    		</when>
    		<otherwise>
    			<choose>
    				<when test="@oss.fosslight.util.StringUtil@equals('PRODUCT', sidx)">
    					ORDER BY<if test="vulnerabilityCheckFlag != null"> CASE WHEN VULNERABILITY_RESOLUTION = 'Fixed' THEN 1 ELSE 0 END,</if>
    					<if test="!@oss.fosslight.util.StringUtil@isEmpty(sord)">
    					<choose>
    						<when test="@oss.fosslight.util.StringUtil@equals('asc', sord)">
    							PRODUCT ASC
    						</when>
    						<when test="@oss.fosslight.util.StringUtil@equals('desc', sord)">
    							PRODUCT DESC
    						</when>
    					</choose>
    					</if>
    					<if test="@oss.fosslight.util.StringUtil@isEmpty(sord)">
    						PRODUCT ASC
    					</if>
    				</when>
    				<when test="@oss.fosslight.util.StringUtil@equals('OSS_NICKNAME', sidx)">
    					ORDER BY<if test="vulnerabilityCheckFlag != null"> CASE WHEN VULNERABILITY_RESOLUTION = 'Fixed' THEN 1 ELSE 0 END,</if>
    					<if test="!@oss.fosslight.util.StringUtil@isEmpty(sord)">
    					<choose>
    						<when test="@oss.fosslight.util.StringUtil@equals('asc', sord)">
    							OSS_NICKNAME ASC
    						</when>
    						<when test="@oss.fosslight.util.StringUtil@equals('desc', sord)">
    							OSS_NICKNAME DESC
    						</when>
    					</choose>
    					</if>
    					<if test="@oss.fosslight.util.StringUtil@isEmpty(sord)">
    						OSS_NICKNAME ASC
    					</if>
    				</when>
    				<when test="@oss.fosslight.util.StringUtil@equals('CVSS_SCORE', sidx)">
    					ORDER BY<if test="vulnerabilityCheckFlag != null"> CASE WHEN VULNERABILITY_RESOLUTION = 'Fixed' THEN 1 ELSE 0 END,</if>
    					<if test="!@oss.fosslight.util.StringUtil@isEmpty(sord)">
    					<choose>
    						<when test="@oss.fosslight.util.StringUtil@equals('asc', sord)">
    							CVSS_SCORE ASC
    						</when>
    						<when test="@oss.fosslight.util.StringUtil@equals('desc', sord)">
    							CVSS_SCORE DESC
    						</when>
    					</choose>
    					</if>
    					<if test="@oss.fosslight.util.StringUtil@isEmpty(sord)">
    						CVSS_SCORE ASC
    					</if>
    				</when>
    				<when test="@oss.fosslight.util.StringUtil@equals('CVE_ID', sidx)">
    					ORDER BY<if test="vulnerabilityCheckFlag != null"> CASE WHEN VULNERABILITY_RESOLUTION = 'Fixed' THEN 1 ELSE 0 END,</if>
    					<if test="!@oss.fosslight.util.StringUtil@isEmpty(sord)">
    					<choose>
    						<when test="@oss.fosslight.util.StringUtil@equals('asc', sord)">
    							CVE_ID ASC
    						</when>
    						<when test="@oss.fosslight.util.StringUtil@equals('desc', sord)">
    							CVE_ID DESC
    						</when>
    					</choose>
    					</if>
    					<if test="@oss.fosslight.util.StringUtil@isEmpty(sord)">
    						CVE_ID ASC
    					</if>
    				</when>
    				<when test="@oss.fosslight.util.StringUtil@equals('MODI_DATE', sidx)">
    					ORDER BY<if test="vulnerabilityCheckFlag != null"> CASE WHEN VULNERABILITY_RESOLUTION = 'Fixed' THEN 1 ELSE 0 END,</if>
    					<if test="!@oss.fosslight.util.StringUtil@isEmpty(sord)">
    					<choose>
    						<when test="@oss.fosslight.util.StringUtil@equals('asc', sord)">
    							MODI_DATE ASC
    						</when>
    						<when test="@oss.fosslight.util.StringUtil@equals('desc', sord)">
    							MODI_DATE DESC
    						</when>
    					</choose>
    					</if>
    					<if test="@oss.fosslight.util.StringUtil@isEmpty(sord)">
    						MODI_DATE ASC
    					</if>
    				</when>
    				<when test="@oss.fosslight.util.StringUtil@equals('VENDOR', sidx)">
    					ORDER BY<if test="vulnerabilityCheckFlag != null"> CASE WHEN VULNERABILITY_RESOLUTION = 'Fixed' THEN 1 ELSE 0 END,</if>
    					<if test="!@oss.fosslight.util.StringUtil@isEmpty(sord)">
    					<choose>
    						<when test="@oss.fosslight.util.StringUtil@equals('asc', sord)">
    							VENDOR ASC
    						</when>
    						<when test="@oss.fosslight.util.StringUtil@equals('desc', sord)">
    							VENDOR DESC
    						</when>
    					</choose>
    					</if>
    					<if test="@oss.fosslight.util.StringUtil@isEmpty(sord)">
    						VENDOR ASC
    					</if>
    				</when>
    			</choose>
    		</otherwise>
    		</choose>
    	</if>
    </sql>

	<sql id="filters">
		AND
		<foreach collection="filtersMap.rules" item="item" separator="AND">
			<choose>
				<when test='item.field == "product"'>
					A.PRODUCT
				</when>
				<when test='item.field == "ossNickname"'>
					A.OSS_NICKNAME
				</when>
				<when test='item.field == "version"'>
					A.VERSION
				</when>
				<when test='item.field == "cvssScore"'>
					A.CVSS_SCORE
				</when>
				<when test='item.field == "cveId"'>
					A.CVE_ID
				</when>
				<when test='item.field == "modiDate"'>
					A.MODI_DATE
				</when>
				<when test='item.field == "vendor"'>
					A.VENDOR
				</when>
			</choose>
			<choose>
				<when test='item.op == "eq"'>
					= #{item.data}
				</when>
				<when test='item.op == "ne"'>
					<![CDATA[<>]]> #{item.data}
				</when>
				<when test='item.op == "bw"'>
					LIKE CONCAT(#{item.data}, '%')
				</when>
				<when test='item.op == "bn"'>
					NOT LIKE CONCAT(#{item.data}, '%')
				</when>
				<when test='item.op == "ew"'>
					LIKE CONCAT('%', #{item.data})
				</when>
				<when test='item.op == "en"'>
					NOT LIKE CONCAT('%', #{item.data})
				</when>
				<when test='item.op == "cn"'>
					LIKE CONCAT('%', #{item.data}, '%')
				</when>
				<when test='item.op == "nc"'>
					NOT LIKE CONCAT('%', #{item.data}, '%')
				</when>
				<when test='item.op == "lt"'>
					<![CDATA[<]]> #{item.data}
				</when>
				<when test='item.op == "le"'>
					<![CDATA[<=]]> #{item.data}
				</when>
				<when test='item.op == "gt"'>
					<![CDATA[>]]> #{item.data}
				</when>
				<when test='item.op == "ge"'>
					<![CDATA[>=]]> #{item.data}
				</when>
				<otherwise>

				</otherwise>
			</choose>
		</foreach>
    </sql>

	<select id="selectVulnerabilityTotalCount" parameterType="oss.fosslight.domain.Vulnerability" resultType="int">
		SELECT COUNT(1)
		FROM
		(
			SELECT SCORE.PRODUCT, SCORE.VERSION, GROUP_CONCAT(SCORE.VENDOR, ',') AS VENDOR, SCORE.CVE_ID, MAX(SCORE.CVSS_SCORE) AS CVSS_SCORE, GROUP_CONCAT(SCORE.OSS_NICKNAME, ',') AS OSS_NICKNAME
			FROM 
			(
				SELECT CASE WHEN NVD.OSS_NICKNAME IS NOT NULL 
				THEN (SELECT DISTINCT OSS_NAME FROM OSS_COMMON WHERE OSS_COMMON_ID = (SELECT OSS_COMMON_ID FROM OSS_NICKNAME WHERE OSS_NICKNAME = NVD.OSS_NICKNAME))
				ELSE REPLACE(NVD.PRODUCT, ' ', '_') END PRODUCT
		  			 , NVD.VERSION
		  			 , NVD.OSS_NICKNAME
		  			 , NVD.VENDOR
		  			 , NVD.CVE_ID
		  			 , NVD.CVSS_SCORE
				FROM (
					SELECT TBL.*
		  			FROM (
		  				SELECT SCORE.PRODUCT
		  			 		, SCORE.VERSION
		  			 		, SCORE.CVE_ID
		  			 		, SCORE.CVSS_SCORE
		  			 		, SCORE.VENDOR
		  			 		, SCORE.VENDORPRODUCT
		  			 		, (SELECT OSS_NICKNAME FROM OSS_NICKNAME WHERE OSS_NICKNAME = SCORE.PRODUCT) AS OSS_NICKNAME
		  				FROM NVD_DATA_SCORE_V3 SCORE
		  				WHERE 1=1
		  				<if test="!@oss.fosslight.util.StringUtil@isEmpty(searchProduct)">
		  					AND MATCH(SCORE.PRODUCT) AGAINST (#{searchProduct})
		  					<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNameAllSearchFlag) and @oss.fosslight.util.StringUtil@equalsIgnoreCase(ossNameAllSearchFlag, 'Y')">
		  						HAVING
		  						<foreach item="item" collection="ossNicknames" open="(" close=")" separator="OR">
		  							SCORE.PRODUCT = #{item} 
		  						</foreach>
		  					</if>
		  				</if>
		  				<if test="!@oss.fosslight.util.StringUtil@isEmpty(cveId)">
		 	   				AND EXISTS (
		 	   					SELECT 1 FROM NVD_DATA_V3 NVD_DATA 
		 	   					WHERE NVD_DATA.CVE_ID = #{cveId} 
		 	   					AND SCORE.PRODUCT = NVD_DATA.PRODUCT 
		 	   					AND SCORE.VERSION = NVD_DATA.VERSION
		 	   				)
						</if>
						<if test="!@oss.fosslight.util.StringUtil@isEmpty(version)">
			   				AND SCORE.VERSION LIKE CONCAT (#{version},'%')
						</if>
						<if test="!@oss.fosslight.util.StringUtil@isEmpty(vendor)">
			   				AND SCORE.VENDOR LIKE CONCAT (#{vendor},'%')
						</if>
						AND EXISTS (SELECT 1 FROM NVD_DATA_V3 WHERE PRODUCT = SCORE.PRODUCT)
					) TBL
				) NVD
			) SCORE
			GROUP BY SCORE.PRODUCT, SCORE.VERSION, SCORE.CVE_ID
		) A
		WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if>
	</select>
	
	<select id="selectVulnerabilityList" parameterType="oss.fosslight.domain.Vulnerability" resultType="oss.fosslight.domain.Vulnerability">
		SELECT A.*
		FROM
		(
			SELECT SCORE.PRODUCT, SCORE.VERSION, GROUP_CONCAT(SCORE.VENDOR, ',') AS VENDOR, SCORE.CVE_ID, GROUP_CONCAT(SCORE.CVSS_SCORE) AS CVSS_SCORE, GROUP_CONCAT(SCORE.OSS_NICKNAME, ',') AS OSS_NICKNAME
			FROM 
			(
				SELECT CASE WHEN NVD.OSS_NICKNAME IS NOT NULL 
				THEN (SELECT DISTINCT OSS_NAME FROM OSS_COMMON WHERE OSS_COMMON_ID = (SELECT OSS_COMMON_ID FROM OSS_NICKNAME WHERE OSS_NICKNAME = NVD.OSS_NICKNAME))
				ELSE REPLACE(NVD.PRODUCT, ' ', '_') END PRODUCT
		  			 , NVD.VERSION
		  			 , NVD.OSS_NICKNAME
		  			 , NVD.VENDOR
		  			 , NVD.CVE_ID
		  			 , NVD.CVSS_SCORE
				FROM (
					SELECT TBL.*
		  			FROM (
		  				SELECT SCORE.PRODUCT
		  			 		, SCORE.VERSION
		  			 		, SCORE.CVE_ID
		  			 		, SCORE.CVSS_SCORE
		  			 		, SCORE.VENDOR
		  			 		, (SELECT OSS_NICKNAME FROM OSS_NICKNAME WHERE OSS_NICKNAME = SCORE.PRODUCT) AS OSS_NICKNAME
		  				FROM NVD_DATA_SCORE_V3 SCORE
		  				WHERE 1=1
		  				<if test="!@oss.fosslight.util.StringUtil@isEmpty(searchProduct)">
		  					AND MATCH(SCORE.PRODUCT) AGAINST (#{searchProduct})
		  					<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNameAllSearchFlag) and @oss.fosslight.util.StringUtil@equalsIgnoreCase(ossNameAllSearchFlag, 'Y')">
		  						HAVING
		  						<foreach item="item" collection="ossNicknames" open="(" close=")" separator="OR">
		  							SCORE.PRODUCT = #{item} 
		  						</foreach>
		  					</if>
		  				</if>
		  				<if test="!@oss.fosslight.util.StringUtil@isEmpty(cveId)">
		 	   				AND EXISTS (
		 	   					SELECT 1 FROM NVD_DATA_V3 NVD_DATA 
		 	   					WHERE NVD_DATA.CVE_ID = #{cveId} 
		 	   					AND SCORE.PRODUCT = NVD_DATA.PRODUCT 
		 	   					AND SCORE.VERSION = NVD_DATA.VERSION
		 	   				)
						</if>
						<if test="!@oss.fosslight.util.StringUtil@isEmpty(version)">
			   				AND SCORE.VERSION LIKE CONCAT (#{version},'%')
						</if>
						<if test="!@oss.fosslight.util.StringUtil@isEmpty(vendor)">
			   				AND SCORE.VENDOR LIKE CONCAT (#{vendor},'%')
						</if>
						AND EXISTS (SELECT 1 FROM NVD_DATA_V3 WHERE PRODUCT = SCORE.PRODUCT)
					) TBL
				) NVD
			) SCORE
			GROUP BY SCORE.PRODUCT, SCORE.VERSION, SCORE.CVE_ID
		) A
		WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if>
		<include refid="orderby"/>
		<include refid="limitPage"/>
	</select>
	
	<select id="checkVulnDataCnt" parameterType="oss.fosslight.domain.Vulnerability" resultType="int">
		SELECT 
			COUNT(1) 
		FROM NVD_DATA_V3 A 
			INNER JOIN NVD_CVE_V3 T2 ON T1.CVE_ID = T2.CVE_ID
		WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(cveId)">
			AND A.CVE_ID = #{cveId}
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(vulnSummary)">
			<if test="!@oss.fosslight.util.StringUtil@equalsIgnoreCase(ossNameAllSearchFlag,'Y')">
				AND T2.VULN_SUMMARY LIKE CONCAT('%',#{vulnSummary},'%')
			</if>
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(product)">
			<choose>
				<when test="@oss.fosslight.util.StringUtil@equalsIgnoreCase(ossNameAllSearchFlag,'Y')">
					AND (
						A.PRODUCT = REPLACE(#{product}, ' ', '_')
						<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
			  			    <foreach item="item" index="index" collection="ossNicknames">
								OR A.PRODUCT = REPLACE(#{item}, ' ', '_')
							</foreach>
						</if>
					)
				</when>
				<otherwise>
					AND A.PRODUCT LIKE CONCAT('%',#{product},'%')
				</otherwise>
			</choose>
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(version)">
			<choose>
				<when test="@oss.fosslight.util.StringUtil@equalsIgnoreCase(ossNameAllSearchFlag,'Y')">
					AND A.VERSION = #{version}
				</when>
				<otherwise>
					AND A.VERSION LIKE CONCAT (#{version},'%')
				</otherwise>
			</choose>
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if>
	</select>
	
	<!-- OSS Name 자동완성 -->
	<select id="selectVulnerabilityOSSNameAutoComplete" resultType="String">
		SELECT PRODUCT FROM NVD_DATA_V3 GROUP BY PRODUCT ORDER BY PRODUCT ASC
	</select>
	
	<!-- OSS Version 자동완성 -->
	<select id="selectVulnerabilityOSSVersionAutoComplete" parameterType="String" resultType="String">
		SELECT VERSION 
		FROM NVD_DATA_V3 
		WHERE PRODUCT= #{name}
		GROUP BY VERSION 
		ORDER BY VERSION ASC
	</select>
	
	<!-- CVE_ID 자동완성 -->
	<select id="selectVulnerabilityCveIdAutoComplete" resultType="String">
		SELECT CVE_ID 
		FROM NVD_CVE_V3 
		ORDER BY CVE_ID ASC
	</select>
	
	<select id="getVulnListByOssNameCnt" parameterType="oss.fosslight.domain.OssMaster" resultType="int">
		SELECT COUNT(*) AS CNT
		  FROM (
			<!-- exact match -->
				SELECT DATA.PRODUCT
					 , DATA.VERSION
					 , CVE.CVSS_SCORE
					 , CVE.CVE_ID
					 , CVE.VULN_SUMMARY
					 , CVE.MODI_DATE
					 <if test="@oss.fosslight.util.StringUtil@equals('VERSION', sidx)">
						, (CASE WHEN DATA.VERSION = '' THEN 1 WHEN DATA.VERSION REGEXP '^[0-9\.]+' THEN 2 WHEN DATA.VERSION REGEXP '^[a-z]+' THEN 3 ELSE 4 END) AS SEQ 
						, SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 1)+0 AS MAJOR_VERSION 
						, IF(DATA.VERSION REGEXP '[\.]{1}' , SUBSTRING_INDEX(SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 2), '.', -1)+0 , NULL) AS MINOR_VERSION 
						, IF(DATA.VERSION REGEXP '[\.]{1}' , SUBSTRING_INDEX(SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 3), '.', -1)+0 , NULL) AS PATCH_VERSION
						, LENGTH(DATA.VERSION) AS VERSION_LEN
						, ASCII(SUBSTRING(DATA.VERSION, 1)) AS ASCII
					 </if>
				  FROM (
				  		SELECT NVD.PRODUCT, NVD.VERSION, NVD.CVE_ID
				  		FROM
				  		(SELECT PRODUCT
				 			 , VERSION
				 			 , CVE_ID
				  		  FROM NVD_DATA_V3
				  		 WHERE (
				  		 		PRODUCT = REPLACE(#{ossName}, ' ', '_')
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(schOssName)">
				  		 			OR PRODUCT = REPLACE(#{schOssName}, ' ', '_')
				  		 		</if>
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
					  			    <foreach item="item" index="index" collection="ossNicknames">
										OR PRODUCT = REPLACE(#{item}, ' ', '_')
									</foreach>
								</if>
								<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
					  			    <foreach item="item" index="index" collection="ossNicknames">
										OR VENDORPRODUCT = REPLACE(#{item}, ' ', '_')
									</foreach>
								</if>
				 				)
				 		 <if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersion) and @oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
				 		   AND VERSION = #{ossVersion}
				 		 </if>
				 		 ) NVD
				 		 GROUP BY NVD.PRODUCT, NVD.VERSION, NVD.CVE_ID
				 	   ) DATA
				 INNER JOIN NVD_CVE_V3 CVE
				    ON DATA.CVE_ID = CVE.CVE_ID
		  ) A
		  WHERE 1 = 1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if> 
	</select>
	
	<select id="getVulnListByOssName" parameterType="oss.fosslight.domain.OssMaster" resultType="oss.fosslight.domain.Vulnerability">
		SELECT A.*
		  FROM (
				SELECT DATA.PRODUCT
					 , DATA.VERSION
					 , CVE.CVSS_SCORE
					 , CVE.CVE_ID
					 , CVE.VULN_SUMMARY
					 , CVE.PUBL_DATE
					 , CVE.MODI_DATE
					 <if test="!@oss.fosslight.util.StringUtil@isEmpty(vulnerabilityCheckFlag) and !@oss.fosslight.util.StringUtil@equals('N', vulnerabilityCheckFlag)">
					 , (SELECT VULNERABILITY_RESOLUTION FROM NVD_DATA_SECURITY 
					 	WHERE CVE_ID = CVE.CVE_ID 
					 	AND REFERENCE_ID = #{prjId}
					 	AND (OSS_NAME = #{ossName} or OSS_NAME = REPLACE(#{ossName}, '_', ' '))
					 <if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
					 	AND OSS_VERSION = #{ossVersion}
					 </if>
					 <if test="@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
					 	AND OSS_VERSION = ''
					 </if>
					 	) AS VULNERABILITY_RESOLUTION
					 </if>
					 <if test="@oss.fosslight.util.StringUtil@equals('VERSION', sidx)">
						, (CASE WHEN DATA.VERSION = '' THEN 1 WHEN DATA.VERSION REGEXP '^[0-9\.]+' THEN 2 WHEN DATA.VERSION REGEXP '^[a-z]+' THEN 3 ELSE 4 END) AS SEQ 
						, SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 1)+0 AS MAJOR_VERSION 
						, IF(DATA.VERSION REGEXP '[\.]{1}' , SUBSTRING_INDEX(SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 2), '.', -1)+0 , NULL) AS MINOR_VERSION 
						, IF(DATA.VERSION REGEXP '[\.]{1}' , SUBSTRING_INDEX(SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 3), '.', -1)+0 , NULL) AS PATCH_VERSION
						, LENGTH(DATA.VERSION) AS VERSION_LEN
						, ASCII(SUBSTRING(DATA.VERSION, 1)) AS ASCII
					 </if>
				  FROM (
				  		SELECT NVD.PRODUCT, NVD.VERSION, NVD.CVE_ID
				  		FROM
				  		(SELECT PRODUCT
				 			 , VERSION
				 			 , CVE_ID
				  		  FROM NVD_DATA_V3
				  		 WHERE (
				  		 		PRODUCT = REPLACE(#{ossName}, ' ', '_')
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(schOssName)">
				  		 			OR PRODUCT = REPLACE(#{schOssName}, ' ', '_')
				  		 		</if>
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
					  			    <foreach item="item" index="index" collection="ossNicknames">
										OR PRODUCT = REPLACE(#{item}, ' ', '_')
									</foreach>
								</if>
								<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
					  			    <foreach item="item" index="index" collection="ossNicknames">
										OR VENDORPRODUCT = REPLACE(#{item}, ' ', '_')
									</foreach>
								</if>
				 				)
				 		 <if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
				 		   AND VERSION = #{ossVersion}
				 		 </if>
				 		 ) NVD
				 		 GROUP BY NVD.PRODUCT, NVD.VERSION, NVD.CVE_ID
				 	   ) DATA
				 INNER JOIN NVD_CVE_V3 CVE
				    ON DATA.CVE_ID = CVE.CVE_ID
		  ) A
		  WHERE 1 = 1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if> 
		<include refid="orderby"/>
		<include refid="limitPage"/>
	</select>
	
	<select id="getVulnListByOssName2" parameterType="oss.fosslight.domain.OssMaster" resultType="oss.fosslight.domain.Vulnerability">
		SELECT A.*
		  FROM (
				SELECT DATA.PRODUCT
					 , DATA.VERSION
					 , CVE.CVSS_SCORE
					 , CVE.CVE_ID
					 , CVE.VULN_SUMMARY
					 , CVE.PUBL_DATE
					 , CVE.MODI_DATE
					 , DATA.CRITERIA
					 <if test="!@oss.fosslight.util.StringUtil@isEmpty(vulnerabilityCheckFlag) and !@oss.fosslight.util.StringUtil@equals('N', vulnerabilityCheckFlag)">
					 , (SELECT VULNERABILITY_RESOLUTION FROM NVD_DATA_SECURITY 
					 	WHERE CVE_ID = CVE.CVE_ID 
					 	AND REFERENCE_ID = #{prjId}
					 	AND (OSS_NAME = #{ossName} or OSS_NAME = REPLACE(#{ossName}, '_', ' '))
					 <if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
					 	AND OSS_VERSION = #{ossVersion}
					 </if>
					 <if test="@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
					 	AND OSS_VERSION = ''
					 </if>
					 	) AS VULNERABILITY_RESOLUTION
					 </if>
					 <if test="@oss.fosslight.util.StringUtil@equals('VERSION', sidx)">
						, (CASE WHEN DATA.VERSION = '' THEN 1 WHEN DATA.VERSION REGEXP '^[0-9\.]+' THEN 2 WHEN DATA.VERSION REGEXP '^[a-z]+' THEN 3 ELSE 4 END) AS SEQ 
						, SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 1)+0 AS MAJOR_VERSION 
						, IF(DATA.VERSION REGEXP '[\.]{1}' , SUBSTRING_INDEX(SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 2), '.', -1)+0 , NULL) AS MINOR_VERSION 
						, IF(DATA.VERSION REGEXP '[\.]{1}' , SUBSTRING_INDEX(SUBSTRING_INDEX((CASE WHEN DATA.VERSION REGEXP '^[0-9]+' THEN DATA.VERSION END), '.', 3), '.', -1)+0 , NULL) AS PATCH_VERSION
						, LENGTH(DATA.VERSION) AS VERSION_LEN
						, ASCII(SUBSTRING(DATA.VERSION, 1)) AS ASCII
					 </if>
				  FROM (
				  	<if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
				  		SELECT NVD.PRODUCT, NVD.VERSION, NVD.CVE_ID, NVD.CRITERIA
				  		FROM
				  		(SELECT PRODUCT
				 			 , VERSION
				 			 , CVE_ID
				 			 , CONCAT(VENDOR, ':', PRODUCT) AS CRITERIA
				  		  FROM NVD_DATA_V3
				  		 WHERE (
				  		 		PRODUCT = REPLACE(#{ossName}, ' ', '_')
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(schOssName)">
				  		 			OR PRODUCT = REPLACE(#{schOssName}, ' ', '_')
				  		 		</if>
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
					  			    <foreach item="item" index="index" collection="ossNicknames">
										OR PRODUCT = REPLACE(#{item}, ' ', '_')
									</foreach>
								</if>
				 				)
				 		   AND VERSION = #{ossVersion}
				 		 ) NVD
				 		 <if test="!@oss.fosslight.util.StringUtil@isEmpty(excludeCpes)">
				 		 	WHERE 1=1
				 		 	<foreach item="item" index="index" collection="excludeCpes">
								AND NVD.CRITERIA != #{item}
							</foreach>
				 		 </if>
				 		 GROUP BY NVD.PRODUCT, NVD.VERSION, NVD.CVE_ID
					</if>
					<if test="@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
						SELECT NVD.PRODUCT, '-' AS VERSION, NVD.CVE_ID, NVD.CRITERIA
				  		FROM
				  		(SELECT PRODUCT
				 			 , CVE_ID
				 			 , CONCAT(VENDOR, ':', PRODUCT) AS CRITERIA
				  		  FROM NVD_DATA_V3
				  		 WHERE (
				  		 		PRODUCT = REPLACE(#{ossName}, ' ', '_')
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(schOssName)">
				  		 			OR PRODUCT = REPLACE(#{schOssName}, ' ', '_')
				  		 		</if>
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
					  			    <foreach item="item" index="index" collection="ossNicknames">
										OR PRODUCT = REPLACE(#{item}, ' ', '_')
									</foreach>
								</if>
				 				)
				 		 ) NVD
				 		 <if test="!@oss.fosslight.util.StringUtil@isEmpty(excludeCpes)">
				 		 	WHERE 1=1
				 		 	<foreach item="item" index="index" collection="excludeCpes">
								AND NVD.CRITERIA != #{item}
							</foreach>
				 		 </if>
				 		 GROUP BY NVD.PRODUCT, NVD.CVE_ID
					</if>
				 	   ) DATA
				 INNER JOIN NVD_CVE_V3 CVE
				    ON DATA.CVE_ID = CVE.CVE_ID
		  ) A
		  WHERE 1 = 1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if> 
		<include refid="orderby"/>
<!-- 	<include refid="limitPage"/> -->
	</select>
	
	<update id="updateOssRecheckVulnFlag">
		UPDATE OSS_VERSION SET VULN_CPE_NM = NULL, CVSS_SCORE = NULL, CVE_ID = NULL, VULN_YN = NULL, VULN_RECHECK = 'N', VULN_DATE = NULL WHERE VULN_RECHECK = 'Y'
	</update>
	<select id="selectNvdTotalCount" resultType="int">SELECT COUNT(1) FROM NVD_DATA_SCORE_V3</select>
   <select id="selectVendorProductInfo" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
    	SELECT PRODUCT, VERSION, VENDOR, CVE_ID, CVSS_SCORE, MODI_DATE 
    	FROM NVD_DATA_SCORE_V3 
    	WHERE VERSION = #{ossVersion} AND ( VENDORPRODUCT = #{ossName}
		<if test="ossNicknames != null">
			<foreach item="item" collection="ossNicknames">
				OR VENDORPRODUCT = #{item}
			</foreach>
		</if>
		)
		ORDER BY CVSS_SCORE DESC
   </select>
   <select id="selectVendorProductByIncludeCpeInfo" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
   	SELECT A.*
	<if test="!@oss.fosslight.util.StringUtil@isEmpty(vulnerabilityCheckFlag) and !@oss.fosslight.util.StringUtil@equals('N', vulnerabilityCheckFlag)">
		, (SELECT VULNERABILITY_RESOLUTION FROM NVD_DATA_SECURITY 
		 	WHERE CVE_ID = A.CVE_ID 
		 	AND REFERENCE_ID = #{prjId}
		 	AND (OSS_NAME = A.PRODUCT or OSS_NAME = REPLACE(A.PRODUCT, '_', ' '))
		 	AND OSS_VERSION = IF(A.VERSION = '-', '', A.VERSION)
		) AS VULNERABILITY_RESOLUTION
	</if>
	FROM
	(
		SELECT NVD.*, IFNULL(CFGR.CRITERIA, (SELECT CRITERIA FROM NVD_DATA_CONFIGURATIONS WHERE PRODUCT = NVD.PRODUCT AND VERSION = '*' AND VENDOR = NVD.VENDOR AND CVE_ID = NVD.CVE_ID GROUP BY CRITERIA LIMIT 1)) AS CRITERIA
		FROM
		(	   	
		   	SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE, CVE.VULN_SUMMARY
			FROM NVD_DATA_V3 NVD
			INNER JOIN NVD_CVE_V3 CVE
			ON NVD.CVE_ID = CVE.CVE_ID
			WHERE
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(includeCpes)">
				<foreach item="item" collection="includeCpes" open="(" close=")" separator="OR">
					NVD.VENDORPRODUCT = REPLACE(#{item}, ':', '-')
				</foreach>
			</if>
			<if test="@oss.fosslight.util.StringUtil@isEmpty(ossVersion) or @oss.fosslight.util.StringUtil@equals('-', ossVersion)">
				GROUP BY CVE.CVE_ID
			</if>
		) NVD
		LEFT JOIN NVD_DATA_CONFIGURATIONS CFGR
		ON NVD.PRODUCT = CFGR.PRODUCT
		AND NVD.VERSION = CFGR.VERSION
		AND NVD.VENDOR = CFGR.VENDOR
		AND NVD.CVE_ID = CFGR.CVE_ID
	) A
	WHERE 1 = 1
	<choose>
   		<when test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersion) and !@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
   			<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and !@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
			AND (
				<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
					A.VERSION = #{item}
				</foreach>
				OR
				<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
					SUBSTRING_INDEX(SUBSTRING_INDEX(A.CRITERIA, ':', 7), ':', -2) = #{item}
				</foreach>
				)
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and @oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
			AND 
				<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
					A.VERSION = #{item}
				</foreach>
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon) and @oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases)">
			AND
				<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
					SUBSTRING_INDEX(SUBSTRING_INDEX(A.CRITERIA, ':', 7), ':', -2) = #{item}
				</foreach>
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
				<include refid="filters"/>
			</if>
			GROUP BY A.CVSS_SCORE, A.CVE_ID, A.CRITERIA
			ORDER BY A.CVSS_SCORE DESC
   		</when>
   		<otherwise>
   			<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
				<include refid="filters"/>
			</if>
			GROUP BY A.CVE_ID
			ORDER BY A.CVSS_SCORE DESC, A.MODI_DATE DESC
			<if test="@oss.fosslight.util.StringUtil@isEmpty(vulnerabilityCheckFlag)">
				LIMIT 10
			</if>
   		</otherwise>
   	</choose>
   </select>
   <select id="selectVendorProductByExcludeCpeInfo" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
   	SELECT A.*
	<if test="!@oss.fosslight.util.StringUtil@isEmpty(vulnerabilityCheckFlag) and !@oss.fosslight.util.StringUtil@equals('N', vulnerabilityCheckFlag)">
		, (SELECT VULNERABILITY_RESOLUTION FROM NVD_DATA_SECURITY 
		 	WHERE CVE_ID = A.CVE_ID 
		 	AND REFERENCE_ID = #{prjId}
		 	AND (OSS_NAME = A.PRODUCT or OSS_NAME = REPLACE(A.PRODUCT, '_', ' '))
		 	AND OSS_VERSION = IF(A.VERSION = '-', '', A.VERSION)
		) AS VULNERABILITY_RESOLUTION
	</if>
	FROM
	(
	   	SELECT NVD.*, IFNULL(CFGR.CRITERIA, (SELECT CRITERIA FROM NVD_DATA_CONFIGURATIONS WHERE PRODUCT = NVD.PRODUCT AND VERSION = '*' AND VENDOR = NVD.VENDOR AND CVE_ID = NVD.CVE_ID GROUP BY CRITERIA LIMIT 1)) AS CRITERIA
		FROM
		(	   	
		   	SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE, CVE.VULN_SUMMARY
			FROM NVD_DATA_V3 NVD
			INNER JOIN NVD_CVE_V3 CVE
			ON NVD.CVE_ID = CVE.CVE_ID
			WHERE
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(excludeCpes)">
				<foreach item="item" collection="excludeCpes" open="(" close=")" separator="OR">
					NVD.VENDORPRODUCT = REPLACE(#{item}, ':', '-')
				</foreach>
			</if>
			<if test="@oss.fosslight.util.StringUtil@isEmpty(ossVersion) or @oss.fosslight.util.StringUtil@equals('-', ossVersion)">
				GROUP BY CVE.CVE_ID
			</if>
		) NVD
		LEFT JOIN NVD_DATA_CONFIGURATIONS CFGR
		ON NVD.PRODUCT = CFGR.PRODUCT
		AND NVD.VERSION = CFGR.VERSION
		AND NVD.VENDOR = CFGR.VENDOR
		AND NVD.CVE_ID = CFGR.CVE_ID
	) A
	WHERE 1 = 1
	<choose>
   		<when test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersion) and !@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
   			<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and !@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
			AND (
				<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
					A.VERSION = #{item}
				</foreach>
				OR
				<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
					SUBSTRING_INDEX(SUBSTRING_INDEX(A.CRITERIA, ':', 7), ':', -2) = #{item}
				</foreach>
				)
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and @oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
			AND 
				<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
					A.VERSION = #{item}
				</foreach>
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon) and @oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases)">
			AND
				<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
					SUBSTRING_INDEX(SUBSTRING_INDEX(A.CRITERIA, ':', 7), ':', -2) = #{item}
				</foreach>
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
				<include refid="filters"/>
			</if>
			GROUP BY A.CVSS_SCORE, A.CVE_ID, A.CRITERIA
			ORDER BY A.CVSS_SCORE DESC
   		</when>
   		<otherwise>
   			<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
				<include refid="filters"/>
			</if>
			GROUP BY A.CVE_ID
			ORDER BY A.CVSS_SCORE DESC, A.MODI_DATE DESC
   		</otherwise>
   	</choose>
   </select>
   <select id="selectVendorProductSndMailList" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
    	SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE
		FROM    		
    	(
    		SELECT PRODUCT, VERSION, VENDOR, CVE_ID
    		FROM NVD_DATA_V3 
    		WHERE VENDORPRODUCT IS NOT NULL
    		AND VERSION = #{ossVersion} 
    		AND ( VENDORPRODUCT = #{ossName}
		<if test="ossNicknames != null">
			<foreach item="item" collection="ossNicknames">
				OR VENDORPRODUCT = #{item}
			</foreach>
		</if>)
		) NVD
		INNER JOIN NVD_CVE_V3 CVE
		ON NVD.CVE_ID = CVE.CVE_ID
		WHERE CVE.CVSS_SCORE >= #{standardScore}
		AND (CVE.PUBL_DATE >= DATE_ADD(NOW(), INTERVAL-1 WEEK) OR CVE.MODI_DATE >= DATE_ADD(NOW(), INTERVAL-1 WEEK))
		ORDER BY CVE.CVSS_SCORE*1 DESC
   </select>
   <select id="selectNvdInfoByVersionAlias" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
		SELECT TBL.*
		FROM
		(
		   	SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE, NVD2.CRITERIA, CVE.VULN_SUMMARY
			FROM NVD_DATA_V3 NVD
			INNER JOIN NVD_CVE_V3 CVE
			ON NVD.CVE_ID = CVE.CVE_ID
			INNER JOIN (
				SELECT MATCH_CRITERIA_ID, CVE_ID, VENDOR, PRODUCT, VERSION, CRITERIA
				FROM NVD_DATA_CONFIGURATIONS
				WHERE (
					PRODUCT = REPLACE(#{ossName}, ' ', '_')
					<if test="ossNicknames != null">
						<foreach item="item" collection="ossNicknames">
							OR PRODUCT = REPLACE(#{item}, ' ', '_')
						</foreach>
					</if>
				)
				GROUP BY PRODUCT, VERSION, CVE_ID
			) NVD2
			ON NVD.PRODUCT = NVD2.PRODUCT
			AND NVD.VERSION = NVD2.VERSION
			AND NVD.VENDOR = NVD2.VENDOR
			AND NVD.CVE_ID = NVD2.CVE_ID
			WHERE NOT EXISTS (
				SELECT 1
				FROM
				(	
					SELECT CASE 
							WHEN (LENGTH(CPE23URI) - LENGTH(REPLACE(CPE23URI, ':', ''))) = 12 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(CPE23URI, ':', 5), ':', -2)
							WHEN (LENGTH(CPE23URI) - LENGTH(REPLACE(CPE23URI, ':', ''))) <![CDATA[<]]> 12 THEN CPE23URI ELSE CPE23URI END CRITERIA
					FROM OSS_INCLUDE_CPE
				) CPE
				WHERE CPE.CRITERIA = CONCAT(NVD.VENDOR, ':', NVD.PRODUCT)
			)
		) TBL
	   	WHERE 1 = 1
	   	<choose>
	   		<when test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersion) and !@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
	   			<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and !@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
				AND (
					<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 6), ':', -1) = #{item}
					</foreach>
					OR
					<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 7), ':', -2) = #{item}
					</foreach>
					)
				</if>
				<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and @oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
				AND 
					<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 6), ':', -1) = #{item}
					</foreach>
				</if>
				<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon) and @oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases)">
				AND
					<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 7), ':', -2) = #{item}
					</foreach>
				</if>
				GROUP BY TBL.CVSS_SCORE, TBL.CVE_ID, TBL.CRITERIA
				ORDER BY TBL.CVSS_SCORE DESC
	   		</when>
	   		<otherwise>
	   			GROUP BY TBL.CVE_ID
				ORDER BY TBL.CVSS_SCORE DESC, TBL.MODI_DATE DESC
				<if test="@oss.fosslight.util.StringUtil@isEmpty(vulnerabilityCheckFlag)">
					LIMIT 10
				</if>
	   		</otherwise>
	   	</choose>
   </select>
   <select id="selectNvdInfo" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
    	SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE 
    	FROM NVD_DATA_V3 NVD
    	INNER JOIN NVD_CVE_V3 CVE
    	ON NVD.CVE_ID = CVE.CVE_ID 
    	WHERE NVD.VERSION = #{ossVersion} AND ( NVD.PRODUCT = #{ossName} OR NVD.PRODUCT = REPLACE(#{ossName}, ' ', '_')
		<if test="ossNicknames != null">
			<foreach item="item" collection="ossNicknames">
				OR NVD.PRODUCT = REPLACE(#{item}, ' ', '_')
			</foreach>
		</if>
		)
		AND NOT EXISTS (
			SELECT 1
			FROM
			(	
				SELECT CASE 
						WHEN (LENGTH(CPE23URI) - LENGTH(REPLACE(CPE23URI, ':', ''))) = 12 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(CPE23URI, ':', 5), ':', -2)
						WHEN (LENGTH(CPE23URI) - LENGTH(REPLACE(CPE23URI, ':', ''))) <![CDATA[<]]> 12 THEN CPE23URI ELSE CPE23URI END CRITERIA
				FROM OSS_INCLUDE_CPE
			) CPE
			WHERE CPE.CRITERIA = CONCAT(NVD.VENDOR, ':', NVD.PRODUCT)
		)
		ORDER BY CVE.CVSS_SCORE DESC
    </select>
    <select id="selectNvdInfoSndMailList" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
    	SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE 
    	FROM
    	(
    		SELECT PRODUCT, VERSION, VENDOR, CVE_ID
    		FROM NVD_DATA_V3
    		WHERE VERSION = #{ossVersion} 
    		AND ( PRODUCT = #{ossName}
			<if test="ossNicknames != null">
				<foreach item="item" collection="ossNicknames">
					OR PRODUCT = #{item}
				</foreach>
			</if>
			)
		) NVD
		INNER JOIN NVD_CVE_V3 CVE
		ON NVD.CVE_ID = CVE.CVE_ID
		WHERE CVE.CVSS_SCORE >= #{standardScore}
		AND (CVE.PUBL_DATE >= DATE_ADD(NOW(), INTERVAL-1 WEEK) OR CVE.MODI_DATE >= DATE_ADD(NOW(), INTERVAL-1 WEEK))
		ORDER BY CVE.CVSS_SCORE*1 DESC
    </select>
    <select id="selectDiffVendorForProduct" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
    	SELECT NVD.PRODUCT, NVD.VENDOR, NVD.CVE_ID
    	FROM (
    		SELECT NVD.PRODUCT, NVD.VENDOR, CVE.CVE_ID
    		FROM NVD_DATA_V3 NVD
    		INNER JOIN NVD_CVE_V3 CVE
    		ON NVD.CVE_ID = CVE.CVE_ID
    		WHERE NVD.VENDOR != ''
    		AND ( NVD.PRODUCT = #{ossName}
			<if test="ossNicknames != null">
				<foreach item="item" collection="ossNicknames">
					OR NVD.PRODUCT = #{item}
				</foreach>
			</if>
			)
		) NVD
		GROUP BY NVD.PRODUCT, NVD.VENDOR
		
		UNION
		
		SELECT NVD.PRODUCT, NVD.VENDOR, NVD.CVE_ID
    	FROM (
    		SELECT NVD.PRODUCT, NVD.VENDOR, CVE.CVE_ID
    		FROM NVD_DATA_V3 NVD
    		INNER JOIN NVD_CVE_V3 CVE
    		ON NVD.CVE_ID = CVE.CVE_ID
    		WHERE NVD.VENDOR != ''
    		AND ( NVD.VENDORPRODUCT = #{ossName}
			<if test="ossNicknames != null">
				<foreach item="item" collection="ossNicknames">
					OR NVD.VENDORPRODUCT = #{item}
				</foreach>
			</if>
			)
		) NVD
		GROUP BY NVD.PRODUCT, NVD.VENDOR
    </select>
    <insert id="insertNvdOssHis" parameterType="oss.fosslight.domain.OssMaster">
    	INSERT INTO NVD_OSS_HIS (OSS_ID, OSS_NAME, OSS_VERSION, CVE_ID, CVSS_SCORE, CVE_ID_TO, CVSS_SCORE_TO) VALUES (#{ossId}, #{ossName}, #{ossVersion}, #{cveId}, #{cvssScore}, #{cveIdTo}, ${cvssScoreTo});
    </insert>
    <update id="deleteOssVulnInfo" parameterType="String">
		UPDATE OSS_VERSION
		SET VULN_CPE_NM = NULL
			, CVSS_SCORE = NULL
			, CVE_ID = NULL
			, VULN_YN = 'N'
			, VULN_DATE = NULL
			, IN_CPE_MATCH_FLAG = NULL 
		WHERE OSS_ID = #{ossId}
    </update>
    <update id="updateOssVulnInfoNew" parameterType="oss.fosslight.domain.OssMaster">
    	UPDATE OSS_VERSION
    		SET CVSS_SCORE = #{cvssScore}
    			, VULN_YN = 'Y'
    			, VULN_DATE = NOW()
    			, CVE_ID = #{cveId}
    		<if test="!@oss.fosslight.util.StringUtil@isEmpty(inCpeMatchFlag)">
    			, IN_CPE_MATCH_FLAG = #{inCpeMatchFlag}
    		</if>
    	WHERE OSS_ID = #{ossId}
    </update>
    
	<select id="selectUsedVulnerabilityOssProject" parameterType="oss.fosslight.domain.OssMaster" resultType="String">
		SELECT 
			T1.PRJ_ID 
		FROM PROJECT_MASTER T1
		WHERE
			T1.USE_YN = 'Y'
			AND T1.IDENTIFICATION_STATUS = 'CONF'
			AND (T1.DROP_YN IS NULL OR T1.DROP_YN != 'Y')
			AND EXISTS (
					SELECT 1 
					FROM OSS_COMPONENTS T2 
					WHERE 
						T1.PRJ_ID = T2.REFERENCE_ID 
						AND T2.REFERENCE_DIV = '50' 
						AND ( OSS_NAME = #{ossName}
					<if test="ossNames != null">
						<foreach collection="ossNames" item="item" open="OR " close="" separator="OR">
							OSS_NAME = #{item}
						</foreach>
					</if>
						)
						AND OSS_VERSION = #{ossVersion}
			)
	</select>
	
    <!-- CVE ID 가 자주 변경되지 않도록 CVE_ID 순으로 정렬한다. -->
    <select id="selectNvdInfoWithOutVer" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
		SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE
	   	FROM NVD_DATA_V3 NVD
	    INNER JOIN NVD_CVE_V3 CVE
	    ON NVD.CVE_ID = CVE.CVE_ID
	    WHERE (NVD.PRODUCT = #{ossName} OR NVD.PRODUCT = REPLACE(#{ossName}, ' ', '_')
		<if test="ossNicknames != null">
			<foreach item="item" collection="ossNicknames">
				OR NVD.PRODUCT = REPLACE(#{item}, ' ', '_')
			</foreach>
		</if>
		)
		AND NOT EXISTS (
			SELECT 1
			FROM
			(	
				SELECT CASE 
						WHEN (LENGTH(CPE23URI) - LENGTH(REPLACE(CPE23URI, ':', ''))) = 12 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(CPE23URI, ':', 5), ':', -2)
						WHEN (LENGTH(CPE23URI) - LENGTH(REPLACE(CPE23URI, ':', ''))) <![CDATA[<]]> 12 THEN CPE23URI ELSE CPE23URI END CRITERIA
				FROM OSS_INCLUDE_CPE
			) CPE
			WHERE CPE.CRITERIA = CONCAT(NVD.VENDOR, ':', NVD.PRODUCT)
		)
		ORDER BY CVE.CVSS_SCORE DESC
		LIMIT 50
    </select>
    
    <select id="selectNvdInfoWithOutVer2" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
		SELECT T2.PRODUCT, T2.VERSION, T2.VENDOR, T2.CVE_ID, T2.CVSS_SCORE, T2.MODI_DATE 
    	FROM (
    		SELECT PRODUCT, MAX(CVSS_SCORE) AS CVSS_SCORE
    		FROM NVD_DATA_SCORE_V3 
    		WHERE VERSION = '-' 
    		AND ( PRODUCT = #{ossName}
			<if test="ossNicknames != null">
				<foreach item="item" collection="ossNicknames">
					OR PRODUCT = REPLACE(#{item}, ' ', '_')
				</foreach>
			</if>
			)
			GROUP BY PRODUCT
		) T1
		INNER JOIN NVD_DATA_SCORE_V3 T2 ON T1.PRODUCT = T2.PRODUCT AND T1.CVSS_SCORE = T2.CVSS_SCORE
    	ORDER BY CVE_ID
    	LIMIT 1
    </select>
    
    <select id="selectVendorProductInfoWithOurVer" parameterType="oss.fosslight.domain.OssMaster" resultType="HashMap">
		SELECT T2.PRODUCT, T2.VERSION, T2.VENDOR, T2.CVE_ID, T2.CVSS_SCORE, T2.MODI_DATE 
    	FROM (
    		SELECT PRODUCT, MAX(CVSS_SCORE) AS CVSS_SCORE
    		FROM NVD_DATA_SCORE_V3 
    		WHERE VERSION = '-' 
    		AND ( VENDORPRODUCT = #{ossName}
			<if test="ossNicknames != null">
				<foreach item="item" collection="ossNicknames">
					OR VENDORPRODUCT = #{item}
				</foreach>
			</if>
			)
			GROUP BY PRODUCT
		) T1
		INNER JOIN NVD_DATA_SCORE_V3 T2 ON T1.PRODUCT = T2.PRODUCT AND T1.CVSS_SCORE = T2.CVSS_SCORE
    	ORDER BY CVE_ID
    	LIMIT 1
    </select>
    
    <select id="selectVulnerabilityExportList" parameterType="oss.fosslight.domain.Vulnerability" resultType="oss.fosslight.domain.Vulnerability">
		SELECT A.*, CVE.VULN_SUMMARY, CVE.PUBL_DATE, CVE.MODI_DATE
		FROM
		(
			SELECT SCORE.PRODUCT, SCORE.VERSION, GROUP_CONCAT(SCORE.VENDOR, ',') AS VENDOR, SCORE.CVE_ID, MAX(SCORE.CVSS_SCORE) AS CVSS_SCORE, GROUP_CONCAT(SCORE.OSS_NICKNAME, ',') AS OSS_NICKNAME
			FROM 
			(
				SELECT CASE WHEN NVD.OSS_NICKNAME IS NOT NULL 
				THEN (SELECT DISTINCT OSS_NAME FROM OSS_COMMON WHERE OSS_COMMON_ID = (SELECT OSS_COMMON_ID FROM OSS_NICKNAME WHERE OSS_NICKNAME = NVD.OSS_NICKNAME))
				ELSE REPLACE(NVD.PRODUCT, ' ', '_') END PRODUCT
		  			 , NVD.VERSION
		  			 , NVD.OSS_NICKNAME
		  			 , NVD.VENDOR
		  			 , NVD.CVE_ID
		  			 , NVD.CVSS_SCORE
				FROM (
					SELECT TBL.*
		  			FROM (
		  				SELECT SCORE.PRODUCT
		  			 		, SCORE.VERSION
		  			 		, SCORE.CVE_ID
		  			 		, SCORE.CVSS_SCORE
		  			 		, SCORE.VENDOR
		  			 		, (SELECT OSS_NICKNAME FROM OSS_NICKNAME WHERE OSS_NICKNAME = SCORE.PRODUCT) AS OSS_NICKNAME
		  				FROM NVD_DATA_SCORE_V3 SCORE
		  				WHERE 1=1
		  				<if test="!@oss.fosslight.util.StringUtil@isEmpty(searchProduct)">
		  					AND MATCH(SCORE.PRODUCT) AGAINST (#{searchProduct})
		  					<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNameAllSearchFlag) and @oss.fosslight.util.StringUtil@equalsIgnoreCase(ossNameAllSearchFlag, 'Y')">
		  						HAVING
		  						<foreach item="item" collection="ossNicknames" open="(" close=")" separator="OR">
		  							SCORE.PRODUCT = #{item} 
		  						</foreach>
		  					</if>
		  				</if>
		  				<if test="!@oss.fosslight.util.StringUtil@isEmpty(cveId)">
		 	   				AND EXISTS (
		 	   					SELECT 1 FROM NVD_DATA_V3 NVD_DATA 
		 	   					WHERE NVD_DATA.CVE_ID = #{cveId} 
		 	   					AND SCORE.PRODUCT = NVD_DATA.PRODUCT 
		 	   					AND SCORE.VERSION = NVD_DATA.VERSION
		 	   				)
						</if>
						<if test="!@oss.fosslight.util.StringUtil@isEmpty(version)">
			   				AND SCORE.VERSION LIKE CONCAT (#{version},'%')
						</if>
						<if test="!@oss.fosslight.util.StringUtil@isEmpty(vendor)">
			   				AND SCORE.VENDOR LIKE CONCAT (#{vendor},'%')
						</if>
						AND EXISTS (SELECT 1 FROM NVD_DATA_V3 WHERE PRODUCT = SCORE.PRODUCT)
					) TBL
				) NVD
			) SCORE
			GROUP BY SCORE.PRODUCT, SCORE.VERSION, SCORE.CVE_ID
		) A
		LEFT JOIN NVD_CVE_V3 CVE
		ON A.CVE_ID = CVE.CVE_ID
		AND A.CVSS_SCORE = CVE.CVSS_SCORE
		WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if>
		<include refid="orderby"/>
		<include refid="limitPage"/>
	</select>
    
    <select id="getCveInfo" resultType="HashMap">SELECT * FROM NVD_CVE_V3 WHERE CVE_ID = #{cveId}</select>

	<select id="getPatchLinkForNvdData" parameterType="string" resultType="string">
		SELECT PATCH_LINK AS patchLink
		FROM NVD_DATA_PATCH_LINK
		WHERE CVE_ID = #{cveId}
	</select>
	
	<select id="getSecurityVulnListByOssName" parameterType="oss.fosslight.domain.OssMaster" resultType="oss.fosslight.domain.Vulnerability">
		SELECT CVE.CVSS_SCORE, CVE.CVE_ID, DATE_FORMAT(CVE.PUBL_DATE, '%Y-%m-%d') AS PUBL_DATE
		FROM NVD_CVE_V3 CVE
		WHERE CVE.CVE_ID IN (SELECT CVE_ID FROM NVD_DATA_V3 NVD
							WHERE (PRODUCT = #{ossName}
				  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
					  			    <foreach item="item" index="index" collection="ossNicknames">
										OR PRODUCT = #{item}
									</foreach>
								</if>
								<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknameArr)">
					  			    <foreach item="item" index="index" collection="ossNicknameArr">
										OR VENDORPRODUCT = #{item}
									</foreach>
								</if>
									)
						<if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
				 		   	AND VERSION = #{ossVersion}
				 		</if>)
		AND CVE.CVSS_SCORE <![CDATA[>=]]> #{securityStandardScore}
	</select>
	
	<select id="getCpeInfoAndRange" parameterType="string" resultType="oss.fosslight.domain.CamelMap">
		SELECT MATCH_CRITERIA_ID, CRITERIA, VER_START_INC, VER_END_INC, VER_START_EXC, VER_END_EXC
		FROM NVD_DATA_CONFIGURATIONS
		WHERE CVE_ID = #{cveId}
		AND PRODUCT = #{ossName}
		
		UNION
		
		SELECT MATCH_CRITERIA_ID, CRITERIA, VER_START_INC, VER_END_INC, VER_START_EXC, VER_END_EXC
		FROM NVD_DATA_CONFIGURATIONS
		WHERE CVE_ID = #{cveId}
		AND PRODUCT = REPLACE(#{ossName}, ' ', '_')
		
		UNION
		
		SELECT CONF.MATCH_CRITERIA_ID, CONF.CRITERIA, CONF.VER_START_INC, CONF.VER_END_INC, CONF.VER_START_EXC, CONF.VER_END_EXC
		FROM NVD_DATA_CONFIGURATIONS CONF
		WHERE CVE_ID = #{cveId}
		AND EXISTS (
			SELECT 1
			FROM OSS_NICKNAME NICK
			INNER JOIN OSS_COMMON OC
			ON NICK.OSS_COMMON_ID = OC.OSS_COMMON_ID
			WHERE OC.OSS_NAME = #{ossName}
			AND CONF.PRODUCT = REPLACE(NICK.OSS_NICKNAME, ' ', '_')
		)
		
		UNION
		
		SELECT MATCH_CRITERIA_ID, CRITERIA, VER_START_INC, VER_END_INC, VER_START_EXC, VER_END_EXC
		FROM NVD_DATA_CONFIGURATIONS
		WHERE CVE_ID = #{cveId}
		AND EXISTS (
				SELECT 1
				FROM NVD_DATA_CONFIGURATIONS CONF
				WHERE CONF.CVE_ID = #{cveId}
				AND MATCH(CONF.CRITERIA) AGAINST (
					(
						SELECT GROUP_CONCAT(TBL.CRITERIA SEPARATOR ' ') AS URI
						FROM (
							SELECT CASE 
									WHEN (LENGTH(CPE.CPE23URI) - LENGTH(REPLACE(CPE.CPE23URI, ':', ''))) = 12 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(CPE.CPE23URI, ':', 5), ':', -2)
									WHEN (LENGTH(CPE.CPE23URI) - LENGTH(REPLACE(CPE.CPE23URI, ':', ''))) <![CDATA[<]]> 12 THEN CPE.CPE23URI ELSE CPE.CPE23URI END CRITERIA
							FROM OSS_INCLUDE_CPE CPE
							WHERE CPE.OSS_COMMON_ID = (SELECT OSS_COMMON_ID FROM OSS_COMMON WHERE OSS_NAME = #{ossName})
						) TBL
					)
				)
			)
	</select>
	
	<select id="getCpeMatchForCpeInfoCnt" parameterType="HashMap" resultType="int">
		SELECT COUNT(*)
		FROM NVD_CPE_MATCH
		WHERE MATCH_CRITERIA_ID = #{matchCriteriaId}
		AND CPE23URI = #{criteria}
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(verStartInc)">
			AND VER_START_INC = #{verStartInc}
		</if>
		<if test="@oss.fosslight.util.StringUtil@isEmpty(verStartInc)">
			AND IFNULL(VER_START_INC, '') = ''
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(verEndInc)">
			AND VER_END_INC = #{verEndInc}
		</if>
		<if test="@oss.fosslight.util.StringUtil@isEmpty(verEndInc)">
			AND IFNULL(VER_END_INC, '') = ''
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(verStartExc)">
			AND VER_START_EXC = #{verStartExc}
		</if>
		<if test="@oss.fosslight.util.StringUtil@isEmpty(verStartExc)">
			AND IFNULL(VER_START_EXC, '') = ''
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(verEndExc)">
			AND VER_END_EXC = #{verEndExc}
		</if>
		<if test="@oss.fosslight.util.StringUtil@isEmpty(verEndExc)">
			AND IFNULL(VER_END_EXC, '') = ''
		</if>
	</select>
	
	<select id="checkDiscoveredSndMailCnt" parameterType="oss.fosslight.domain.OssMaster" resultType="int">
		SELECT COUNT(*)
		FROM OSS_DISCOVERED_SND_EMAIL
		WHERE OSS_ID = #{ossId}
		  AND SND_YN = 'N'
	</select>
	
	<insert id="insertOssDiscoveredSndEmail" parameterType="hashMap">
    	INSERT INTO OSS_DISCOVERED_SND_EMAIL (
    		OSS_ID
    		, PRODUCT
    		, VERSION
    		, CVE_ID
    		, CVSS_SCORE
    	) VALUES (
    		#{OSS_ID}
    		, #{PRODUCT}
    		, #{VERSION}
    		, #{CVE_ID}
    		, #{CVSS_SCORE}
    	) ON DUPLICATE KEY UPDATE
			CVSS_SCORE		= #{CVSS_SCORE}
    </insert>
    
    <update id="updateOssDiscoveredSndEmail" parameterType="string">
		UPDATE OSS_DISCOVERED_SND_EMAIL SET SND_YN = 'Y', SND_DATE = now() WHERE SND_YN = 'N'
	</update>
	
	<select id="selectDiscoveredSndMailList" parameterType="oss.fosslight.domain.OssMaster" resultType="hashMap">
		SELECT * FROM OSS_DISCOVERED_SND_EMAIL 
		WHERE OSS_ID = #{ossId}
		<if test="@oss.fosslight.util.StringUtil@equals('Y', sndMailCheckFlag)">
			AND SND_YN = 'Y'
		</if>
		<if test="@oss.fosslight.util.StringUtil@equals('N', sndMailCheckFlag)">
			AND SND_YN = 'N'
		</if>
	</select>
	
	<select id="selectNotFixedCveInfo" parameterType="oss.fosslight.domain.OssMaster" resultType="oss.fosslight.domain.Vulnerability">
		SELECT CVE.CVE_ID, CVE.CVSS_SCORE, VULN_SUMMARY
		FROM (
			SELECT NVD.CVE_ID
			FROM NVD_DATA_V3 NVD
			WHERE 1=1
			AND (PRODUCT = #{ossName}
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
			<foreach item="item" index="index" collection="ossNicknames">
				OR PRODUCT = #{item}
			</foreach>
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknameArr)">
		    <foreach item="item" index="index" collection="ossNicknameArr">
				OR VENDORPRODUCT = #{item}
			</foreach>
		</if>
		<if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
			AND VERSION = #{ossVersion}
		</if>
			AND NVD.CVE_ID NOT IN (SELECT CVE_ID FROM NVD_DATA_SECURITY
								WHERE REFERENCE_ID = #{prjId}
								AND OSS_NAME = #{ossName}
							<if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
								AND OSS_VERSION = #{ossVersion}
							</if>
							<if test="@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
								AND OSS_VERSION = ''
							</if>
								AND VULNERABILITY_RESOLUTION = 'Fixed')
			)
		) NVD
		INNER JOIN NVD_CVE_V3 CVE
		ON NVD.CVE_ID = CVE.CVE_ID
		ORDER BY CVE.CVSS_SCORE*1 DESC
		LIMIT 1
	</select>
	
	<select id="selectOssVulnerabilityListByVersionAlias" parameterType="oss.fosslight.domain.OssMaster" resultType="oss.fosslight.domain.Vulnerability">
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			SELECT A.*
			FROM
			(
				SELECT TBL.PRODUCT, TBL.VERSION, TBL.VENDOR, TBL.CVE_ID, TBL.CVSS_SCORE, TBL.MODI_DATE, SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 5), ':', -2) AS CRITERIA, TBL.VULN_SUMMARY
				<if test="!@oss.fosslight.util.StringUtil@isEmpty(vulnerabilityCheckFlag) and !@oss.fosslight.util.StringUtil@equals('N', vulnerabilityCheckFlag)">
					 , (SELECT VULNERABILITY_RESOLUTION 
					    FROM NVD_DATA_SECURITY 
					 	WHERE CVE_ID = TBL.CVE_ID 
					 	AND REFERENCE_ID = #{prjId}
					 	AND (
					 		OSS_NAME = #{ossName} or OSS_NAME = REPLACE(#{ossName}, '_', ' ')
					 	<if test="ossNicknames != null">
							<foreach item="item" collection="ossNicknames">
								OR PRODUCT = #{item}
							</foreach>
						</if>
						<if test="ossNicknames != null">
							<foreach item="item" collection="ossNicknames">
								OR PRODUCT = REPLACE(#{item}, ' ', '_')
							</foreach>
						</if>
					 	)
					 <if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
					 	AND OSS_VERSION = #{ossVersion}
					 </if>
					 <if test="@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
					 	AND OSS_VERSION = ''
					 </if>
					 	) AS VULNERABILITY_RESOLUTION
					 </if>
			    FROM
			    (
			    	SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE, IFNULL(MAT.CPE23URI, NVD.CRITERIA) AS CRITERIA, CVE.VULN_SUMMARY
					FROM (
						SELECT MATCH_CRITERIA_ID, CVE_ID, VENDOR, PRODUCT, VERSION, CRITERIA
						FROM NVD_DATA_CONFIGURATIONS
						WHERE (
							PRODUCT = #{ossName} OR PRODUCT = REPLACE(#{ossName}, ' ', '_')
							<if test="ossNicknames != null">
								<foreach item="item" collection="ossNicknames">
									OR PRODUCT = #{item}
								</foreach>
							</if>
							<if test="ossNicknames != null">
								<foreach item="item" collection="ossNicknames">
									OR PRODUCT = REPLACE(#{item}, ' ', '_')
								</foreach>
							</if>
						)
					) NVD
					INNER JOIN NVD_CVE_V3 CVE
					ON NVD.CVE_ID = CVE.CVE_ID
					LEFT JOIN NVD_CPE_MATCH_NAMES MAT
					ON NVD.MATCH_CRITERIA_ID = MAT.MATCH_CRITERIA_ID
				) TBL
				WHERE 1=1
				<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and !@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
				AND (
					<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 6), ':', -1) = #{item}
					</foreach>
					OR
					<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 7), ':', -2) = #{item}
					</foreach>
					)
				</if>
				<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and @oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
				AND
					<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 6), ':', -1) = #{item}
					</foreach>
				</if>
				<if test="@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and !@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
				AND
					<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 7), ':', -2) = #{item}
					</foreach>
				</if>
				GROUP BY TBL.CVSS_SCORE, TBL.CVE_ID, TBL.CRITERIA
				ORDER BY TBL.CVSS_SCORE DESC
			) A
			WHERE 1 = 1
			<include refid="filters"/>
		</if>
		<if test="@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			SELECT TBL.PRODUCT, TBL.VERSION, TBL.VENDOR, TBL.CVE_ID, TBL.CVSS_SCORE, TBL.MODI_DATE, SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 5), ':', -2) AS CRITERIA, TBL.VULN_SUMMARY
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(vulnerabilityCheckFlag) and !@oss.fosslight.util.StringUtil@equals('N', vulnerabilityCheckFlag)">
				, (SELECT VULNERABILITY_RESOLUTION FROM NVD_DATA_SECURITY 
				 	WHERE CVE_ID = TBL.CVE_ID 
				 	AND REFERENCE_ID = #{prjId}
				 	AND (
				 		OSS_NAME = #{ossName} or OSS_NAME = REPLACE(#{ossName}, '_', ' ')
				 		<if test="ossNicknames != null">
							<foreach item="item" collection="ossNicknames">
								OR PRODUCT = #{item}
							</foreach>
						</if>
						<if test="ossNicknames != null">
							<foreach item="item" collection="ossNicknames">
								OR PRODUCT = REPLACE(#{item}, ' ', '_')
							</foreach>
						</if>
				 	)
				 <if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
				 	AND OSS_VERSION = #{ossVersion}
				 </if>
				 <if test="@oss.fosslight.util.StringUtil@equals('-', ossVersion)">
				 	AND OSS_VERSION = ''
				 </if>
				 	) AS VULNERABILITY_RESOLUTION
			</if>
			    FROM
			    (
			    	SELECT NVD.PRODUCT, NVD.VERSION, NVD.VENDOR, CVE.CVE_ID, CVE.CVSS_SCORE, CVE.MODI_DATE, IFNULL(MAT.CPE23URI, NVD.CRITERIA) AS CRITERIA, CVE.VULN_SUMMARY
					FROM (
						SELECT MATCH_CRITERIA_ID, CVE_ID, VENDOR, PRODUCT, VERSION, CRITERIA
						FROM NVD_DATA_CONFIGURATIONS
						WHERE (
							PRODUCT = #{ossName} OR PRODUCT = REPLACE(#{ossName}, ' ', '_')
							<if test="ossNicknames != null">
								<foreach item="item" collection="ossNicknames">
									OR PRODUCT = #{item}
								</foreach>
							</if>
							<if test="ossNicknames != null">
								<foreach item="item" collection="ossNicknames">
									OR PRODUCT = REPLACE(#{item}, ' ', '_')
								</foreach>
							</if>
						)
					) NVD
					INNER JOIN NVD_CVE_V3 CVE
					ON NVD.CVE_ID = CVE.CVE_ID
					LEFT JOIN NVD_CPE_MATCH_NAMES MAT
					ON NVD.MATCH_CRITERIA_ID = MAT.MATCH_CRITERIA_ID
				) TBL
				WHERE 1=1
				<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and !@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
				AND (
					<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 6), ':', -1) = #{item}
					</foreach>
					OR
					<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 7), ':', -2) = #{item}
					</foreach>
					)
				</if>
				<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and @oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
				AND
					<foreach item="item" index="index" collection="ossVersionAliases" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 6), ':', -1) = #{item}
					</foreach>
				</if>
				<if test="@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliases) and !@oss.fosslight.util.StringUtil@isEmpty(ossVersionAliasWithColon)">
				AND
					<foreach item="item" index="index" collection="ossVersionAliasWithColon" open="(" close=")" separator="OR">
						SUBSTRING_INDEX(SUBSTRING_INDEX(TBL.CRITERIA, ':', 7), ':', -2) = #{item}
					</foreach>
				</if>
				GROUP BY TBL.CVSS_SCORE, TBL.CVE_ID, TBL.CRITERIA
				ORDER BY TBL.CVSS_SCORE DESC
		</if>
	</select>
	
	<select id="getOssIncludeCpeAll" resultType="string">
		SELECT DISTINCT OSS_COMMON_ID FROM OSS_INCLUDE_CPE
	</select>
	
	<insert id="insertOSSNvdInfoSyncResult" parameterType="HashMap">
    	INSERT INTO NVD_META (FILE_NM, FILE_TYPE, USE_YN, JOB_STATUS) VALUES (#{fileNm}, #{fileType}, 'Y', #{jobStatus})
    </insert>
    
    <update id="updateOSSNvdInfoSyncResult" parameterType="HashMap">
    	UPDATE NVD_META SET JOB_STATUS = #{jobStatus}, ZIP_SIZE = #{zipSize}, GZ_SIZE = #{gzSize}, MODI_DATE = DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') 
    	WHERE FILE_TYPE = #{fileType} AND JOB_STATUS = 'W' AND DATE_FORMAT(REG_DATE, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
    </update>
    
    <select id="selectOssNvdInfoSyncResult" resultType="HashMap">
    	SELECT ZIP_SIZE	AS zipSize, GZ_SIZE	AS gzSize, JOB_STATUS AS jobStatus
		FROM NVD_META
		WHERE FILE_TYPE = 'NVD_SYNC'
		AND DATE_FORMAT(REG_DATE, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
		ORDER BY REG_DATE DESC
    </select>

	<select id="selectVulnerabilityPrjOssInfo" parameterType="string" resultType="HashMap">
		SELECT
			RTN.OSS_ID, RTN.OSS_NAME,RTN.OSS_VERSION, RTN.CVSS_SCORE, RTN.CVE_ID, RTN.VULN_SUMMARY, RTN.MODI_DATE, RTN.PUBL_DATE
		FROM
			(
				SELECT
					T2.OSS_ID, T2.OSS_NAME, T2.OSS_VERSION, T4.CVSS_SCORE, T4.CVE_ID, T5.VULN_SUMMARY, DATE_FORMAT(T5.MODI_DATE, '%Y-%m-%d') AS MODI_DATE, DATE_FORMAT(T5.PUBL_DATE, '%Y-%m-%d') AS PUBL_DATE
				FROM
					PROJECT_MASTER T1
						INNER JOIN OSS_COMPONENTS T2 ON T1.PRJ_ID = T2.REFERENCE_ID
						AND T2.REFERENCE_DIV = (
							SELECT
								CASE WHEN NOTICE_TYPE = '80' THEN '17' ELSE '13' END REFERENCE_DIV
							FROM
								OSS_NOTICE
							WHERE
								PRJ_ID = #{prjId}
						)
						AND T2.EXCLUDE_YN != 'Y'
      INNER JOIN OSS_MASTER T3 ON IFNULL(T2.REF_OSS_NAME, T2.OSS_NAME) = T3.OSS_NAME
					AND IFNULL(T2.OSS_VERSION, '') = IFNULL(T3.OSS_VERSION, '')
					AND T3.USE_YN = 'Y'
					INNER JOIN OSS_DISCOVERED_SND_EMAIL T4 ON T3.OSS_ID = T4.OSS_ID
					AND T4.SND_YN != 'Y'
					LEFT JOIN NVD_CVE_V3 T5 ON T4.CVE_ID = T5.CVE_ID
				WHERE
					T1.PRJ_ID = #{prjId}
			) RTN
		GROUP BY
			RTN.OSS_ID, RTN.CVE_ID
		ORDER BY
			RTN.OSS_NAME, RTN.CVSS_SCORE DESC, RTN.MODI_DATE DESC
	</select>

	<select id="getVersionsForProduct" parameterType="string" resultType="string">
		SELECT DISTINCT VERSION FROM NVD_DATA_V3 WHERE PRODUCT = #{product}
	</select>
	
	<select id="getVulnerabilityTotalCount" parameterType="oss.fosslight.domain.Vulnerability" resultType="int">
		SELECT COUNT(DISTINCT A.PRODUCT, A.VERSION) AS CNT
		FROM NVD_DATA_V3 A
		<if test="searchProductParam != null and searchProductParam.size() > 0">
			JOIN SEARCH_TEMPORARY ST
			ON A.PRODUCT = ST.PRODUCT
			AND A.VERSION = ST.VERSION
		</if>
		WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(cveId)">
		 	AND A.CVE_ID = #{cveId}
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(version)">
			AND A.VERSION LIKE CONCAT (#{version},'%')
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(vendor)">
			AND A.VENDOR LIKE CONCAT (#{vendor},'%')
		</if>
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if>
	</select>
	
	<select id="getVulnerabilityList" parameterType="oss.fosslight.domain.Vulnerability" resultType="oss.fosslight.domain.Vulnerability">
		SELECT A.*
		FROM
		(
			SELECT NVD.PRODUCT, NVD.VERSION, GROUP_CONCAT(DISTINCT NVD.VENDOR) AS VENDOR, GROUP_CONCAT(NVD.CVE_ID) AS CVE_ID
			FROM NVD_DATA_V3 NVD
			<if test="searchProductParam != null and searchProductParam.size() > 0">
				JOIN SEARCH_TEMPORARY ST
				ON NVD.PRODUCT = ST.PRODUCT
				AND NVD.VERSION = ST.VERSION
			</if>
			WHERE 1=1
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(cveId)">
				AND NVD.CVE_ID = #{cveId}
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(version)">
				AND NVD.VERSION LIKE CONCAT (#{version},'%')
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(vendor)">
				AND NVD.VENDOR LIKE CONCAT (#{vendor},'%')
			</if>
			GROUP BY NVD.PRODUCT, NVD.VERSION
		) A
		WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if>
		<include refid="orderby"/>
	</select>
	
	<select id="getVulnerabilityCvssScoreList" parameterType="oss.fosslight.domain.Vulnerability" resultType="oss.fosslight.domain.Vulnerability">
		SELECT CVE_ID, CVSS_SCORE
	    FROM NVD_CVE_V3
	    WHERE CVE_ID IN (
	    	SELECT DISTINCT NVD.CVE_ID
			FROM NVD_DATA_V3 NVD
			<if test="searchProductParam != null and searchProductParam.size() > 0">
				JOIN SEARCH_TEMPORARY ST
				ON NVD.PRODUCT = ST.PRODUCT
				AND NVD.VERSION = ST.VERSION
			</if>
			WHERE 1=1
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(cveId)">
				AND NVD.CVE_ID = #{cveId}
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(version)">
				AND NVD.VERSION LIKE CONCAT (#{version},'%')
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(vendor)">
				AND NVD.VENDOR LIKE CONCAT (#{vendor},'%')
			</if>
		)
	</select>
	
	<select id="getVulnerabilityExportList" parameterType="oss.fosslight.domain.Vulnerability" resultType="oss.fosslight.domain.Vulnerability">
		SELECT A.*, CVE.VULN_SUMMARY, CVE.PUBL_DATE, CVE.MODI_DATE
		FROM
		(
			SELECT NVD.PRODUCT, NVD.VERSION, GROUP_CONCAT(DISTINCT NVD.VENDOR) AS VENDOR, GROUP_CONCAT(NVD.CVE_ID) AS CVE_ID
			FROM NVD_DATA_V3 NVD
			<if test="searchProductParam != null and searchProductParam.size() > 0">
				JOIN SEARCH_TEMPORARY ST
				ON NVD.PRODUCT = ST.PRODUCT
				AND NVD.VERSION = ST.VERSION
			</if>
			WHERE 1=1
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(cveId)">
				AND NVD.CVE_ID = #{cveId}
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(version)">
				AND NVD.VERSION LIKE CONCAT (#{version},'%')
			</if>
			<if test="!@oss.fosslight.util.StringUtil@isEmpty(vendor)">
				AND NVD.VENDOR LIKE CONCAT (#{vendor},'%')
			</if>
			GROUP BY NVD.PRODUCT, NVD.VERSION
		) A
		WHERE 1=1
		LEFT JOIN NVD_CVE_V3 CVE
		ON A.CVE_ID = CVE.CVE_ID
		AND A.CVSS_SCORE = CVE.CVSS_SCORE
		WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			<include refid="filters"/>
		</if>
		<include refid="orderby"/>
	</select>
	
	<insert id="insertSearchParamTemporary" parameterType="oss.fosslight.domain.Vulnerability">
		INSERT INTO SEARCH_TEMPORARY (PRODUCT, VERSION)
    	VALUES
	    <foreach collection="searchProductParam" item="item" separator=",">
	        (#{item.product}, #{item.version})
	    </foreach>
	</insert>
	
	<delete id="deleteSearchParamTemporary">
		DELETE FROM SEARCH_TEMPORARY
	</delete>
</mapper>