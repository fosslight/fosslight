<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="oss.fosslight.repository.ApiVulnerabilityMapper">

	<select id="selectNvdList" parameterType="hashMap" resultType="oss.fosslight.domain.CamelMap">
		SELECT CVE.CVE_ID
			 , CVE.CVSS_SCORE
			 , <![CDATA[CONCAT('https://nvd.nist.gov/vuln/detail/', CVE.CVE_ID)]]> AS CVE_ID_LINK
		     , CVE.VULN_SUMMARY AS Description
		  FROM (
		  		SELECT PRODUCT
		 			 , VERSION
		 			 , CVE_ID
		  		  FROM NVD_DATA_V3
		  		 WHERE true
				 <if test="@oss.fosslight.util.StringUtil@notEquals(null, ossName)">
		  		 	AND (
		  		 		PRODUCT = #{ossName}
		  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(underbarOssName)">
		  		 			OR PRODUCT = #{underbarOssName}
		  		 		</if>
		  		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(ossNicknames)">
			  			    <foreach item="item" index="index" collection="ossNicknames">
								OR PRODUCT = #{item}
							</foreach>
						</if>
		 				)
				 </if>
		 		 <if test="@oss.fosslight.util.StringUtil@notEquals('-', ossVersion)">
		 		   AND VERSION = #{ossVersion}
		 		 </if>
				 <if test="@oss.fosslight.util.StringUtil@notEquals(null, cveId)">
				   AND CVE_ID = #{cveId}
				 </if>
		 	   ) DATA
		 INNER JOIN NVD_CVE_V3 CVE
		    ON DATA.CVE_ID = CVE.CVE_ID
		 ORDER BY CVE.CVE_ID DESC
	</select>

	<select id="selectMaxScoreNvdInfo" parameterType="hashMap" resultType="oss.fosslight.domain.CamelMap">
		SELECT CVSS_SCORE
			 , <![CDATA[CONCAT(#{host}, '/vulnerability/vulnpopup?ossName=', PRODUCT, '&ossVersion=', VERSION, '&vulnType=v&isPopup=Y')]]> AS VULNERABILITY_LINK
		  FROM NVD_DATA_SCORE_V3
		 WHERE (
		 		PRODUCT = #{ossName}
		 		<if test="!@oss.fosslight.util.StringUtil@isEmpty(underbarOssName)">
		  			OR PRODUCT = #{underbarOssName}
		 		</if>
		 		)
		   AND VERSION = #{ossVersion}
	</select>

</mapper>
