<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="oss.fosslight.repository.VulnerabilityHistoryMapper">

	<sql id="limitPage">
		LIMIT #{startIndex}, #{pageListSize}
	</sql>
	<!--TODO : Why don't you change camel case to snake case like other files about sidx-->
    <sql id="orderby">
		<choose>
			<when test="@oss.fosslight.util.StringUtil@equals('regDt', sidx)">
				ORDER BY REG_DT
			</when>
			<when test="@oss.fosslight.util.StringUtil@equals('ossId', sidx)">
				ORDER BY OSS_ID
			</when>
			<when test="@oss.fosslight.util.StringUtil@equals('ossName', sidx)">
				ORDER BY OSS_NAME
			</when>
			<when test="@oss.fosslight.util.StringUtil@equals('ossVersion', sidx)">
				ORDER BY OSS_VERSION
			</when>
			<when test="@oss.fosslight.util.StringUtil@equals('cveId', sidx)">
				ORDER BY CVE_ID
			</when>
			<when test="@oss.fosslight.util.StringUtil@equals('cvssScore', sidx)">
				ORDER BY CVSS_SCORE
			</when>
			<when test="@oss.fosslight.util.StringUtil@equals('cveIdTo', sidx)">
				ORDER BY CVE_ID_TO
			</when>
			<when test="@oss.fosslight.util.StringUtil@equals('cvssScoreTo', sidx)">
				ORDER BY CVSS_SCORE_TO
			</when>
		</choose>
		<choose>
			<when test="@oss.fosslight.util.StringUtil@equals('asc', sord)">
				ASC
			</when>
			<when test="@oss.fosslight.util.StringUtil@equals('desc', sord)">
				DESC
			</when>
		</choose>
    </sql>
    
    <select id="selectVulnerabilityHistoryTotalCount" parameterType="oss.fosslight.domain.VulnerabilityHistory" resultType="int">
    SELECT
    	COUNT(1)
    FROM
    	NVD_OSS_HIS
    WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			${filterCondition}
		</if>
    </select>
	<select id="selectVulnerabilityHistoryList" parameterType="oss.fosslight.domain.VulnerabilityHistory" resultType="oss.fosslight.domain.VulnerabilityHistory">
		SELECT
			OSS_ID
			, OSS_NAME
			, OSS_VERSION
			, CVE_ID
			, CVSS_SCORE
			, CVE_ID_TO
			, CVSS_SCORE_TO
			, DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i') AS REG_DT 
		FROM NVD_OSS_HIS
		WHERE 1=1
		<if test="!@oss.fosslight.util.StringUtil@isEmpty(filterCondition)">
			${filterCondition}
		</if>
		<include refid="orderby"/>
		<include refid="limitPage"/>
	</select>
    
</mapper>
