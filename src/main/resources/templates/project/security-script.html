<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="contentScript">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script th:inline="javascript">
var lastsel;
var totalMainData = [];
var fullDiscoveredMainData = [];
var vulnScore;
var vulnScoreResolution;
var vulnScoreByOssVersion;
var saveFlag = false;
var prevEditSel;
var commentsParam = {referenceId : [[${project.prjId}]], referenceDiv : 'security'};
var totalValidMsgData;
var fullDiscoveredValidMsgData;
var _scrtUploadFile;

$(function () {
	'use strict';
	sec_com_evt.dataInit();
	com_fn.tabInit();
	total.fileUpload();
	
	$("[id^=tabMenu]").on("click", function() {
		var tabId = $(this).attr("id");
		tabId = tabId.replace("tabMenu", "");
		$("[name=gridArea]").hide();
		$("#gridArea"+tabId).show();
		
		if ("Total" == tabId) {
			$('#save').show();
		} else {
			$("#save").hide();
		}
	});
	
	$(document).on('change', ".bulkEditCheck", function() {
		if (this.checked) {
			$("input[name='onlyEditCommentFlag']").val("Y");
		} else {
			$("input[name='onlyEditCommentFlag']").val("N");
		}
	});
});

var sec_data = {
	getJqGrid : function () {
		var url = '/project/securityGrid/'+[[${project.prjId}]]+'/total';
		$.ajax({
			url : url,
			type : 'GET',
			dataType : 'json',
			cache : false,
			contentType : 'application/json',
			success : function(data){
				loading.hide();
				
				sec_data.loadOverviewData(data);
				sec_data.loadJqGridData(data);
			},
			complete : function() {
				fn.displayProjectInfo();
				$("#tabMenuOverview").trigger("click");
			}
		});
	},
	loadOverviewData : function(data) {
		vulnScore = data.overviewData.vulnScore;
		vulnScoreResolution = data.overviewData.vulnScoreResolution;
		vulnScoreByOssVersion = data.overviewData.vulnScoreByOssVersion;
		
		overview.vulnScoreChartOpen(vulnScore);
		overview.vulnResolutionChartOpen(vulnScoreResolution);
		overview.vulnScoreByOssVersionTable(vulnScoreByOssVersion);
	},
	loadJqGridData : function(data) {
		totalMainData = data.totalGridData;
		if (data.totalValidData) {
			totalValidMsgData = data.totalValidData;
		}
		fullDiscoveredMainData = data.fullDiscoveredGridData;
		if (data.fullDiscoveredValidData) {
			fullDiscoveredValidMsgData = data.fullDiscoveredValidData;
		}
		
		// 리로드 대신 그리드 삭제 후 다시 그리기
		$("#totalList").jqGrid('GridUnload');
		total.loadSecurityGrid();
		
		$("#fullDiscoveredList").jqGrid('GridUnload');
		fullDiscovered.loadSecurityGrid();
		
		if (!saveFlag && data.hasOwnProperty('msg')){
//			alertify.alert(data.msg, function(){});
			$("#overviewMsgDiv").html([[#{msg.project.security.check.version}]]);
		}
		
		saveFlag = false;
	}
}

var sec_com_evt = {
	dataInit : function(){
		commentsParam.height = $(window).height() - 120;
		fn_comment.getCommentList(commentsParam);
		$("#tabMenuOverview").trigger("click");
		sec_data.getJqGrid();
	}
}

var sec_com_fn = {
	gridAddFunc : function(targetId) {
		alertify.alert([[#{msg.common.jqgrid.func.no.use}]], function(){});
	},
	gridDelFunc : function(targetId) {
		alertify.alert([[#{msg.common.jqgrid.func.no.use}]], function(){});
	},
	sendEditor : function(type){
		//코멘트 저장
		var editorVal = CKEDITOR.instances.editor.getData();
		
		if(!editorVal || editorVal == "") {
			alertify.alert([[#{msg.project.enter.comment}]], function(){});
			return false;
		}
		
		var param = {referenceId : [[${project.prjId}]], referenceDiv :'10', contents : editorVal, mailSendType : type};
		
		$.ajax({
			url : '/project/sendComment',
			type : 'POST',
			dataType : 'json',
			cache : false,
			data : param,
			success : function(json){
				if(json.isValid == 'false'){
					alertify.error([[#{msg.common.valid2}]], 0);
				} else {
					$('.ajs-close').trigger("click");

					alertify.success([[#{msg.project.sent.comments.success}]]);
					resetEditor(CKEDITOR.instances.editor);
					
					$(".commentBtn").trigger("click");
				}
			},
			error : function(){
				alertify.error([[#{msg.common.valid2}]], 0);
			}
		});
	},
	saveEditor : function(){
		//코멘트 임시저장
		var editorVal = CKEDITOR.instances.editor.getData();
		var register = 'admin';
		var param = {referenceId : [[${project.prjId}]], referenceDiv :'13', contents : editorVal};
		$.ajax({
			url : '/project/saveComment',
			type : 'POST',
			dataType : 'json',
			cache : false,
			data : param,
			success : function(json){
				if(json.isValid == 'false'){
					alertify.error([[#{msg.common.valid2}]], 0);
				} else {
					alertify.success([[#{msg.common.success}]]);
					$(".commentBtn").trigger("click");
				}
			},
			error : function(){
				alertify.error([[#{msg.common.valid2}]], 0);
			}
		});
	},
	customOnCellSelect : function(target, iCol){
		$("#" + target).jqGrid('saveRow', prevEditSel);
		lastsel = -1;
	},
	customOnDblClickRow : function(target, rowid){
		var rowData = $("#" + target).jqGrid('getRowData',rowid);
		if ("Y" == rowData.activateFlag) {
			var gridData = $("#" + target).jqGrid('getGridParam','data').filter(function(a){
		    	if("Y" == a.activateFlag){
					return a;
			    }
	    	});
						
			var msg = [[#{msg.project.security.check.version}]];
			msg += '<br/><br/>';
			for (var i=0; i<gridData.length; i++){
				msg += '- ' + gridData[i].ossName;
				if (i < gridData.length-1){
					msg += '<br/>';
				}
			}
			alertify.alert(msg, function(){});
			$("#" + target).jqGrid("resetSelection");
			return;
		} else {
			if (rowid && rowid !== lastsel){
				$("#" + target).setColProp('vulnerabilityResolution', {editable:true});
				$("#" + target).setColProp('securityComments', {editable:true});
				$("#" + target).jqGrid('editRow',rowid);
				lastsel=rowid;
			}
			
			var _securityComments = $('#'+rowid+'_securityComments').val();
			if (typeof _securityComments !== "undefined") {
				if (_securityComments.indexOf("<input") > -1) $('#'+rowid+'_securityComments').val("");
			}
		}
		
		prevEditSel = rowid;
	},
	setSaveGridData : function(targetStr) {
		var target = $("#"+targetStr);
		var rowDatas = target.jqGrid("getRowData");
		var totalGridData = target.jqGrid('getGridParam','data');
		var rowDatasLength = rowDatas.length;
		var totalGridDataLength = totalGridData.length;
		
		for (var i=0; i<rowDatasLength; i++) {
			for (var j=0; j<totalGridDataLength; j++) {
				if (rowDatas[i].gridId == totalGridData[j].gridId) {
					totalGridData[j].vulnerabilityResolution = rowDatas[i].vulnerabilityResolution;
					var securityComments = rowDatas[i].securityComments;
					if (securityComments.indexOf("<input") > -1) {
						securityComments = $('#'+rowDatas[i].gridId+'_securityComments').val();
					}
					totalGridData[j].securityComments = securityComments;
				}
			}
		}
		
		return totalGridData;
	},
	identificationTab : function(){
		var prjId = $('input[name=prjId]').val();
		var idx = getTabIndex(prjId+"_Identify");
		
		if(idx != ""){
			changeTabInFrame(idx);
		}else{
			createTabInFrame(prjId+'_Identify', '/project/identification/'+prjId+'/5');
		}
	},
	packagingTab : function(){
		var prjId = $('input[name=prjId]').val();
		var idx = getTabIndex(prjId+"_Packaging");
		
		if(idx != ""){
			changeTabInFrame(idx);
		}else{
			createTabInFrame(prjId+'_Packaging', '/project/verification/'+prjId);
		}
	},
	editTab : function(){
		var prjId = $('input[name=prjId]').val();
		var idx = getTabIndex(prjId+"_Project");
		
		if(idx != ""){
			changeTabInFrame(idx);
		}else{
			createTabInFrame(prjId+'_Project', '/project/edit/'+prjId);
		}
	},
	bulkEdit : function(tab){
    	var gridList;
 		var targetGird = "";
      
      	switch(tab){
          	case 'total' : 
              	gridList = $("#totalList"); targetGird = "totalList";
              	break;
          	case 'fixed' : 
              	gridList = $("#fixedList"); targetGird = "fixedList";
              	break;
          	case 'notFixed' : 
              	gridList = $("#notFixedList"); targetGird = "notFixedList";
              	break;
      	}

      	var selarrrow = gridList.jqGrid("getGridParam", "selarrrow");
      	var rowCheckedArr = [];
      	var rowGirdIdArr = [];
      	var versionEmptyFlag = false;
      
      	for(var i=0; i<selarrrow.length; i++){
      		if($("input:checkbox[id='jqg_" + targetGird + "_" + selarrrow[i] + "']").is(":checked")){
      			var rowData = gridList.jqGrid("getRowData", selarrrow[i]);
      			if ("" != rowData["ossVersion"]) {
      				rowCheckedArr.push(selarrrow[i]);
      				rowGirdIdArr.push(rowData["gridId"]);
      			}
			}
 		}
		
      	if (rowCheckedArr.length > 0) {
          	fn_grid_com.totalGridSaveMode(targetGird);
          	
          	$("#secBulkEditForm > input[name=rowId]").val(rowCheckedArr);
      		$("#secBulkEditForm > input[name=gridId]").val(rowGirdIdArr);
			$("#secBulkEditForm > input[name=target]").val(targetGird);
			
			$.ajax({
				url: "/project/secBulkEditPopup",
                type: "POST",
                dataType: 'html',
                cache : false,
                success: function (res) {
                	if(!alertify.secBulkEdit){
						alertify.dialog('secBulkEdit', function() {
							var settings;
							
							return {
								setup: function() {
									var settings = alertify.confirm().settings;
									
									for (var prop in settings) {
										this.settings[prop] = settings[prop];
									}
									
									var setup = alertify.confirm().setup();
									setup.buttons = [];
									setup.focus.element = 1;
									
									return setup;
								},
								hooks: {
							    	onshow: function() {
							        	this.elements.dialog.style.maxWidth = 'none';
							          	this.elements.dialog.style.width = '760px';
							        }
								}
							};
						}, false, 'confirm');
                	}
                	
                	alertify.secBulkEdit(res, function(){}).set('title', 'Bulk Edit Security');
                	$("select[name=vulnerabilityResolution] option:eq(0)").prop("selected", true);
                	$(".bulkEditCheck").prop("checked", false);
                	$("input[name=onlyEditCommentFlag]").val("N");
                },
                error : function(){
                    alertify.error([[#{msg.common.valid2}]], 0);
                }
            });
      	} else {
      		alertify.alert([[#{msg.oss.select.ossTable}]], function(){});
      		return false;
      	}
  	},
  	bulkEditDataInfo : function(obj, flag){
		var editFlag = false;
	   	try{
  			var ossArr = [];
          	var gridId = obj["gridId"];
          	var target = obj["target"];
          	var onlyEditCommentFlag = obj["onlyEditCommentFlag"];
          	var gridParam = $('#'+target).jqGrid('getGridParam','data');
          	var customParam = [];
          	var param = [];
          
          	var limit = $('.ui-pg-selbox option:selected').val();
          	var page = $('.ui-pg-input').val();
          	var start = (parseInt(page) * parseInt(limit)) - parseInt(limit);
          
          	if (parseInt(start) > 0) {
          		for (var i=0; i<start; i++){
          			customParam.push(gridParam[i]);
          		}
          	}
          
          	for (var i=start; i<gridParam.length; i++) {
          		param.push(gridParam[i]);
          	}
          
          	if (gridId.indexOf(",") > -1) {
              	var gridIdArr = gridId.split(",");
              
              	for (var idx in gridIdArr) {
              		for (var i=0; i<param.length; i++) {
                  		if (param[i]["gridId"] == gridIdArr[idx]) {
                          	for (var key in obj) {
                              	if ("rowId" != key && "target" != key && "gridId" != key) {
                              		if ("Y" == onlyEditCommentFlag && "vulnerabilityResolution" != key) {
                          				param[i][key] = obj[key];
                          			} else {
                              			param[i][key] = obj[key];
                          			}
                              	}
                          	}
                      	}
                  	}
              	}
          	} else {
          		for (var i=0; i<param.length; i++) {
                  	if (param[i]["gridId"] == gridId) {
                      	for (var key in obj) {
                      		if ("rowId" != key && "target" != key && "gridId" != key) {
                      			if ("Y" == onlyEditCommentFlag && "vulnerabilityResolution" != key) {
                      				param[i][key] = obj[key];
                      			} else {
                          			param[i][key] = obj[key];
                      			}
                          	}
                      	}
                  	}
              	}
          	}
          
          	var reloadParam = [];
          	if (customParam.length > 0) {
          		for (var i in customParam) {
          			reloadParam.push(customParam[i]);
          		}
          	}
          
          	for (var i in param) {
      			reloadParam.push(param[i]);
      		}
          
          	$("#"+target).jqGrid('setGridParam', {data:reloadParam}).trigger('reloadGrid');
  		} catch(e) {
  			alertify.error([[#{msg.common.valid2}]], 0);
  			editFlag = true;
  		} finally {
  			if(!editFlag){
      			alertify.success([[#{msg.common.success}]]);
          	}
  			
  			setTimeout(function() {
  				adjustMultiPageGridSize();
  			}, 100);
     	}
  	},
  	checkReqEntrySecurity : function (prjId, tabMenu) {
  		var reqEntryFlag = false;
		var data = {
			"prjId" : prjId,
			"tabMenu" : tabMenu
		}
		
		$.ajax({
			type: "POST",
			url: '/project/checkReqEntrySecurity',
			data: JSON.stringify(data),
			dataType : 'json',
			cache : false,
			async : false,
			contentType : 'application/json',
			success: function (data) {
				if("true" == data.isValid) {
					reqEntryFlag = true;
			   }
			},
			error: function(data){
				alertify.error([[#{msg.common.valid2}]], 0);
			}
		});
		
		return reqEntryFlag;
  	},
	displayVulnerabilityLink : function(cellvalue, options, rowObject){
		var url = "";
		if(cellvalue != null && cellvalue !== undefined && "" != cellvalue){
			if (cellvalue.indexOf("vulnpopup?") > -1){
				var ossName = rowObject.ossName;
				var ossVersion = rowObject.ossVersion;
				if ("" == ossVersion){
					ossVersion = "-";
				}
				url = '<a href=\'#\' onclick=\'javascript:sec_com_fn.showVulnViewPage(\"'+encodeURIComponent(ossName)+'\",\"'+encodeURIComponent(ossVersion)+'\")\' class=\'urlLink\'>'+cellvalue+'</a>';
			} else if ("N/A" == cellvalue) {
				url = cellvalue;
			} else {
				var httpVal = cellvalue;
				if( !(
						cellvalue.toLowerCase().startsWith("http://") 
						|| cellvalue.toLowerCase().startsWith("https://") 
						|| cellvalue.toLowerCase().startsWith("ftp://") 
						|| cellvalue.toLowerCase().startsWith("git://") 
					) ) {
					httpVal = "https://" + cellvalue;
				}
				if (httpVal.indexOf(",") > -1){
					httpVal = httpVal.split(",");
					var cnt = httpVal.length;
					for (var i=0; i < httpVal.length; i++){
						var _href = httpVal[i];
						url += "<a href=\""+_href+"\" class=\"urlLink\" target=\"_blank\">"+httpVal[i]+"</a>";
						if (i < httpVal.length-1){
							url += "\n";
						}
					}
				} else {
					url = "<a href=\""+httpVal+"\" class=\"urlLink\" target=\"_blank\">"+cellvalue+"</a>";
				}
			}
		}
		
		return url;
	},
	showVulnViewPage : function(_ossName, _ossVersion){
		var prjId = [[${project.prjId}]];
		var _url = '/vulnerability/vulnpopup?prjId='+prjId+'&ossName='+_ossName+'&ossVersion='+_ossVersion;
		
		if(_popupVuln == null || _popupVuln.closed) {
			_popupVuln = window.open(_url, "vulnViewPopup_"+_ossName, "width=950, height=600, toolbar=no, location=no, left=100, top=100");

			if(!_popupVuln || _popupVuln.closed || typeof _popupVuln.closed=='undefined') {
				alertify.alert([[#{msg.common.window.allowpopup}]], function(){});
			}
		} else {
			_popupVuln.close();
			
			_popupVuln = window.open(_url, "vulnViewPopup_"+_ossName, "width=900, height=600, toolbar=no, location=no, left=100, top=100");
		}
	}
}

var com_fn = {
	tabInit : function(){
		var prjName = [[${project.prjName}]];
		var prjVersion = [[${project.prjVersion}]];
		if ("" != prjVersion) prjName += "(" + prjVersion + ")";
		var createdDate = [[${@CommonFunction.formatDateSimple(project.createdDate)}]];
		var created = [[${project.prjUserName}]]+" "+[[${project.prjDivisionName }]]+' ('+createdDate+')';
		
		var bTag = document.createElement("b");
		bTag.innerText = prjName;
		
		$("#prjName").html(bTag);
		$("#creator").text(created);
		
		$("#tabMenuTotal").trigger("click");
		$("#gridAreaTotal").show();
	},
	exeSave : function(data, target){
		var scrtCsvFileId = $('#scrtCsvFileId').val();
		var scrtCsvFiles = $(".scrtFileArea").find("input[type=hidden]");
		var fileSeq = [];
		
		for (var i = 0; i < scrtCsvFiles.length; i++){
			var obj = {fileSeq : scrtCsvFiles.eq(i).val()};
			fileSeq.push(obj);
		}
		if (fileSeq.length == 0) {
			$("#scrtCsvFileId").val("");
			scrtCsvFileId = "";
		}
		
		var finalData = {
			referenceId : [[${project.prjId}]],
			targetName : target,
			scrtCsvFileId : scrtCsvFileId,
			scrtCsvFiles : JSON.stringify(fileSeq),
			gridData : JSON.stringify(data)
		};
		
		$.ajax({
			url : '/project/saveSecurity',
			type : 'POST',
			data : JSON.stringify(finalData),
			dataType : 'json',
			cache : false,
			contentType : 'application/json',
			success: function(data){
				if ("true" == data.isValid){
					alertify.success([[#{msg.common.success}]]);
					saveFlag = true;
					sec_com_evt.dataInit();
					reloadTabInframe('/project/list');
				} else {
					alertify.error([[#{msg.common.valid2}]], 0);
				}
			}
		});
	},
	checkDownloadExcel : function(target) {
		loading.show();
		
		var prjId = [[${project.prjId}]];
		var tabMenu = target;

        if (sec_com_fn.checkReqEntrySecurity(prjId, tabMenu)) {
			com_fn.downloadExcel(tabMenu);
		} else {
			loading.hide();
			alertify.confirm([[#{msg.project.security.check.export}]], function (e) {
				if (e) {
					com_fn.downloadExcel(tabMenu);
				} else {
					return false;
				}
			});
		}
	},
	downloadExcel : function(target){
		var data = {
			"prjId" : [[${project.prjId}]],
			"code" : target
		}
		
		$.ajax({
			type: "POST",
			url: '/exceldownload/getExcelPost',
			data: JSON.stringify({"type":"security", "parameter":JSON.stringify(data)}),
			dataType : 'json',
			cache : false,
			contentType : 'application/json',
			success: function (data) {
				if("false" == data.isValid) {
					if(data.validMsg == "overflow"){
						alertify.error(getMsgMaxRowCnt(), 0);
					} else {
		               alertify.error([[#{msg.common.valid2}]], 0);
					}
			   } else {
			       window.location = '/exceldownload/getFile?id='+data.validMsg;
			   }
			},
			error: function(data){
				alertify.error([[#{msg.common.valid2}]], 0);
			}
		});
	},
	bulkEditChange : function(){
		$("select[name=vulnerabilityResolution]").removeClass("is-invalid");
		
		alertify.confirm([[#{msg.oss.change.bulkedit}]], function (e) {
			if (e){
				var changeFlag = false;
				var obj = $("#secBulkEditForm").serializeObject();
				var vulnerabilityResolution = $("select[name=vulnerabilityResolution] option:selected").val();
				obj["securityComments"] = $("#securityComments").val();
 				var onlyEditCommentFlag = $("input[name=onlyEditCommentFlag]").val();
 				obj["onlyEditCommentFlag"] = onlyEditCommentFlag;
 				
 				if ("N" == onlyEditCommentFlag) {
 					if ("" == vulnerabilityResolution) {
 						$("select[name=vulnerabilityResolution]").addClass("is-invalid");
 					} else {
 						obj["vulnerabilityResolution"] = vulnerabilityResolution;
 						changeFlag = true;
 					}
 				} else {
 					changeFlag = true;
 				}
 				
 				if (changeFlag) {
 					sec_com_fn.bulkEditDataInfo(obj, "mod");
 					com_fn.bulkEditClose();
 				}
			} else {
				return false;
			}
		});
	},
	bulkEditReset : function(){
		alertify.confirm([[#{msg.project.security.check.reset}]], function (e) {
			if (e){
				var obj = $("#secBulkEditForm").serializeObject();
				obj["vulnerabilityResolution"] = "Unresolved";
				obj["securityComments"] = "";
				sec_com_fn.bulkEditDataInfo(obj, "reset");
				com_fn.bulkEditClose();
			} else {
				return false;
			}
		});
	},
	bulkEditClose : function(){
		$(".ajs-close").trigger("click");
	},
	getSheetData : function(seq, tabNm) {
		var sheetNum = [];
		
		$('input:checkbox[name="sheetNameSelect"]').each(function(){
			if($(this).is(':checked')){
				sheetNum.push($(this).val());
			}
		});
		
		if (sheetNum.length == 0) {
			alert([[#{msg.common.check.sheet}]]);
			
			return;
		} else {
			loading.show();
			fn_grid_com.totalGridSaveMode(tabNm + "List");
			var mainData = sec_com_fn.setSaveGridData(tabNm + "List");
			var finalData = {"readType" : tabNm,"prjId" : [[${project.prjId}]], "sheetNums" : sheetNum , "fileSeq" : ""+seq, "mainData" : JSON.stringify(mainData)};
			var object = {fileSeq : seq};
			
			if ("total" == tabNm) {
				total.scrtCsvFileSeq.push(object);
				total.exeLoadReportData(finalData);
			}
		}
	},
	closeAlertifyView : function () {
		$(".ajs-close").trigger("click");
	},
	makeFileTag : function (obj) {
		$('#scrtCsvFileId').val(obj.registFileId);
		
		var appendHtml = '<br>'+obj.createdDate;
		var _url = '/download/'+obj.registSeq+'/'+obj.fileName;
		var uploadFileTag = '<li><a class="ajax-file-upload-filename" href="'+_url+'">'+obj.originalFilename+'</a><input type="hidden" value="'+obj.registSeq+'"/>';
		uploadFileTag += '<span class="badge bg-danger" style="cursor:pointer;" onclick="com_fn.deleteFiles(this, \'1\')">X</span>'+appendHtml+'</li>';
		$('.scrtFileArea').append(uploadFileTag);
	},
	deleteFiles : function (obj, type) {
		var FileSeq = [];
		var seq = $(obj).prev().val();
		FileSeq.push({fileSeq : seq});
		var Data = {"csvDelFileIds" : JSON.stringify(FileSeq), "prjId" : [[${project.prjId}]], "referenceDiv" : [[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_SECURITY_HIS')}]]};
		
		$.ajax({
			url : "/project/deleteFiles",
			type : 'POST',
			data : JSON.stringify(Data),
			dataType : 'json',
			cache : false,
			contentType : 'application/json',
			success: function(data){
				if ("10" == data.resCd){
					alertify.success([[#{msg.common.success}]]);
					$(obj).closest('li').remove();
				} else {
					alertify.error([[#{msg.common.valid2}]], 0);
				}
			},
			error: function(data){
				alertify.error([[#{msg.common.valid2}]], 0);
			}
		});
	}
}

var vulnScoreChartObject;
var vulnResolutionChartObject;
var dataTable;

var overview = {
	vulnScoreChartOpen : function(data) {
		var obj = new Object();
		var chartData = new Object();
		var labels = new Array();
		var datasets = new Array();
		var dataArr = new Array();
		
		let sortedKeys = Object.keys(data).sort();
		[sortedKeys[2], sortedKeys[3]] = [sortedKeys[3], sortedKeys[2]];
		
		let sortedObj = {};
		sortedKeys.forEach(function(obj){
			sortedObj[obj] = data[obj];
		});
		
		for (let key in sortedObj) {
			labels.push(key);
			dataArr.push(data[key]);
		};
		
		let color = ["#343a40", "#dc3545", "#ffa500", "#ffff00"];		
		datasets.push({label:'Count', data:dataArr, backgroundColor:color});
		obj["labels"] = labels;
		obj["datasets"] = datasets;
		
		if (vulnScoreChartObject) {
			vulnScoreChartObject.data.labels = obj["labels"];
			vulnScoreChartObject.data.datasets = obj["datasets"];
			vulnScoreChartObject.update();
		} else {
			vulnScoreChartObject = getPieChart($('#vulnScoreChart').get(0).getContext('2d'), obj);
		}
	},
	vulnResolutionChartOpen : function(data) {
		var obj = new Object();
		var chartData = new Object();
		var labels = new Array();
		var datasets = new Array();
		var dataArr = new Array();
		
		for (let key in data) {
			labels.push(key);
			dataArr.push(data[key]);
		};
		
		datasets.push({label:'Count', data:dataArr, backgroundColor:Object.values(CHART_COLORS)});
		obj["labels"] = labels;
		obj["datasets"] = datasets;
		
		if (vulnResolutionChartObject) {
			vulnResolutionChartObject.data.labels = obj["labels"];
			vulnResolutionChartObject.data.datasets = obj["datasets"];
			vulnResolutionChartObject.update();
		} else {
			vulnResolutionChartObject = getPieChart($('#vulnResolutionChart').get(0).getContext('2d'), obj);
		}
	},
	vulnScoreByOssVersionTable : function(data) {
		for (let key in data) {
			let tr = document.createElement("tr");
			
			let ossName = key.split("_")[0];
			let ossVersion = key.split("_")[1];
			if ("N/A" == ossVersion) {
				ossVersion = "";
			}
			
			let vulnCount = data[key];
			let vulnHtml = "";
			for (let vulnKey in vulnCount) {
				let vulnStr = vulnKey[0];
				let cnt = vulnCount[vulnKey];
				if ("" == ossVersion && cnt > 0) {
					cnt = 0;
				}
				vulnHtml += "<span style=\"cursor: pointer;\" onclick=\"overview.vulnDetailPopup('" + ossName + "', '" + ossVersion + "', '" + vulnStr + "', '" + cnt + "');\">";
				if ("C" == vulnStr) {
					vulnHtml += '<span class="badge badge-dark p-2">C</span>';
				} else if ("H" == vulnStr) {
					vulnHtml += '<span class="badge badge-danger p-2 ml-4">H</span>';
				} else if ("M" == vulnStr) {
					vulnHtml += '<span class="badge badge-orange p-2 ml-4">M</span>';
				} else {
					vulnHtml += '<span class="badge badge-yellow2 p-2 ml-4">L</span>';
				}
				vulnHtml += "<span class=\"ml-2\">" + cnt + "</span></span>";
			}
			
			let ossNameTd = document.createElement("td");
			ossNameTd.innerHTML = ossName;
			let ossVersionTd = document.createElement("td");
			ossVersionTd.innerHTML = ossVersion;
			let vulnCountTd = document.createElement("td");
			vulnCountTd.classList.add("text-center");
			vulnCountTd.innerHTML = vulnHtml;
			
			tr.appendChild(ossNameTd);
			tr.appendChild(ossVersionTd);
			tr.appendChild(vulnCountTd);
			
			$("#vulnScoreTableBody").append(tr);
		}
	},
	vulnDetailPopup : function (ossName, ossVersion, flag, cnt) {
		if (cnt > 0) {
			var _url = '/vulnerability/vulnpopup?ossName=' + ossName + '&ossVersion=' + ossVersion + '&vulnType=' + '&range=' + flag;
			openNVD2(ossName, _url);
		} else {
			alertify.alert("There are no vulnerabilities at this level.", function(){});
		}
	}
}

var total = {
	scrtCsvFileSeq : [],
	exeLoadReportData : function(finalData) {
		try {
			$.ajax({
				url : '/project/getSecuritySheetData',
				type : 'POST',
				data : JSON.stringify(finalData),
				dataType : 'json',
				cache : false,
				contentType : 'application/json',
				success: function(data){
					loading.hide();
					
					if ("false" == data.isValid) {
						if(data.validMsg) {
							alertify.alert(data.validMsg, function(){});
						} else {
							alertify.error([[#{msg.common.valid}]], 0);
						}
					} else {
						alertify.success([[#{msg.common.success}]]);
						sec_data.loadJqGridData(data);
						com_fn.makeFileTag(_scrtUploadFile);
						_scrtUploadFile = undefined;
					}
				},
				error: function(data){
					loading.hide();
					$('.totalFileArea').children().remove();
					alertify.error([[#{msg.common.valid}]], 0);
				}
			});
		} finally {
			com_fn.closeAlertifyView();
		}
	},
	loadSecurityGrid : function(){
		var totalList = $("#totalList");
		
		var colModelArr = [];
		var colModelObj = {name: 'gridId', index: 'gridId', editable:false, hidden:true, key: true};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'ossId', index: 'ossId', width: 150, align: 'left', hidden:true};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'ossName', index: 'ossName', width: 150, align: 'left', template: searchStringOptions, editable:false};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'ossVersion', index: 'ossVersion', width: 50, align: 'left', template: searchStringOptions, editable:false};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'cveId', index: 'cveId', width: 70, align: 'left', template: searchStringOptions, editable:false};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'cvssScore', index: 'cvssScore', width: 70, align: 'left', template: searchStringOptions, editable:false};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'publDate', index: 'publDate', width: 70, align: 'left', template: searchStringOptions, editable:false};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'vulnerabilityResolution', index:'vulnerabilityResolution', width:110, formatter: 'select', editable:true, edittype:"select", template: searchStringOptions, editoptions:{
						value:{"Unresolved":"Unresolved","Fixed":"Fixed"}
					, dataEvents:[{type:'change',
						fn: function(e){
							$("#totalList").jqGrid('saveRow', lastsel);
							$("#totalList").jqGrid("resetSelection");
							lastsel = -1;
						}
					}]
				}
			};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'vulnerabilityLink', index: 'vulnerabilityLink', width: 120, align: 'left', formatter: sec_com_fn.displayVulnerabilityLink, template: searchStringOptions, editable:false};
		colModelArr.push(colModelObj);
		colModelObj = {name: 'securityComments', index: 'securityComments', width: 50, align: 'left', template: searchStringOptions, editable:true};
		colModelArr.push(colModelObj);
		
		// apply user columns setting on
		var listType = 'SECURITY_NEED';
		var totalColInfos = [
				{'OSS Name' : 'ossName'}, {'OSS Version' : 'ossVersion'}, {'CVE ID' : 'cveId'}, {'CVSS SCORE' : 'cvssScore'}, {'Published Date' : 'publDate'}, {'Vulnerability Resolution' : 'vulnerabilityResolution'},
				{'Vulnerabilty Link' : 'vulnerabilityLink'}, {'Security Comments' : 'securityComments'}
	  	];
		var defaultTotalColNames = ['ossName', 'ossVersion', 'cveId', 'cvssScore', 'publDate', 'vulnerabilityResolution', 'vulnerabilityLink', 'securityComments'];
		var defaultColNames = ['ossName', 'ossVersion', 'cveId', 'cvssScore', 'vulnerabilityResolution'];
		applyUserSettings(colModelArr, colModelObj, totalColInfos, defaultTotalColNames, listType);
		
		totalList.jqGrid({
			datatype: 'local',
			data: totalMainData,
			colNames: ['ID','OSS ID','OSS Name','OSS Version','CVE ID','CVSS SCORE','Published<br/>Date','Vulnerability<br/>Resolution','Vulnerabilty<br/>Link','Security<br/>Comments'],
			colModel: colModelArr,
		   	editurl:'clientArray',
 			autowidth: true,
 			multiselect: true,
 			multiselectWidth: 35,
			pager: '#totalListPager',
			rowNum: 200,
			rowList: [200, 500, 1000, 5000],
			gridview: true,
			sortable: function (permutation) {
			},
			loadonce:true,
			sortorder: 'desc',
			height: 'auto',
			toppager:true,
			onCellSelect: function(rowid,iCol,cellcontent,e) {
				sec_com_fn.customOnCellSelect("totalList", iCol);
			},
			beforeSelectRow: function(rowid, e) {
				if (rowid == prevEditSel) {
					$("#jqg_totalList_" + rowid).prop("checked", true);
				}
				
				var $self = $(this), iCol, cm,
			    $td = $(e.target).closest("tr.jqgrow>td"),
			    $tr = $td.closest("tr.jqgrow"),
			    p = $self.jqGrid("getGridParam");
				
				if ($(e.target).is("input[type=checkbox]") && $td.length > 0) {
			       iCol = $.jgrid.getCellIndex($td[0]);
			       cm = p.colModel[iCol];
			       
			       if (cm != null && cm.name === "cb") {
			           // multiselect checkbox is clicked
			           $self.jqGrid("setSelection", $tr.attr("id"), true ,e);
			       }
				}
				    
				return true;
			},
			onSelectRow: function(rowid, status, e) {
				var ossVersion = totalList.jqGrid("getRowData", rowid)["ossVersion"];
			    if ("" == ossVersion) $("#jqg_totalList_" + rowid).prop("checked", false);
			},
			ondblClickRow: function(rowid,iRow,iCol,e) {
				sec_com_fn.customOnDblClickRow("totalList" ,rowid);
			},
			loadComplete: function(data) {
				lastsel = -1;
				if(data.records > 0) {
					var rowIdx = 0, rows = this.rows, rowsCount = rows.length, row;
					for(var _idx=0;_idx<rowsCount;_idx++) {
						row = rows[_idx];
						$("#"+row.id).find("input[type=checkbox]").removeClass("cbox");
					}
				}
				
				// append button event
				var pageButtonArea = $('#totalList_toppager_left');
				if ($("#totalList_toppager_left").find('button').length == 0) {
	            	var appendBtn = "";
	                
	            	if ([[${@CommonFunction.isAdmin()}]]) {
	            		appendBtn += "<button type=\"button\" class=\"btn btn-sm btn-grid-light-gray float-left ml-1\" onclick=\"sec_com_fn.gridAddFunc('total')\"><i class=\"fas fa-plus gridIconDisabled\"></i></button>";
	            		appendBtn += "<button type=\"button\" class=\"btn btn-sm btn-grid-light-gray float-left ml-1\" onclick=\"sec_com_fn.gridDelFunc('total', 'main')\"><i class=\"far fa-trash-alt gridIconDisabled\"></i></button>";
	                }
	            	appendBtn += "<button type=\"button\" class=\"btn btn-sm btn-grid-light-gray float-left ml-1\" onclick=\"sec_com_fn.bulkEdit('total')\"><i class=\"fas fa-pencil-alt\"></i></button>";
	            	appendBtn += "<button type=\"button\" class=\"btn btn-sm btn-grid-light-gray float-left ml-1\" onclick=\"com_fn.downloadExcel('total')\"><i class=\"fas fa-download\"></i></button>";
	                	                
	                $("#totalList_toppager_left").append(appendBtn);
	            }
				
				var setUpColumnButton = $('#setUpColumnButtonNeed');
				/* columns licalization */
                if (setUpColumnButton.length === 0) {
                    var savedColNames = [];
                    var dropdownMenuOptions = {
                    	_btnId : "Need",
                    	_targetId : "totalList",
                        _listType: listType,
                        _totalColInfos: totalColInfos,
                        _defaultColNames: defaultColNames,
                        _savedColNames: savedColNames
                    };
                    pageButtonArea.append(createUserCoulmnsSettingButton(dropdownMenuOptions));

                    // Check for click events occurring inside the menu area
                    $("#setUpColumnMenuNeed").on("click", function(event) {
                        event.stopPropagation();
                    });

                    $('#setUpColumnButtonNeed').on("click", function(event) {
                        event.stopPropagation();
                        $('#setUpColumnMenuNeed').toggleClass("show");
                        $(this).toggleClass("show");
                    });
                }
			},
			gridComplete : function() {
				if (totalValidMsgData) {
					gridValidMsgNew(totalValidMsgData, "totalList");
				}
				updateGridRowCount('totalList', 'totalListPager');
			}
		});
			
		totalList.jqGrid('filterToolbar',{stringResult: true, searchOnEnter: true, searchOperators: true, defaultSearch: "cn",
			beforeSearch : function () {
				if (!this.p.postData.referenceId) {
					this.p.postData.referenceId = [[${project.prjId}]];
				}
			},
			afterSearch: function () {
				updateGridRowCount('totalList', 'totalListPager'); 
			}	
		});
			
//		totalList.jqGrid('navGrid',"#totalListPager",{add:false,edit:false,del:false,search:false,refresh:false, cloneToTop:true});
	},
	save : function(){
		alertify.confirm([[#{msg.common.confirm.save}]], function (e) {
			if (e) {
				fn_grid_com.totalGridSaveMode('totalList');
				var gridData = sec_com_fn.setSaveGridData('totalList');
				com_fn.exeSave(gridData, "TOTAL");
			} else {
				return false;
			}
		});
	},
	fileUpload : function() {
		var accept1 = '';
		var fileAccept = [[${@CoCodeManager.getCodeDtls(@CommonFunction.getCoConstDefVal("CD_FILE_ACCEPT"))}]];
		for (var i in fileAccept) {
			if ('12' == fileAccept[i].cdDtlNo) {
				accept1 = fileAccept[i].cdDtlExp;
			}
		}
		
		//파일업로드
		$('#scrtCsvFile').uploadFile({
			url:'/project/csvFile',
			multiple:false,
			dragDrop:true,
			fileName:'myfile',
			allowedTypes:accept1,
			sequential:true,
			sequentialCount:1,
			formData:{"registFileId" : $('#scrtCsvFileId').val(), "tabNm" : "SECURITY"},
			onSuccess:function(files,data,xhr,pd) {
				var result = jQuery.parseJSON(data);
				
				if (result[1] == null) {
					if (result[0] == "TAB_GUBN_ERROR") {
						alertify.error([[#{msg.common.upload.failed.separator}]], 0);
					} else {
						alertify.error([[#{msg.common.valid}]], 0);
					}
					$('.ajax-file-upload-statusbar').fadeOut('slow');
					$('.ajax-file-upload-statusbar').remove();
				} else {
					if(result[0] == "FILE_SIZE_LIMIT_OVER") {
						alertify.alert(result[1], function(){
							$('.ajax-file-upload-statusbar').fadeOut('slow');
							$('.ajax-file-upload-statusbar').remove();
						});
					} else if(result[2] == "CSV_FILE") {
						src_fn.getCsvData(result[0][0].registSeq);

						$('#srcCsvFileId').val(result[0][0].registFileId);
						$('.ajax-file-upload-statusbar').fadeOut('slow');
						$('.ajax-file-upload-statusbar').remove();

						src_fn.makeFileTag(result[0][0]);
					} else if(result[2] == "EXCEL_FILE") {
						if(result[1].length != 0) {
							for(var i = 0; i < result[1].length; i++) {
								var num = i+1;
								var checkedTxt = "";
								
								var sheetName = result[1][i].name.toUpperCase().trim();
								if (sheetName.startsWith("SECURITY")){
									if (sheetName.indexOf("DEP") > -1) {
									} else {
										checkedTxt = "checked";
									}
								}
								
								var sheetTr = '<tr><td class="text-center"><input type="checkbox" name="sheetNameSelect" value="'+result[1][i].no+'" id="sheet'+result[1][i].no+'" class="form-check-input" '+checkedTxt+'>'
												+'<label class="form-check-label text-blue-gray" for="sheet'+result[1][i].no+'"></label></td>';
								sheetTr += '<td class="text-left">'+result[1][i].name+'</td></tr>'
								$("#sheetBody").append(sheetTr);
							}
							
							$('#sheetApply').attr('onclick', 'com_fn.getSheetData(' + result[0][0].registSeq + ', "total")');
						}
						
						if (typeof alertify.selectSheet === "undefined") {
							alertify.dialog('selectSheet', function() {
								return {
									setup: function() {
										var settings = alertify.confirm().settings;
										
										for (var prop in settings) {
											this.settings[prop] = settings[prop];
										}
										
										var setup = alertify.confirm().setup();
										setup.buttons = [];
										setup.focus.element = 1;
										
										return setup;
									},
								    hooks: {
								    	onshow: function() {
								        	this.elements.dialog.style.maxWidth = 'none';
								          	this.elements.dialog.style.width = '365px';
								        }
									}
								};
							}, false, 'alert');
	                	}
						
						alertify.selectSheet($(".sheetSelectPop").html()).set('title', 'Select Sheet');
						$("#sheetBody").empty();
						
						$('.ajax-file-upload-statusbar').fadeOut('slow');
						$('.ajax-file-upload-statusbar').remove();
						
						_scrtUploadFile = result[0][0];
					} else {
						alertify.error([[#{msg.common.valid}]], 0);
						$('.ajax-file-upload-statusbar').fadeOut('slow');
						$('.ajax-file-upload-statusbar').remove();
					}
				}
			}
		});
	}
}

var fullDiscovered = {
		loadSecurityGrid : function(){
			var fullDiscoveredList = $("#fullDiscoveredList");
			
			var colModelArr = [];
			var colModelObj = {name: 'gridId', index: 'gridId', editable:false, hidden:true, key: true};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'ossId', index: 'ossId', width: 150, align: 'left', hidden:true};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'ossName', index: 'ossName', width: 150, align: 'left', editable:false, template: searchStringOptions};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'ossVersion', index: 'ossVersion', width: 50, align: 'left', editable:false, template: searchStringOptions};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'cveId', index: 'cveId', width: 70, align: 'left', editable:false, template: searchStringOptions};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'cvssScore', index: 'cvssScore', width: 70, align: 'left', editable:false, template: searchStringOptions};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'publDate', index: 'publDate', width: 70, align: 'left', editable:false, template: searchStringOptions};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'vulnerabilityResolution', index:'vulnerabilityResolution', width:110, formatter: 'select', editable:true, edittype:"select", template: searchStringOptions, editoptions:{
							value:{"Unresolved":"Unresolved","Fixed":"Fixed"}
						, dataEvents:[{type:'change',
							fn: function(e){
								$("#fullDiscoveredList").jqGrid('saveRow', lastsel);
								$("#fullDiscoveredList").jqGrid("resetSelection");
								lastsel = -1;
							}
						}]
					}
				};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'vulnerabilityLink', index: 'vulnerabilityLink', width: 120, align: 'left', formatter: sec_com_fn.displayVulnerabilityLink, template: searchStringOptions, editable:false};
			colModelArr.push(colModelObj);
			colModelObj = {name: 'securityComments', index: 'securityComments', width: 50, align: 'left', template: searchStringOptions, editable:true};
			colModelArr.push(colModelObj);
			
			// apply user columns setting on
			var listType = 'SECURITY_FULL';
			var totalColInfos = [
					{'OSS Name' : 'ossName'}, {'OSS Version' : 'ossVersion'}, {'CVE ID' : 'cveId'}, {'CVSS SCORE' : 'cvssScore'}, {'Published Date' : 'publDate'}, {'Vulnerability Resolution' : 'vulnerabilityResolution'},
					{'Vulnerabilty Link' : 'vulnerabilityLink'}, {'Security Comments' : 'securityComments'}
		  	];
			var defaultTotalColNames = ['ossName', 'ossVersion', 'cveId', 'cvssScore', 'publDate', 'vulnerabilityResolution', 'vulnerabilityLink', 'securityComments'];
			var defaultColNames = ['ossName', 'ossVersion', 'cveId', 'cvssScore', 'vulnerabilityResolution'];
			applyUserSettings(colModelArr, colModelObj, totalColInfos, defaultTotalColNames, listType);
			
			fullDiscoveredList.jqGrid({ 
				datatype: 'local',  
				data: fullDiscoveredMainData,
				colNames: ['ID','OSS ID','OSS Name','OSS<br/>Version','CVE ID','CVSS<br/>SCORE','Published<br/>Date','Vulnerability<br/>Resolution','Vulnerabilty<br/>Link','Security<br/>Comments'],
				colModel: colModelArr,
				editurl:'clientArray',
	 			autowidth: true,
//	 			multiselect: true,
//	 			multiselectWidth: 35,
				pager: '#fullDiscoveredListPager',
				rowNum: 200,
				rowList: [200, 500, 1000, 5000],
				gridview: true,
				sortable: function (permutation) {
				},
				loadonce:true,
				toppager:true,
				sortorder: 'desc',
				height: 'auto',
				onCellSelect: function(rowid,iCol,cellcontent,e) {
//					sec_com_fn.customOnCellSelect("fullDiscoveredList", iCol);
				},
				beforeSelectRow: function(rowid, e) {
//	 				if (rowid == prevEditSel) {
//	 					$("#jqg_fullDiscoveredList_" + rowid).prop("checked", true);
//	 				}
					
//	 				var $self = $(this), iCol, cm,
//	 			    $td = $(e.target).closest("tr.jqgrow>td"),
//	 			    $tr = $td.closest("tr.jqgrow"),
//	 			    p = $self.jqGrid("getGridParam");
//	 				    if ($(e.target).is("input[type=checkbox]") && $td.length > 0) {
//	 			       iCol = $.jgrid.getCellIndex($td[0]);
//	 			       cm = p.colModel[iCol];
				       
//	 			       if (cm != null && cm.name === "cb") {
//	 			           // multiselect checkbox is clicked
//	 			           $self.jqGrid("setSelection", $tr.attr("id"), true ,e);
//	 			       }
//	 			    }
				    
//	 			    return true;
				},
				onSelectRow: function(rowid, status, e) {
//	 				var ossVersion = fixedList.jqGrid("getRowData", rowid)["ossVersion"];
//	 			    if ("" == ossVersion) $("#jqg_fullDiscoveredList_" + rowid).prop("checked", false);
				},
				ondblClickRow: function(rowid,iRow,iCol,e) {
//	 				sec_com_fn.customOnDblClickRow("fullDiscoveredList" ,rowid);
				},
				loadComplete: function(data) {
					lastsel = -1;
					if(data.records > 0) {
						var rowIdx = 0, rows = this.rows, rowsCount = rows.length, row;
						for(var _idx=0;_idx<rowsCount;_idx++) {
							row = rows[_idx];
							$("#"+row.id).find("input[type=checkbox]").removeClass("cbox");
						}
					}
				
					// append button event
					var pageButtonArea = $('#fullDiscoveredList_toppager_left');
					if ($("#fullDiscoveredList_toppager_left").find('button').length == 0) {
		            	var appendBtn = "<button type=\"button\" class=\"btn btn-sm btn-grid-light-gray float-left ml-1\" onclick=\"com_fn.checkDownloadExcel('fullDiscovered')\"><i class=\"fas fa-download\"></i></button>";
		                $("#fullDiscoveredList_toppager_left").append(appendBtn);
		            }
					
					$("#fullDiscoveredList td[aria-describedby=totalList_officialPatchLink]").css("white-space", "nowrap");
					
					var setUpColumnButton = $('#setUpColumnButtonFull');
					/* columns licalization */
	                if (setUpColumnButton.length === 0) {
	                    var savedColNames = [];
	                    var dropdownMenuOptions = {
	                    	_btnId : "Full",
	                    	_targetId : "fullDiscoveredList",
	                        _listType: listType,
	                        _totalColInfos: totalColInfos,
	                        _defaultColNames: defaultColNames,
	                        _savedColNames: savedColNames
	                    };
	                    pageButtonArea.append(createUserCoulmnsSettingButton(dropdownMenuOptions));

	                    // Check for click events occurring inside the menu area
	                    $("#setUpColumnMenuFull").on("click", function(event) {
	                        event.stopPropagation();
	                    });

	                    $('#setUpColumnButtonFull').on("click", function(event) {
	                        event.stopPropagation();
	                        $('#setUpColumnMenuFull').toggleClass("show");
	                        $(this).toggleClass("show");
	                    });
	                }
				},
				gridComplete : function() {
					if (fullDiscoveredValidMsgData) {
						gridValidMsgNew(fullDiscoveredValidMsgData, "fullDiscoveredList");
					}
					
					updateGridRowCount('fullDiscoveredList', 'fullDiscoveredListPager'); 
				}
			});
			
			fullDiscoveredList.jqGrid('filterToolbar',{stringResult: true, searchOnEnter: true, searchOperators: true, defaultSearch: "cn",
				beforeSearch : function () {
					if (!this.p.postData.referenceId) {
						this.p.postData.referenceId = [[${project.prjId}]];
					}
				},
				afterSearch: function () {
					updateGridRowCount('fullDiscoveredList', 'fullDiscoveredListPager'); 
				}	
			});
			
			fullDiscoveredList.jqGrid('navGrid',"#fullDiscoveredListPager",{add:false,edit:false,del:false,search:false,refresh:false, cloneToTop:true});
		}
	}

var displayInfo;
var fn = {
		getProjectStatus : function () {
			$.ajax({
				url : "/project/getProjectStatus",
				type : 'POST',
				data : JSON.stringify({"prjId" : [[${project.prjId}]]}),
				dataType : 'json',
				cache : false,
				async : false,
				contentType : 'application/json',
				success : function(data){
					displayInfo = data;
				},
				error : function(){
					alertify.error([[#{msg.common.valid2}]], 0);
				}
			});
		},
		displayProjectInfo : function() {
			fn.getProjectStatus();
			
			var display = "";
			
			var pNm = [[${project.prjName}]];
			var pVer = [[${project.prjVersion}]];
			if ("" != pVer && pVer != null) pNm += " (" + pVer + ")";
			
			// project name
			var prjName = "<span class=\"description-percentage text-dark-gray\">";
			prjName += "<a class=\"text-dark-gray text-bold hover-line urlLink goToEditLink\" style=\"cursor: pointer;\" onclick=\"fn.mvEditTab(" + [[${project.prjId}]] + ")\" title=\"" + pNm + "\">" + pNm + "</a></span>";
			display += prjName;
			
			// status
			var status = "<span class=\"ml-2\"> | </span>";
			var projectStatus = [[${project.status}]];
			var customStatus = [[${@CoCodeManager.getCodeString(@CommonFunction.getCoConstDefVal('CD_PROJECT_STATUS'), project.status)}]];
			
			switch(projectStatus){
			case 'REQ':
				status += "<span class=\"text-pink text-bold ml-2\">" + customStatus + "</span>";

				break;
			case 'REV':
				status += "<span class=\"text-yellow text-bold ml-2\">" + customStatus + "</span>";

				break;
			case 'DROP':
				status += "<span class=\"text-gray text-bold ml-2\">" + customStatus + "</span>";

				break;
			case 'FREV':
				status += "<span class=\"text-purple text-bold ml-2\">" + customStatus + "</span>";

				break;
			case 'COMP':
				status += "<span class=\"text-dark-blue text-bold ml-2\">" + customStatus + "</span>";

				break;
			default:
				status += "<span class=\"text-success text-bold ml-2\">" + customStatus + "</span>";

				break;
			}
			display += status;
			
			// osc progress
			var identificationStatus = [[${project.identificationStatus}]];
			identificationStatus = identificationStatus||"";
			var verificationStatus = [[${project.verificationStatus}]];
			verificationStatus = verificationStatus||"";
			var statusRequestYn = [[${project.statusRequestYn}]];
			statusRequestYn = statusRequestYn||"";
			
			var oscProgress = "<span class=\"ml-2\"> | </span>";
			if ("" != identificationStatus) {
				if ("DROP" == projectStatus) {
					if ("CONF" == identificationStatus) {
						oscProgress += '<span class="badge badge-gray size-sm width-6rem px-1 ml-2">Identification</span>';
					} else {
						oscProgress += '<span class="badge badge-outline-gray-white size-sm width-6rem px-1 ml-2">Identification</span>';
					}
				} else if ("FREV" == projectStatus) {
					oscProgress += "<span class=\"badge badge-outline-dark-blue hover-light-btn size-sm width-6rem px-1 ml-2\" style=\"cursor:pointer;\" ";
					if ("Y" == [[${project.androidFlag}]]) {
						oscProgress += "onclick=\"createTabInFrame('"+[[${project.prjId}]]+"_Identify', '/project/identification/" + [[${project.prjId}]] + "/4')\">Identification</span>";
					} else {
						oscProgress += "onclick=\"createTabInFrame('"+[[${project.prjId}]]+"_Identify', '/project/identification/" + [[${project.prjId}]] + "/5')\">Identification</span>";
					}
				} else {
					var initDiv = "";
					if ("Y" == [[${project.androidFlag}]]) {
						initDiv = "4";
					} else {
						initDiv = "5";
					}
					
					if ("CONF" == identificationStatus) {
						oscProgress += "<span class=\"badge badge-outline-dark-blue hover-light-btn size-sm width-6rem px-1 ml-2\" style=\"cursor:pointer;\" ";
						oscProgress += "onclick=\"createTabInFrame('"+[[${project.prjId}]]+"_Identify', '/project/identification/" + [[${project.prjId}]] + "/" + initDiv + "')\">Identification</span>";
					} else if ("PROG" == projectStatus) {
						oscProgress += "<span class=\"badge badge-success hover-success-btn size-sm width-6rem px-1 ml-2\" style=\"cursor:pointer;\" ";
						oscProgress += "onclick=\"createTabInFrame('"+[[${project.prjId}]]+"_Identify', '/project/identification/" + [[${project.prjId}]] + "/" + initDiv + "')\">Identification</span>";
					} else if ("REQ" == projectStatus) {
						oscProgress += "<span class=\"badge badge-pink hover-pink-btn size-sm width-6rem px-1 ml-2\" style=\"cursor:pointer;\" ";
						oscProgress += "onclick=\"createTabInFrame('"+[[${project.prjId}]]+"_Identify', '/project/identification/" + [[${project.prjId}]] + "/" + initDiv + "')\">Identification</span>";
					} else if ("REV" == projectStatus) {
						oscProgress += "<span class=\"badge badge-yellow hover-yellow-btn size-sm width-6rem px-1 ml-2\" style=\"cursor:pointer;\" ";
						oscProgress += "onclick=\"createTabInFrame('"+[[${project.prjId}]]+"_Identify', '/project/identification/" + [[${project.prjId}]] + "/" + initDiv + "')\">Identification</span>";
					}
				}
			} else {
				if ("DROP" == projectStatus) {
					oscProgress += '<span class="badge badge-success hover-success-btn size-sm width-6rem px-1 ml-2">Identification</span>';
				} else {
					oscProgress += "<span class=\"badge badge-success hover-success-btn size-sm width-6rem px-1 ml-2\" style=\"cursor:pointer;\" ";
					if ("Y" == [[${project.androidFlag}]]) {
						oscProgress += "onclick=\"createTabInFrame('"+[[${project.prjId}]]+"_Identify', '/project/identification/" + [[${project.prjId}]] + "/4')\">Identification</span>";
					} else {
						oscProgress += "onclick=\"createTabInFrame('"+[[${project.prjId}]]+"_Identify', '/project/identification/" + [[${project.prjId}]] + "/5')\">Identification</span>";
					}
				}
			}
			
			if ("CONF" != identificationStatus) {
				oscProgress += '<span class="text-gray-white text-bold text-md ml-2">&gt;</span>';
				oscProgress += '<span class="badge badge-outline-gray-white size-sm width-6rem px-1 ml-2">Packaging</span>';
			} else {
				oscProgress += '<span class="text-blue-gray text-bold text-md ml-2">&gt;</span>';
				if ("DROP" == projectStatus) {
					if ("CONF" == verificationStatus) {
						oscProgress += '<span class="badge badge-gray size-sm width-6rem px-1 ml-2">Packaging</span>';
					} else {
						oscProgress += '<span class="badge badge-outline-gray-white size-sm width-6rem px-1 ml-2">Packaging</span>';
					}
				} else {
					if ("" == verificationStatus) {
						if ("COMP" == projectStatus || "Y" == statusRequestYn) {
							oscProgress += '<span class="badge badge-outline-gray-white size-sm width-6rem px-1 ml-2">Packaging</span>';
						} else if ("" != identificationStatus) {
							oscProgress += "<span class='badge badge-success hover-success-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
						}
					} else if ("PROG" == verificationStatus) {
						if ("COMP" == projectStatus || "Y" == statusRequestYn) {
							oscProgress += '<span class="badge badge-outline-gray-white size-sm width-6rem px-1 ml-2">Packaging</span>';
						} else {
							oscProgress += "<span class='badge badge-success hover-success-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
						}
					} else if ("REV" == verificationStatus) {
						oscProgress += "<span class='badge badge-yellow hover-yellow-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
					} else if ("REQ" == verificationStatus) {
						oscProgress += "<span class='badge badge-pink hover-pink-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
					} else if ("NA" == verificationStatus || "DROP" == verificationStatus) {
						oscProgress += '<span class="badge badge-outline-gray-white size-sm width-6rem px-1 ml-2">Packaging</span>';
					} else {
						if ("CONF" == verificationStatus) {
							oscProgress += "<span class='badge badge-outline-dark-blue hover-light-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
						} else {
							if ("NA" == [[${project.distributeTarget}]]) {
								oscProgress += '<span class="badge badge-outline-gray-white size-sm width-6rem px-1 ml-2">Packaging</span>';
							} else {
								if ("PROG" == projectStatus) {
									oscProgress += "<span class='badge badge-success hover-success-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
								} else if ("REQ" == projectStatus) {
									oscProgress += "<span class='badge badge-pink hover-pink-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
								} else if ("REV" == projectStatus) {
									oscProgress += "<span class='badge badge-yellow hover-yellow-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
								} else if ("FREV" == projectStatus) {
									oscProgress += "<span class='badge badge-outline-dark-blue hover-light-btn size-sm width-6rem px-1 ml-2' style='cursor:pointer;' onclick=\"createTabInFrame('" + [[${project.prjId}]] + "_Packaging', '/project/verification/" + [[${project.prjId}]] + "')\">Packaging</span>";
								}
							}
						}
					}
				}
			}
						
			display += oscProgress;
			
			// vulnerability score
			var standardScore = [[${@CoCodeManager.getCodeExpString(@CommonFunction.getCoConstDefVal('CD_SECURITY_VULNERABILITY_SCORE'), @CommonFunction.getCoConstDefVal('CD_SECURITY_VULNERABILITY_DETAIL_SCORE'))}]];
			var vulnerability = "<span class=\"ml-2\"> | </span>";
			
			var cvssScoreMax = displayInfo.cvssScoreMax;
			if (typeof displayInfo.vulnerabilityResolution !== "undefined") {
				var vulnerabilityResolution = displayInfo.vulnerabilityResolution;
				if ("Need to resolve" == vulnerabilityResolution) {
					vulnerability += '<span type="button" class="badge badge-dark-gray size-sm width-9rem px-1 ml-2 customShadow" onclick=\"fn.mvSecurity()\">' + vulnerabilityResolution + '('+cvssScoreMax+')</span>';
				} else {
					vulnerability += '<span type="button" class="badge badge-cerebral-gray size-sm width-9rem px-1 ml-2 customShadow" onclick=\"fn.mvSecurity()\">' + vulnerabilityResolution + '('+cvssScoreMax+')</span>';
				}
			} else {
				if (typeof cvssScoreMax !== "undefined") {
					vulnerability += '<span type="button" class="badge badge-cerebral-gray size-sm width-9rem px-1 ml-2" onclick=\"fn.mvSecurity()\">Discovered(' + cvssScoreMax + ')</span>';
				} else {
					vulnerability += '<span type="button" class="badge badge-cerebral-gray size-sm width-9rem px-1 ml-2" onclick=\"fn.mvSecurity()\">Discovered(N/A)</span>';
				}
			}
			
			display += vulnerability;
			$("#displayProjectInfo").html(display);
			
			if ($(".goToEditLink").width() > 300) {
				$(".goToEditLink").addClass("ellipsis");
			}
	},
	handleUserCommentPopupOpen: function () {
		const param = {
	    	"referenceDiv" : [[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_SECURITY_USER')}]],
	        "referenceId" : [[${project.prjId}]]
	   	}
	    getAjaxJsonData(param, "/comment/getDivUserComment", "html", function (res) {
	  		if (!alertify.editDialog) {
	  			commonAlertifyDialog('editDialog');
	  		}
	  		alertify.editDialog().set('onshow', function(e) {
	  			$(alertify.editDialog().elements.buttons.primary).empty();
        	}).setContent(res).show();
	   	},
	   	null,
	 	function () {
	     	$("#modifiedCommentInPjtEditor").summernote({
	          	height: 180,
	           	callbacks: {
	              	onInit: function () {
	               		$(this).summernote('code', $("#userContents").val());
	            	}
	           	}
	      	});
	  	});
	},
	sendEditor: function (type) {
		//코멘트 저장
	  	var editorVal = replaceWithLink($("#modifiedCommentInPjtEditor").summernote('code'));

	   	if (!editorVal || editorVal == "") {
	     	alertify.alert([[#{msg.project.enter.comment}]], function () {});
	    	return false;
	   	}
	 	var referenceId = [[${project.prjId}]]
	  	var param = {referenceId: referenceId, referenceDiv: [[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_SECURITY_HIS')}]], contents: editorVal, mailSendType: type};

	  	$.ajax({
	     	url: '/project/sendComment',
	      	type: 'POST',
	     	dataType: 'json',
	    	cache: false,
	      	data: param,
	      	success: function (json) {
	          	if (json.isValid == 'false') {
	             	alertify.error([[#{msg.common.valid2}]], 0);
	           	} else {
	             	alertify.success([[#{msg.project.sent.comments.success}]]);
	             	$("#modifiedCommentInPjtEditor").summernote('code', '');
	             	$("#userContents").val('');
	             	$('.ajs-close').trigger("click");
                    fn_comment.getCommentList(commentsParam);
	          	}
	     	},
	       	error: function () {
	          	alertify.error([[#{msg.common.valid2}]], 0);
	      	}
	 	});
	},
	saveEditor: function () {
		//코멘트 임시저장
	 	var editorVal = replaceWithLink($("#modifiedCommentInPjtEditor").summernote('code'));

	  	var referenceId = [[${project.prjId}]]
		var param = {
	     	referenceId: referenceId
	    	, referenceDiv: [[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_SECURITY_USER')}]]
	       	, contents: editorVal
	  	};
	   	$.ajax({
	      	url: "/project/saveComment",
	      	type: "POST",
	       	dataType: "json",
	     	cache: false,
	      	data: param,
	       	success: function (json) {
	        	if (json.isValid == 'false') {
	              	alertify.error([[#{msg.common.valid2}]], 0);
	          	} else {
	             	alertify.success([[#{msg.common.success}]]);
	             	$("#userContents").val(editorVal);
		         	$('.ajs-close').trigger("click");
	          	}
	    	},
	     	error: function () {
	         	alertify.error([[#{msg.common.valid2}]], 0);
	   		}
		});
	},
    mvEditTab : function(prjId){
        createTabInFrame(prjId+'_Project', '/project/edit/'+prjId);
    },
    closeAlertifyView : function () {
		$(".ajs-close").trigger("click");
	},
	onUpdateSuccess : function(json, status){
		loading.hide();
	    if (json.resCd == '10'){
	    	alertify.success([[#{msg.common.success}]]);
	   	} else {
	    	alertify.error([[#{msg.common.valid2}]], 0);
	   	}
	}
}

	var fn_comment = {
		callbackFunction : function () {
	    	fn_comment.getCommentList(commentsParam);
	    },
		getCommentList : function(param) {
			$.ajax({
				type: "GET",
				url: '/comment/getCusCommentList',
				dataType : 'html',
				cache : false,
				data : param,
				success: function (res) {
					if (typeof param.height !== undefined) {
						$(".comment-card-body").attr("style", "max-height:" + param.height + "px; overflow-y: auto;");
					}
					$("#commentList").empty();
					$("#commentList").html(res);
				},
				error: function(data){
					alertify.error([[#{msg.common.valid2}]], 0);
				}
			});
		},
		getMoreCommentsList : function() {
			commentsParam["moreFlag"] = "Y";
			fn_comment.getCommentList(commentsParam);
		},
		editComments : function(_commId, _referenceDiv, _referenceId) {
			$.ajax({
				url : '/comment/getEditPopup',
				type : 'POST',
				data : {'commId' : _commId},
				dataType : 'html',
				cache : false,
				success : function(res){
					if (typeof alertify.editComments === "undefined"){
						alertifyWithoutButtons('editComments');
	        		}
					alertify.editComments().set('title', 'Edit Comments').setContent(res).show();
					$("#updateComments").attr("onclick", "fn_comment.updateComments("+_commId+", "+_referenceDiv+", "+_referenceId+")");
					$("#commentEdit").summernote({minHeight: 180, maxHeight: 800, lang: "ko-KR"});
				}
			});
		},
		updateComments : function (_commId, _referenceDiv, _referenceId) {
			if ("" == $("#commentEdit").next().find(".note-editable").text()) {
				alertify.alert("Please enter a comment", function(){});
				return false;
			} else {
				var param = {commId : _commId, contents : replaceWithLink($("#commentEdit").summernote('code')), referenceDiv: _referenceDiv, referenceId: _referenceId};
					$.ajax({
					url : '/comment/updateComment',
					type : 'POST',
					dataType : 'json',
					cache : false,
					data : param,
					success : function(json){
						alertify.success([[#{msg.common.success}]]);
						$(".ajs-close").trigger("click");
						fn_comment.getCommentList(commentsParam);
					},
					error : function(){
						alertify.error([[#{msg.common.valid2}]], 0);
					}
				});
			}
		},
		deleteComments : function (_commId) {
			if (typeof alertify.delCommentSecDialog === "undefined") {
				basicAlertifyDialog('delCommentSecDialog');
			}
			alertify.delCommentSecDialog("Are you sure you want to delete this comment?", function (e) {
				if (e) {
					$.ajax({
						url : '/comment/deleteComment',
						type : 'POST',
						dataType : 'json',
						cache : false,
						data : {'commId' : _commId},
						success : function(data){
							alertify.success([[#{msg.common.success}]]);
							$(".ajs-close").trigger("click");
							fn_comment.getCommentList(commentsParam);
						},
						error : function(){
							alertify.error([[#{msg.common.valid2}]], 0);
						}
					});
				} else {
					return false;
				}
			});
		},
		closeAlertifyView : function () {
			fn.closeAlertifyView();
		},
		activateCommentArea : function () {
			// change tab area
			if (!$(".comment-area").is(":visible")) {
				$(".contents-area").removeClass("col-12");
				$(".contents-area").addClass("col-lg-9");
				
				fn_comment.getCommentList(commentsParam);
				$(".comment-area").show();
			} else {
	 			$(".contents-area").removeClass("col-lg-9");
	 			$(".contents-area").addClass("col-12");
	 			$(".comment-area").hide();
			}
		},
		showCommentHistory : function () {
			fn_comment.activateCommentArea();
			
			var _rDiv = [[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_SECURITY_HIS')}]];
	        openCommentHistory('/comment/popup/security/' + _rDiv + '/' + [[${project.prjId}]]);
		}
	}
</script>
</th:block>