<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="contentScript">
<script th:inline="javascript">
	var lastsel;	
	var tempNewOssId;
	var temp={
		obligation:''
	};
	
	var licenseTags=[];
	var commentTemp = '';
	var gLicenseData = new Array();
	var detectedLicenseValid = true;
	var deactivateFlag = "N";
	var renameFlag = "N";
	var nickNameClone;
	var commentsParam = {referenceId : [[${ossId}]], referenceDiv : 'oss'};
    var ossId = [[${ossId}]] || null;
    var isReadOnly = [[${isReadOnly}]] || null;

    var downloadLocationList = [[${downloadLocationList}]];
    var ossNickList = [[${ossNickList}]];

    console.log(downloadLocationList);
    console.log(ossNickList);

	//데이터 객체
	var data = {
		detail : [[${detail}]],
		list : [[${list}]],
		components : [[${components}]],
		componentsPartner : [[${componentsPartner}]],
		vulnInfoList : [[${vulnInfoList}]],
		clone : '',
		typeCodes : [],
		copyData : [[${copyData}]],
		init : function(){
			if (data.list == null) {
				data.list = new Array();
				data.list.rows = new Array();
			}
			commentTemp = $('<div>').append($('dl[name=commentClone]').clone());
			$('dl[name=commentClone]').remove();
			data.clone = $('.multiTxtSet').clone().html();
			nickNameClone = $('.multiTxtSet').clone().html();
			data.cloneDownloadLocation = $('.multiDownloadLocationSet').clone().html();
			data.cloneDetectLicense = $('.multiDetectedLicenseSet').clone().html();
			deactivateFlag = (data.detail&&data.detail.deactivateFlag)||"N";
			//데이터 초기화(컨트롤러에서 가져온 데이터)
			if (data.detail) {
				data.syncData(data.detail, false);
			} else {//신규 등록이나 카피일때
				if (data.copyData) {
					data.syncData(data.copyData, true);
				} else {
					if (data.list != null && data.list.rows.length > 1) {
						$('input[type=radio]:last').trigger('click');
					} else {
						$('input[type=radio]:first').trigger('click');
					}
					
					// 신규 등록이나, 동일한 oss name으로 등록된 nickname이 존재하는 경우
					var ossNickList = [];
					var downloadLocationList = [];
					ossNickList = [[${ossNickList}]];

                    console.log(ossNickList);
					downloadLocationList = [[${downloadLocationList}]];
					if (ossNickList != null && ossNickList.length > 0) {
						ossNickList.forEach(function(nickName, index, obj){
							if (index == 0) {
								$('.multiTxtSet').empty();
							}

							let nickHtml 	= 	'<div class="col-2" style="margin-top: 5px;">';
							nickHtml 		+= 		'<div class="input-group card-tools">';
							nickHtml 		+=			'<input class="form-control" name="ossNicknames" type="text" value="'+nickName+'"/>';
							nickHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
							nickHtml 		+=		'</div>';
							nickHtml 		+=		'<span class="retxt"></span>';
							nickHtml 		+= 	'</div>';
							
							$('.multiTxtSet').append(nickHtml);				
						});
					}
					
					if (downloadLocationList != null && downloadLocationList.length > 0) {
						downloadLocationList.forEach(function(downloadLocation, index, obj){
							if (index == 0) {
								$('.multiDownloadLocationSet span:first').remove();
							}
							
							let downloadLocationHtml 	= 	'<div style="margin-top: 5px;">';
							downloadLocationHtml 		+= 		'<div class="input-group card-tools">';
							downloadLocationHtml 		+=			'<input class="form-control" name="downloadLocations" type="text" value="'+downloadLocation+'"/ onblur="fn.urlDuplication(this);">';
							downloadLocationHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
							downloadLocationHtml 		+=		'</div>';
							downloadLocationHtml 		+=		'<span class="urltxt"></span>';
							downloadLocationHtml 		+=		'<span class="retxt"></span>';
							downloadLocationHtml 		+= 	'</div>';
							
							$(".multiDownloadLocationSet").append(downloadLocationHtml);
						});
					}

					if ("" != $('input[name="downloadLocations"]').val()){
						fn.urlDuplicationAll();
					}
				}
			}
			
			$('textarea[name=ossCopyright]').height(240);

            $('.btnCancel').click(function () {
               $('.pop').hide();
            });
			
			$("[name='commentInput']").summernote({
                height: 150,
                callbacks: {
                    onInit: function() {
                        var content = $(this).summernote('code');
                        if (content === '<p><br></p>') {
                            $(this).summernote('code', '');
                        }
                    }
                }
            });
		},
		syncData : function(syncData, copyFlag){
			$.each(syncData, function(k, v){
				$('input[name='+k+'],select[name='+k+'],textarea[name='+k+']').each(function(){
					var $this = $(this);
					$this.val(v);
				});
				
				$('input[type=radio]').each(function(){
					var $this=$(this); 
					if($this.val()== v){
						$(this).trigger('click');
					}
				});
				
				switch(k){
					case 'ossNicknames':
						v.forEach(function(nickName, index, obj){
							if (index == 0) {
								$('.multiTxtSet').empty();
							}
							let nickHtml 	= 	'<div class="col-2" style="margin-top: 5px;">';
							nickHtml 		+= 		'<div class="input-group card-tools">';
                            if(isReadOnly == 'true' || isReadOnly) {
                                nickHtml 		+=			'<input class="form-control" name="ossNicknames" type="text" value="'+nickName+'" disabled/>';
                            } else {
                                nickHtml 		+=			'<input class="form-control" name="ossNicknames" type="text" value="'+nickName+'"/>';
                                nickHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
                            }
							nickHtml 		+=		'</div>';
							nickHtml 		+=		'<span class="retxt"></span>';
							nickHtml 		+= 	'</div>';
							
							$('.multiTxtSet').append(nickHtml);				
						});
						
						break;
					case 'downloadLocations':
						v.forEach(function(downloadLocation, index, obj){
							if (index == 0) {
								$('.multiDownloadLocationSet').empty();
							}
							let downloadLocationHtml 	= 	'<div style="margin-top: 5px;">';
							downloadLocationHtml 		+= 		'<div class="input-group card-tools">';
                            if(isReadOnly == 'true' || isReadOnly) {
                                downloadLocationHtml 		+=			'<input class="form-control" name="downloadLocations" type="text" value="'+downloadLocation+'" onblur="fn.urlDuplication(this)"/ disabled>';
                            } else {
                                downloadLocationHtml 		+=			'<input class="form-control" name="downloadLocations" type="text" value="'+downloadLocation+'" onblur="fn.urlDuplication(this)"/>';
                                downloadLocationHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
                            }
							downloadLocationHtml 		+=		'</div>';
							downloadLocationHtml 		+=		'<span class="urltxt"></span>';
							downloadLocationHtml 		+=		'<span class="retxt"></span>';
							downloadLocationHtml 		+= 	'</div>';
							
							$(".multiDownloadLocationSet").append(downloadLocationHtml);
						});
						
						break;
					case 'detectedLicenses':
						v.forEach(function(detectLicense, index, obj){
							if (index == 0){
								$('.detectedLicensesDiv').empty();
							}
							let detectedLicenseHtml 	= 	'<div class="col-2" style="margin-top: 5px;">';
							detectedLicenseHtml 		+= 		'<div class="input-group card-tools">';
                            if(isReadOnly == 'true' || isReadOnly) {
                                detectedLicenseHtml 		+=			'<input class="form-control" name="detectedLicenses" type="text" value="'+detectLicense+'"/ disabled>';
                            } else {
                                detectedLicenseHtml 		+=			'<input class="form-control" name="detectedLicenses" type="text" value="'+detectLicense+'"/>';
                                detectedLicenseHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
                            }
							detectedLicenseHtml 		+=		'</div>';
							detectedLicenseHtml 		+=		'<span class="retxt"></span>';
							detectedLicenseHtml 		+= 	'</div>';
							
							$(".detectedLicensesDiv").append(detectedLicenseHtml);			
						});
						
						break;
					case 'licenseDiv':
						if (v == 'S') {
							syncData.ossLicenses.forEach(function(item){
								$('input[name=licenseName]').val(item.licenseName);
								$('#licenseName').val(item.licenseNameEx);
								$('#ltDiv').html('<span style="cursor: none; width: 150px;" class="btn btn-block btn-light btn-sm">' + item.licenseType + '</span>');
								$('#obDiv').html('');
								$(item.obligation).appendTo('#obDiv');
							});
						} else if (v == 'M') {
							var licenseType = autoLicense(data.list.rows);
							var obligationHtml = autoObligation(data.list.rows);
							if ('' != licenseType) {
								$('#ltDiv').html('<span style="cursor: none; width: 150px;" class="btn btn-block btn-light btn-sm">' + licenseType + '</span>');
							} else {
								$('#ltDiv').html('');
							}
							$('#obDiv').html('');
							$(obligationHtml).appendTo('#obDiv');
						}
						
						break;
					case 'ossType':
						var colOssType = '';
						if (v.toUpperCase().indexOf('M') > -1) {
							colOssType += '<span class="badge badge-primary mr-1 text-sm">Multi</span>';
						}
						
						if (v.toUpperCase().indexOf('D') > -1) {
							colOssType += '<span class="badge badge-purple mr-1 text-sm">Dual</span>';
						}
						
						if (v.toUpperCase().indexOf('V') > -1) {
							colOssType += '<span class="badge badge-yellow mr-1 text-sm">v-Diff</span>';
						}
						
						if ('' != colOssType) {
							$("#ossTypeDiv").html(colOssType);
						}

                        break;

					case 'deactivateFlag':
						if(v.toUpperCase() == "Y"){
							$("#deactivateFlag").attr("checked", true);
							$("[name='deactivateFlag']").val(v);
						}
						
						break;
				}
			});
			
			if (copyFlag) {
				$("input[name=ossId]").val("");
				$(".multiDownloadLocationSet > div > span > input[name='downloadLocations']").each(function(idx, cur){
					$(cur).attr("onblur", "fn.urlDuplication(this)");
				});
			}
		}
	}
	
	//이벤트 객체
	var evt = {
		init : function(){ 
			$('.btnCancel').click(function(){
				$('.pop').hide();
				$('#blind_wrap').hide();
			}); // 팝업 닫기
			
			//닉네임 인풋 추가
			$('#nickAdd').on('click', function(){
				let nickHtml 	= 	'<div class="col-2" style="margin-top: 5px;">';
				nickHtml 		+= 		'<div class="input-group card-tools">';
				nickHtml 		+=			'<input class="form-control" name="ossNicknames" type="text" value="'+$("#input_ossNicknames").val()+'"/>';
				nickHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
				nickHtml 		+=		'</div>';
				nickHtml 		+=		'<span class="retxt"></span>';
				nickHtml 		+= 	'</div>';
				
				$('.multiTxtSet').append(nickHtml);
			});

			//Detect License Input 추가
			$('#detectedLicenseAdd').on('click', function(){
				let detectedLicenseHtml 	= 	'<div class="col-2" style="margin-top: 5px;">';
				detectedLicenseHtml 		+= 		'<div class="input-group card-tools">';
				detectedLicenseHtml 		+=			'<input class="form-control" name="detectedLicenses" type="text" value="'+$("#input_detectedLicense").val()+'" readonly/>';
				detectedLicenseHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
				detectedLicenseHtml 		+=		'</div>';
				detectedLicenseHtml 		+=		'<span class="retxt"></span>';
				detectedLicenseHtml 		+= 	'</div>';
				
				$(".detectedLicensesDiv").append(detectedLicenseHtml);
				setCustomAutoComplete("single");
			});
			
			//Download Location Input 추가
			$('#downloadLocationAdd').on('click', function(){
				var downloadLocation = $("#input_downloadLocations").val();
				
				let downloadLocationHtml 	= 	'<div style="margin-top: 5px;">';
				downloadLocationHtml 		+= 		'<div class="input-group card-tools">';
				downloadLocationHtml 		+=			'<input class="form-control" name="downloadLocations" type="text" value="'+downloadLocation+'"/ onblur="fn.urlDuplication(this);">';
				downloadLocationHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
				downloadLocationHtml 		+=		'</div>';
				downloadLocationHtml 		+=		'<span class="urltxt"></span>';
				downloadLocationHtml 		+=		'<span class="retxt"></span>';
				downloadLocationHtml 		+= 	'</div>';
				
				$(".multiDownloadLocationSet").append(downloadLocationHtml);
				$("#input_downloadLocations").val("");
				
				if ([[${ossId}]] == null && '' != downloadLocation){
					$(".multiDownloadLocationSet > div > div > input[name='downloadLocations']").each(function(idx, cur){
						$(cur).trigger("blur");
					});
				}
			});
			
			//oss 등록
			$("#save").on('click',function(){
				fn.save();
			});
			
			$("#rename").on('click',function(){
				renameFlag = 'Y';
				$('input[name=renameFlag]').val(renameFlag);
				fn.save();
			});
			
			$("#copy").on('click',function(){
				var ossId = $('input[name=ossId]').val();
				if(opener == null) {
					activeDeleteTabInFrame();
					createTabInFrame('copy_'+ossId+'_Opensource', '/oss/copy/'+ossId);
				} else{
					window.location.href = '/oss/copy/'+ossId;
				}
			});
			
			//라이센스 삭제
			$('#delete').on('click', function(){
				var editorVal = $("#commentCont").summernote('code');
				
				if ($("#commentCont").next().find(".note-editable").text() == "") {
					alertify.alert([[#{msg.oss.required.deletion}]], function(){});
					return false;
				}

				if (deactivateFlag == "Y"){
					alertify.alert([[#{msg.oss.required.deactivate.deletion}]], function(){});
					return false;
				}
				
				alertify.confirm([[#{msg.oss.warn.remove}]], function (e) {
					if (e) {
						loading.show();
						
						$('input[name=comment]').val(editorVal);
						
						if(validationDataSet()){
							$("#ossForm").ajaxForm({
								url :'/oss/validation',
					            type : 'POST',
					            dataType:"json",
					            cache : false,
						        success : onDeleteValidSuccess,
					            error : onError
						    }).submit();
						} else {
							loading.hide();
						}
					} else {
						return false;
					}
				});
			});
			
			//라이센스 삭제용 검색
			$('.search').on('click', function(){
				var postData=$('#listSearch').serializeObject();
				$("#_ossSelectList").jqGrid('setGridParam', {postData:postData}).trigger('reloadGrid');
			});
			
			$("#ossNameAllSearchFlag").on("change", function(e){
				$("[name='ossNameAllSearchFlag']").val($(this).prop("checked") ? "Y" : "N");
			});
			
			//select oss 팝업 확인 버튼 
			$("#ossSelectSubmit").on('click', function(){
				var rowId = $('#_ossSelectList').jqGrid('getGridParam', 'selrow');
				if (rowId === null) {
					alert([[#{msg.oss.required.select.grid}]]);
				} else {
	 				var rowData = $('#_ossSelectList').jqGrid('getRowData',rowId);
	 				var newOssId = rowData.ossId;
	 				if (newOssId == [[${ossId}]]){
						alertify.alert([[#{msg.oss.cannot.select}]], function(){});
	 					return;
	 				}
	 				
	 				tempNewOssId = newOssId;

                    // 동일한 OSS의 다른 version으로이관하는 경우
	 				if(data.detail.ossName == rowData.ossNameTemp) {
		 				//1. 기존 OssId를 사용중인 프로젝트의 OssId , Version 교체
		 				//2. 기존 Oss 의 Name 과 Nickname을 현재 선택한 Oss의 Nickname 에 병합
		 				//3. 기존의 Oss 삭제

						var editorVal = ""; // summernote 데이터로 변경해야함
	 					var sendData = {
	 						ossId:[[${ossId}]],
	 						newOssId:newOssId,
	 						comment:editorVal
	 					};

		 				
	 					$.ajax({
	 						url :'/oss/delAjax',
	 			            type : 'POST',
	 			            data : sendData,
	 			            dataType:"json",
	 			            cache : false,
	 				        success : function(json){
	 							var ossId = $('input[name=ossId]').val();
	 							if(json.resCd == '10'){
	 								alertify.alert([[#{msg.common.success}]],function(){
	 									reloadTabInframe('/oss/list');
	 									deleteTabInFrame('/oss/edit/'+ossId);

	 									$('.ossSelectPop').hide();
	 								});
	 							}else{
	 								alertify.error([[#{msg.common.valid}]], 0);
	 							}
	 				        },
	 			            error : function(){
	 			            	alertify.error([[#{msg.common.valid2}]], 0);
	 			            }
	 					});
	 				} else {
	 					// 다른 OSS로 이관하는 경우
	 					mergeOssForDelete(newOssId);
	 				}
				}
			});
			
			$("#mergeOssSubmit").on('click', function(){

                var editorVal = ""; // summernote 데이터로 변경해야함
				var sendData = {
					ossId : [[${ossId}]],
					newOssId : tempNewOssId,
					comment : editorVal
				};
				
				$.ajax({
					url :'/oss/delOssWithVersionMeregeAjax',
		            type : 'POST',
		            data : sendData,
		            dataType:"json",
		            cache : false,
			        success : function(json){
						var ossId = $('input[name=ossId]').val();
						if(json.resCd == '10'){
							alertify.alert([[#{msg.common.success}]],function(){
								deleteTabInFrame('/oss/edit/'+ossId);
								reloadTabInframe('/oss/list"/>');
								$('.mergeOssCheckPop').hide();
								$('#blind_wrap').hide();
							});
						}else{
							alertify.error([[#{msg.common.valid}]], 0);
						}
			        },
		            error : function(){
		            	alertify.error([[#{msg.common.valid2}]], 0);
		            }
				});
			});
			
			//프로젝트 리스트 더보기
			$('#listMore').on('click',function(){
				createTabInFrame('Project List', '/project/list');
			});

			//프로젝트 리스트 더보기
			$('#listMore3rd').on('click',function(){
				createTabInFrame('3rd Party List', '/partner/list');
			});
			
			if ([[${ossId}]] == null) { // OSS 신규등록 시 URL 링크 중복 체크
				$(".multiDownloadLocationSet > div > div > input[name='downloadLocations']").each(function(idx, cur){
					$(cur).trigger("blur");
				});
				
				$('input[name=homepage]').blur(function(){
					fn.homepageDuplication(this);
				});
			}
			
			$("[name='ossName']").on("blur", function(e){
				fn.urlDuplicationAll();
			});

			$("#deactivateFlag").on("click", function(){
				var isChecked = $("#deactivateFlag").prop("checked");
				var rtnVal = isChecked ? "Y" : "N";
				
				$("[name='deactivateFlag']").val(rtnVal);
			});

			$("#sync").on('click',function(){
				var ossName = $("input[name=ossName]").val();
				var ossVersion = $("input[name=ossVersion]").val();
				var ossId = $("input[name=ossId]").val();

				if(ossName!=""){
					onAjaxLoadingHide = true;
					$.ajax({
						url : '/oss/getOssListByName',
						dataType : 'json',
						cache : false,
						data : {ossName : ossName},
						contentType : 'application/json',
						success : function(data){
							var length = data.ossList.length;
							if (length == 1) {
								alertify.alert([[#{msg.oss.required.version}]], function(){});
							} else if (length > 1) {
								$.ajax({
									url : '/oss/checkExistsOssByname',
									type : 'GET',
									dataType : 'json',
									cache : false,
									async: false,
									data : {ossName : ossName},
									contentType : 'application/json',
									success : function(data){
										if(data.isValid == 'true') {
											var _popup = null;
											var _encUrl = "ossName="+fn.replaceGetParamChar(encodeURIComponent(ossName))+"&ossVersion="+fn.replaceGetParamChar(ossVersion)+"&ossId="+ossId;
											
											if(_popup == null || _popup.closed){
												_popup = window.open("/oss/osssyncpopup?"+_encUrl, "ossSyncViewPopup_"+ossName, "width=1000, height=700, toolbar=no, location=no, left=100, top=100");

												if(!_popup || _popup.closed || typeof _popup.closed=='undefined') {
													alertify.alert([[#{msg.common.window.allowpopup}]], function(){});
												}
											} else {
												_popup.close();
												_popup = window.open("/oss/osssyncpopup?"+_encUrl, "ossSyncViewPopup_"+ossName, "width=1000, height=700, toolbar=no, location=no, left=100, top=100");
											}
										}
									},
									error : function(){
										alertify.error([[#{msg.common.valid2}]], 0);
									}
								});
							}
						},
						error : function(){
							alertify.error([[#{msg.common.valid2}]], 0);
						}
					});
				}
			});
		}			
	};
	
	//커스터마이징 자동완성 셀렉트
	function setCustomAutoComplete(div){
		var selected = false;
		if(div == 'single'){
			$( '.autoComOssLicense' ).autocomplete({
				source: licenseTags,
				select: function( event, ui ) {
					var target = $(this).attr("id");

					if(target == "licenseName"){
						$("#licenseName").parent().find("span.retxt:first").hide();
						var licenseName = ui.item.shortIdentifier.length > 0 ? ui.item.shortIdentifier : ui.item.licenseName;
						$('#licenseName').val(licenseName);
						showLicenseText(licenseName);
						
						return false;
					}
				},
				minLength: 0,
				open: function() {
					$(this).attr('state', 'open');
					selected = false;
					
				},
				close: function () {
					$(this).attr('state', 'closed');
					var _item = checkLicenseSelected($(this).val());
					var target = $(this).attr("id");
					
					// detected License
					$(this).parent().next("span.retxt:first").empty();
					detectedLicenseValid = true; // reset
					
					if(_item != null){
						var licenseName = _item.shortIdentifier.length > 0 ? _item.shortIdentifier : _item.licenseName;
						$(this).val(licenseName);
						selected = true;
					} else {
						var value = $(this).val();
						
						if(value != ""){
							$(this).parent().next("span.retxt:first").html([[#{msg.oss.unknown.license}]]).show();
							detectedLicenseValid = false;
						}
					}
				}
		    })
		    .focus(function() {if ($(this).attr('state') != 'open') {$(this).autocomplete("search");}})
		    .autocomplete( "instance" )._renderItem = function( ul, item ) {
		    	return $( "<li>" )
		    	.append( "<div>" + item.label + "<strong> (" + item.licenseType + ") </strong>" + item.obligation + item.restriction + "</div>" )
		    	.appendTo( ul );
		    };
    	}else if(div == 'multi'){
    		$('#'+lastsel+'_licenseNameEx').autocomplete({
				source: licenseTags,
				select: function( event, ui ) {
					var licenseName = ui.item.shortIdentifier.length > 0 ? ui.item.shortIdentifier : ui.item.licenseName;
					$('#'+lastsel+'_licenseNameEx').val(licenseName);
					$('#'+lastsel+' > td:eq(9)').text(licenseName); // licenseNameEx
					$('#'+lastsel+' > td:eq(7)').text(licenseName); // licenseName
					$('#'+lastsel+' > td:eq(10)').text(ui.item.licenseType); // licenseType
					$('#'+lastsel+' > td:eq(11)').text(ui.item.obligationChecks); // obligationChecks
					$('#'+lastsel+' > td:eq(8)').text(ui.item.licenseId); // licenseId
					showLicenseText(licenseName);
					gLicenseData[lastsel] = "Y";
					return false;
				},
		   		minLength: 0,
		   		open: function() {
					$(this).attr('state', 'open');
					selected = false;
				},
				change: function(){
					gLicenseData[lastsel] = "N";
				},
				close: function () { 
					$(this).attr('state', 'closed');
					var _item = checkLicenseSelected($(this).val());
					var gridStr = "_licenseChoice";
					$("div.retxt._licenseChoice_"+lastsel).remove();
					if(_item == null) {
						$("#"+lastsel+"_licenseNameEx").after('<div class=\"'+gridStr+"_"+lastsel+' retxt\">'+ [[#{msg.oss.unknown.license}]] +'</div>');
						$("div.retxt._licenseChoice_"+lastsel).show();
					} else {
						var licenseName = _item.shortIdentifier.length > 0 ? _item.shortIdentifier : _item.licenseName; 
						$('#'+lastsel+'_licenseNameEx').val(licenseName);
						// 리스트 설정
						$('#_licenseChoice').jqGrid('saveRow',lastsel);
						var list = [];
						data.copyData ? list = data.copyData.ossLicenses : list = data.list.rows;
						var rowData = $('#_licenseChoice').jqGrid('getRowData', lastsel);
						rowData['licenseId'] = _item.licenseId;
						rowData['licenseName'] = _item.licenseName;
						rowData['licenseNameEx'] = licenseName;
						rowData['licenseType'] = _item.licenseType;
						rowData['obligation'] = _item.obligation;
						rowData['obligationChecks'] = _item.obligationChecks;
						rowData['ossLicenseIdx'] = lastsel;
						rowData['no'] = lastsel;
						
						list.forEach(function(row,index){
							if(row.ossLicenseIdx == lastsel ){
								list.splice(index,1,rowData);
							};
						});
						
						$('#_licenseChoice').jqGrid('editRow',lastsel);
						// 첫 로우 ossLicenseComb 설정
						changeLicenseType();
						setFristComb();
						selected = true;
					}
				}
		    })
		    .focus(function() {if ($(this).attr('state') != 'open') {$(this).autocomplete("search");}})
		    .autocomplete( "instance" )._renderItem = function( ul, item ) {
		    	return $( "<li>" )
		    	.append( "<div>" + item.label + "<strong> (" + item.licenseType + ") </strong>" + item.obligation  + item.restriction + "</div>" )
		    	.appendTo( ul );
		    };
    	}
	}
	
	function checkLicenseSelected(val) {
		if(val == "") {
			return null;
		}
		
		val = val.toUpperCase().trim();
		
		for (var idx = 0; idx < licenseTags.length; idx++) {
			if (licenseTags[idx].licenseName.toUpperCase().trim() == val || licenseTags[idx].shortIdentifier.toUpperCase().trim() == val) {
				return licenseTags[idx];
			}
		}
		
		return null;
	}
	
	
	$(document).ready(function () {
		'use strict';
//		$('span[title]').qtip();
		
		evt.init();
		data.init();
		
		if ($('input[name=ossId]').val()) {
			fn_comment.getCommentList(commentsParam);
		}
		
		$("#btnShowLicenseText").click(function() {
			if($(this).val() == "Show license text") {
				$(this).val("Hide license text");
				$("#disp_licenseText").show();
				showLicenseText();
			} else {
				$(this).val("Show license text");
				$("#disp_licenseText").hide();
			}
		});
		
		$('#listSearch').on('submit', function(e){
			return false;
		}).on('keypress', function(e){
			if((e.keyCode || e.which) == 13){
				$('.search').trigger('click');	// 검색 엔터
			}
		});
		
		if (data.components == null){
			$('#_projectList').parent().parent().hide();
		}

		if (data.componentsPartner == null){
			$('#_partnerList').parent().parent().hide();
		}
		
		//자동완성 데이터 리스트 가져오기
		commonAjax.getLicenseTags().success(function(data, status, headers, config){
			if(data != null){
				data.forEach(function(obj){
					var tag ={
						value : obj.licenseName,
						licenseId : obj.licenseId,
						label : obj.shortIdentifier.length > 0 ? obj.licenseName+' ('+obj.shortIdentifier+')' : obj.licenseName,
						licenseName : obj.licenseName,
						shortIdentifier : obj.shortIdentifier,
						licenseType : obj.licenseType,
						obligation : obj.obligation,
						obligationChecks : obj.obligationChecks
						,obligationCode : obj.obligationCode
						,licenseTypeVal : obj.licenseTypeVal
						,restriction : obj.restriction
					}
					
					licenseTags.push(tag);
				});
			}
		});
		
		//자동완성 Single License 일때
		setCustomAutoComplete('single'); 
		
		var list = [];
		
		if (data.copyData) {
			list = data.copyData.ossLicenses;
			$('#copy').hide();
			$('#delete').hide();
			$('input[name=ossCopyFlag]').val("Y");
		} else {
			if (data.list != null && typeof data.list.rows !== "undefined") {
				list = data.list.rows;
			}
		}
		
		// 라이센스 그리드
		var _licenseChoice = $('#_licenseChoice');
		_licenseChoice.jqGrid({
			datatype: 'local',
			data:list,
			colNames:['','','','License', 'Copyright', '','','','','license Type', 'obligationChecks'],
			colModel:[
				{name:'no', index: 'ossLicenseIdx', width:30, hidden:true},
				{name:'ossLicenseIdx', index: 'ossLicenseIdx', width:30, key:true, hidden:true},
				{name:'ossLicenseComb',index:'ossLicenseComb', width:70, align:"center", sortable:false, editable:true, edittype:"select", editoptions:{value:"AND:AND;OR:OR", dataEvents:[{type:'change', fn:changeLicenseType}]}},
				{name:'licenseNameEx',index:'licenseNameEx', width:150, editable:true, editoptions: {
                        dataInit: function (elem) {
                            $(elem).focus(function () {
                                setCustomAutoComplete('multi');
                            })
                        }
                    }
                },
				{name:'ossCopyright',index:'ossCopyright', width:250, editable:true, edittype:"textarea", editoptions:{rows:"10",cols:"50"}},
				{name: 'delete', index: 'delete', width:80, align: 'center', sortable:false, formatter: displayButtons},
				{name:'licenseName',index:'licenseName', width:50, hidden:true},
				{name:'licenseId',index:'licenseId', width:50, hidden:true},
				{name:'licenseNameEx',index:'licenseNameOrg', width:50,hidden:true},
				{name:'licenseType',index:'licenseType', width:50,hidden:true},
				{name:'obligationChecks',index:'obligationChecks', width:50,hidden:true}
			],
			autoencode: true,
			editurl:'clientArray',
			pager: '#_licenseChoicePager',
			autowidth: true,
			height: 'auto',
			gridview: true,
			rownumbers: true,
			viewrecords: true,
			loadonce:true,
			onSelectRow: function(rowid){
				// 로울 클릭시 그리드 에러 메세지 삭제 
				$("div.retxt._licenseChoice_"+rowid).remove();
				// 현재 로우와 라스트 로우가 다를시
				showLicenseText();
				if(rowid && rowid!==lastsel){
					_licenseChoice.jqGrid('saveRow',lastsel);
					
					// license 존재 여부 체크
					//라이센스 묶음 텍스트 출력
					createMultiLicenseText();
					// 라이센스 배경색 설정
					var list = [];
					data.copyData ? list = data.copyData.ossLicenses : list = data.list.rows;
					list.forEach(function(row,index){
						if(row.ossLicenseIdx == lastsel ){
							row.ossLicenseComb = $('#_licenseChoice').jqGrid('getCell',lastsel,'ossLicenseComb');
						};
					});
					makeBackGroundColor();
					// 로우 에디트
					_licenseChoice.jqGrid('editRow',rowid);
					lastsel=rowid;
					// 첫 로우 ossLicenseComb 설정
					setFristComb();
					//커스터마이징 자동완성 셀렉트
					setCustomAutoComplete('multi');
					//라이센스 타입 및 Obligation 자동 체크
					var type = autoLicense(list);
					var obligationHtml = autoObligation(list);
					
					if (list.length == 0) {
						type='';
						obligationHtml='';
					}
					
					if ('' != type) {
						$('#ltDiv').html('<span style="cursor: none; width: 150px;" class="btn btn-block btn-light btn-sm">' + type + '</span>');
					} else {
						$('#ltDiv').html(type);
					}
					
					$('#obDiv').html('');
					$(obligationHtml).appendTo('#obDiv');

				}
			},
			afterInsertRow:function(rowid, rowdata, rowelem){
			},
			loadComplete:function(data){
				lastsel = -1;
				// 페이징 UI 설정
				hidePageNav('_licenseChoicePager');
				// 첫 로우 ossLicenseComb 설정
				setFristComb();
				// 라이센스 묶음 텍스트 출력
				createMultiLicenseText();
				// 라이센스 배경색 설정
				makeBackGroundColor();
				//라이센스 타입 및 Obligation 자동 체크
				var type = autoLicense(list);
				var obligationHtml = autoObligation(list);
				
				if (list.length == 0) {
					type='';
					obligationHtml='';
				}
				
				if ('' != type) {
					$('#ltDiv').html('<span style="cursor: none; width: 150px;" class="btn btn-block btn-light btn-sm">' + type + '</span>');
				} else {
					$('#ltDiv').html(type);
				}
				
				$('#obDiv').html('');
				$(obligationHtml).appendTo('#obDiv');
			}
		});

        if(isReadOnly == null) {
            _licenseChoice.jqGrid('navGrid',"#_licenseChoicePager",{edit:false,add:true,del:false,search:false,refresh:false
                , addfunc: function (rowid) {
                    var ids = $("#_licenseChoice").jqGrid("getDataIDs");
                    var newId = ids.length ? Number(ids[ids.length-1])+1 : 1;
                    var row = {no	:newId, ossLicenseIdx	:newId};

                    data.list.rows.push(row);
                    $("#_licenseChoice").jqGrid("addRowData", newId , row, "last");
                    $("#_licenseChoice").jqGrid("setSelection", newId);

                    // 첫 로우 ossLicenseComb 설정
                    setFristComb();
                }
            });
        }
		
		// 프로젝트 그리드
		if (data.components != null){
			$("#_projectList").jqGrid({
				datatype: 'local',
				data: data.components,
				colNames:['ID','Project Name', 'Project Version', 'oldsystem'],
				colModel:[
					{name:'prjId',index:'prjId', width:70, sortable:false, align:"center", key:true},
					{name:'prjName',index:'prjName', width:400, sortable:false},
					{name:'prjVersion',index:'prjVersion', width:100, sortable:false, align:"center"},
					{name:'oldSystemFlag',index:'oldSystemFlag', hidden:true}
				],
				rowNum:100,
				viewrecords: true,
				height: 'auto',
				ondblClickRow: function(rowid,iRow,iCol,e) {
					var rowData = $("#_projectList").jqGrid('getRowData',rowid);
					if("Y" != rowData.oldSystemFlag) {
						createTabInFrame(rowData['prjId']+'_Project','/project/edit/'+rowData['prjId']);
					}
				},
				loadComplete: function(data) {
					if(data.records > 0) {
						var multRowIds = []; 
						var rowIdx = 0, rows = this.rows, rowsCount = rows.length, row, rowid, rowData, className;
						for(var _idx=0;_idx<rowsCount;_idx++) {
							row = rows[_idx];
							className = row.className;
							if (className.indexOf('jqgrow') !== -1) {
								rowid = row.id;
								rowData = data.rows[rowIdx++];
								if(rowData.oldSystemFlag == "Y") {
									className = className + ' excludeRow';
								}
								row.className = className;
							} else if(className.indexOf('ui-subgrid') !== -1){
								rowIdx++;
							}
						}
					}
				}
			});
		}
		
		// partner 그리드
		if (data.componentsPartner != null){
			$("#_partnerList").jqGrid({
				datatype: 'local',
				data: data.componentsPartner,
				colNames:['ID','Partner Name', '3rd Party Software Name', '3rd Party Software Version'],
				colModel:[
					{name:'partnerId',index:'partnerId', width:70, sortable:false, align:"center", key:true},
					{name:'partnerName',index:'partnerName', width:300, sortable:false},
					{name:'softwareName',index:'softwareName', width:200, sortable:false, align:"center"},
					{name:'softwareVersion',index:'softwareVersion', width:200, sortable:false, align:"center"}
				],
				rowNum:100,
				viewrecords: true,
				height: 'auto',
				ondblClickRow: function(rowid,iRow,iCol,e) {
					var rowData = $("#_partnerList").jqGrid('getRowData',rowid);
					var rowKey = rowData['partnerId'];
					
					createTabInFrame(rowKey+'_3rdParty', '/partner/edit/'+rowKey);
					
				},
				loadComplete: function(data) {
					// 3rd party는 old system에는 없는 기능 이므로 old system으로 인한 exclude row는 표시 할 수 없음.. 
				}
			});
		}

		// Vulnerability
		if (data.vulnInfoList != null) {
			$("#_vulnInfoList").jqGrid({
				datatype: 'local',
				data: data.vulnInfoList,
				colNames:['CVE ID','CVSS Score', 'Description', 'Published Date'],
				colModel:[
					{name:'cveId',index:'cveId', width:100, align:"center", formatter: cveIdTag, unformat: unCveIdTag},
					{name:'cvssScore',index:'cvssScore', width:80, align:"center", formatter:fn.displayVulnerability, sorttype: 'number'},
					{name:'vulnSummary',index:'vulnSummary', width:500, align:"left"},
					{name:'modiDate',index:'modiDate', width:100, align:"center", formatter:'date', formatoptions: {srcformat: 'Y-m-d H:i:s.t', newformat: 'Y-m-d'}}
				],
				rowNum: [[${@CommonFunction.getCoConstDefVal("DISP_PAGENATION_MAX")}]],
				sortname: 'cvssScore',
				viewrecords: true,
				loadonce: true,
				sortorder: "desc",
				height: 'auto',
				ondblClickRow: function(rowId) {
				},
				loadComplete: function() {
				}
			});
		}
		
		if ('' != [[${ossId}]]) {
			// oss 그리드
			$('#_ossSelectList').jqGrid({
				url:"/oss/ossPopupList/" + [[${ossId}]],
				datatype: 'json',
				jsonReader:{
					repeatitems: false,
					id:'ossId',
					root:function(obj){return obj.rows;},
					page:function(obj){return obj.page;},
					total:function(obj){return obj.total;},
					records:function(obj){return obj.records;}
				},
				colNames:['ID','OSS Name(Nick Name)', 'Version', 'OSS Name Temp'],
				colModel:[
					{name:'ossId', index: 'ossId', width:80, align:"center"},
					{name:'ossName',index:'ossName', width:470, align:"left"},
					{name:'ossVersion',index:'ossVersion', width:150, align:"center"},
					{name:'ossNameTemp',index:'ossNameTemp', align:"center", hidden:true}
				],
				autoencode: true,
				rowNum: 5,
				rowList: [5, 10, 15],
	 			autowidth: true,
				pager: '#ossSelectListPager',
				gridview: true,
				sortname: 'ossId',
				viewrecords: true,
				sortorder: 'desc',
				loadonce:false,
				height: 'auto',
				caption : 'Please select the open source you want to set as nickname.', 
				loadComplete: function(id){
					var ids = $('#_ossSelectList').jqGrid('getDataIDs');
					$.each(ids,function(idx,rowId){
						var rowData = $('#_ossSelectList').jqGrid("getRowData",rowId);
						if(rowData.ossId == [[${ossId}]]){
							$('#_ossSelectList').jqGrid("setRowData",rowId, false, {'background-color' : '#a9a9a9'});
						}
					})

                    $("#_ossSelectList").jqGrid("setGridWidth", 580, true);
				},
				onSelectRow: function(id){
	 				var rowData = $('#_ossSelectList').jqGrid('getRowData',id);
	 				if(rowData.ossId == [[${ossId}]]){
	 					alertify.alert([[#{msg.oss.cannot.select}]], function(){});
					}
				}
			});			
		}

		// comment history
		$('.btnCommentHistory').on('click', function(e){
			e.preventDefault();
			openCommentHistory("/comment/popup/oss/" + [[${ossId}]]);
		});
		
	});
	
	function cveIdTag(cellvalue, options, rowObject){
		var tag = "<a href='https://web.nvd.nist.gov/view/vuln/detail?vulnId="+cellvalue+"' class='urlLink' target='_blank'>"+cellvalue+"</a>";
		return tag;
	}
	
	function unCveIdTag(cellvalue, options, rowObject){
		return cellvalue;
	}
	
	// 그리드 첫 로우 ossLicenseComb 설정
	function setFristComb(){
		$('#_licenseChoice').find("tr").eq(1).find("td").eq(3).text("");
	}
	
	// 그리드 삭제 버튼 표출
	function displayButtons(cellvalue, options, rowObject){
        if(isReadOnly == null) {
            var deleted = "<input type=\"button\" value=\"delete\" class=\"btnCLight darkgray\" onclick=\"exeDelete("+options.rowId+")\" />";
        } else {
            var deleted = "";
        }

		return deleted;
	}
	
	// 그리드 삭제 버튼
	function exeDelete(rowId){
		// lastsel save
		$('#_licenseChoice').jqGrid('saveRow',lastsel);
		var list = [];
		data.copyData ? list = data.copyData.ossLicenses : list = data.list.rows;
		list.forEach(function(row,index){
			if(row.ossLicenseIdx == rowId ){
				list.splice(index,1);
			};
		});
		
		// 해당 리스트 삭제
		$('#_licenseChoice').jqGrid('delRowData', rowId);
		// 첫 로우 ossLicenseComb 설정
		setFristComb();
		makeBackGroundColor();
		
		//라이센스 타입 및 Obligation 자동 체크
		var type = autoLicense(list);
		var obligationHtml = autoObligation(list);
		if (list.length == 0) {
			type = '';
			obligationHtml = '';
		}
		
		if ('' != type) {
			$('#ltDiv').html('<span style="cursor: none; width: 150px;" class="btn btn-block btn-light btn-sm">' + type + '</span>');
		} else {
			$('#ltDiv').html(type);
		}
		
		$('#obDiv').html('');
		$(obligationHtml).appendTo('#obDiv');
		
		//라이센스 묶음 텍스트 출력
		createMultiLicenseText();
		lastsel=-1;
	}

	function getLicenseGroup(groups){
		var numbers = [];
		
		groups.forEach(function(group){
			var number = compareLicenseGroupMax(group);
			numbers.push(number);
		});

		return numbers;
	}
		
	//라이센스 우선순위 자동 계산
	function autoLicense(data){
		var licenseCount = 0;
		data.forEach(function(data){
			if(data.licenseName){
				licenseCount += 1;
			}
		})
		
		var result = '';
		if(licenseCount != 0){
			//1. 그룹별 분류하기
			var groups = distributeGroups(data);
			var numbers = getLicenseGroup(groups);
			
			//2. 각 그룹끼리 비교하기(OR 비교)
			if(numbers.length != 1){
 				var min = getMin(numbers);
 				switch(min){
					case 1:
						result = 'Permissive';
						$('#licenseType').val("PMS");
						break;
					case 2:
						result = 'Weak Copyleft';
						$('#licenseType').val("WCP");
						break;
					case 3:
						result = 'Copyleft';
						$('#licenseType').val("CP");
						break;
					case 4:
						result = 'Proprietary Free';
						$('#licenseType').val("PF");
						break;
					case 5:	
						result = 'Proprietary';
						$('#licenseType').val("NA");
						break;
				}
			} else {
 				var min = numbers[0];
 				switch(min){
					case 1:
						result = 'Permissive';
						$('#licenseType').val("PMS");
						break;
					case 2:
						result = 'Weak Copyleft';
						$('#licenseType').val("WCP");
						break;
					case 3:
						result = 'Copyleft';
						$('#licenseType').val("CP");
						break;
					case 4:
						result = 'Proprietary Free';
						$('#licenseType').val("PF");
						break;
					case 5:	
						result = 'Proprietary';
						$('#licenseType').val("NA");
						break;
				}
			}
		}
		return result;
	}
	
	//Obligation 우선순위 자동계산
	function autoObligation(data){
		var licenseCount = 0;
		data.forEach(function(data){
			if(data.licenseName){
				licenseCount += 1;
			}
		})
		var result = '';
		if(licenseCount != 0){
			//1. 그룹별 분류하기
			var groups = distributeGroups(data);
			var numbers = getLicenseGroup(groups);
			
			//2. 각 그룹끼리 비교하기(OR 비교)
			if(numbers.length != 1) {
 				var min = getMin(numbers);
 				var number = compareObligationGroupMax(groups[numbers.indexOf(min)]);
 				switch(number){
					case 1:
						result = '<span></span>';
						break;
					case 2:
						result = '<i class="far fa-file-alt fa-1-5x mr-2" title="Notice"></i> (Notice)';
						$('input[name=obligationType]').val("10");
						break;
					case 3:
						result = '<i class="far fa-file-alt fa-1-5x mr-2" title="Notice"></i> (Notice)  <i class="far fa-file-code fa-1-5x" title="Source Code"></i> (Source Code)';
						$('input[name=obligationType]').val("11");
						break;
				}
			} else {
 				var min = numbers[0];
 				var number = compareObligationGroupMax(groups[0]);
 				
 				switch(number){
					case 1:
						result = '<span></span>';
						break;
					case 2:
						result = '<i class="far fa-file-alt fa-1-5x mr-2" title="Notice"></i> (Notice)';
						$('input[name=obligationType]').val("10");
						break;
					case 3:
						result = '<i class="far fa-file-alt fa-1-5x mr-2" title="Notice"></i> (Notice)  <i class="far fa-file-code fa-1-5x" title="Source Code"></i> (Source Code)';
						$('input[name=obligationType]').val("11");
						break;
				}
			}
		}
		
		return result;
	}
	
	//AND그룹으로 묶어서 분류하기
	function distributeGroups(data){
		var type='A';
		var groups =[];
		var groupA =[];
		var groupB =[];
		
		data.forEach(function(item,index,ref){
			if(item.ossLicenseComb == 'AND' || item.ossLicenseComb =="") {
				if(groupA.length > 0) {	//AND - AND 배열 결속
					
				}
				
				if(groupB.length > 0) {	//OR - AND 배열 결속
					groupA.push(groupB[0]);
					groupB = [];
				}
				
				groupA.push(item);	
			} else if(item.ossLicenseComb == 'OR') {
				if(groupA.length > 0){	//AND - OR 배열 변경 (이전까지 등록된 배열을 그룹에 등록후 배열 초기화)
					groups.push(groupA);
					groupA = [];
				}
				
				if(groupB.length > 0){  //OR - OR 배열 변경 (바로 전 등록된 배열을 그룹에 등록후 배열 초기화)
					groups.push(groupB);
					groupB = [];
				}
				
				groupB.push(item);
			}
			
			if(index == ref.length-1){	//마지막 순서일 때 최종 등록
				if(groupA.length > 0){
					groups.push(groupA);
				}
				
				if(groupB.length > 0){
					groups.push(groupB);
				}
			}
		});
		
		return groups;
	}
	/*
		AND그룹 내 라이센스 우선순위 비교
		(AND - Copyleft > Weak Copyleft > Permissive)		
	*/
	function compareLicenseGroupMax(group){
		var max = 0;
		var constant = {
			'Permissive' 		: 1,
			'Weak Copyleft' 	: 2,
			'Copyleft'  		: 3,
			'Proprietary Free' 	: 4,
			'Proprietary' 		: 5
		};
		group.forEach(function(item,index,ref){
			if(max < constant[item.licenseType]){
				max = constant[item.licenseType];
			}
		});
		return max;
	}
	/*
		AND그룹 내 Obligation 우선순위 비교
		(AND - Copyleft > Weak Copyleft > Permissive)		
	*/
	function compareObligationGroupMax(group){
		var max = 0;
		var constant = {
			'NNY' : 1,
			'NNN' : 1,
			'YNY' : 2,
			'YNN' : 2,
			'YYY' : 3,
			'YYN' : 3
		};
		group.forEach(function(item,index,ref){
			if(max < constant[item.obligationChecks]){
				max = constant[item.obligationChecks];
			}
		});
		return max;
	}
	
 	//숫자배열 중 최소값 찾기(AND조건의 역순)
 	function getMin(numbers){
 		var min = 9;
 		numbers.forEach(function(number){
 			if(min > number ){
 				min = number;
 			}
 		});
 		return min;
 	}
	
	//숫자배열 중 최대값 찾기(AND조건의 역순)
	function getMax(numbers){
		var max = 0;
		numbers.forEach(function(number){
			if(max < number ){
				max = number;
			}
		});
		return max;
	}
	
	//save동작 처리
	function saveRow(){
		$('#_licenseChoice').jqGrid('saveRow', lastsel);
		$('#_licenseChoice').jqGrid('resetSelection');	// 셀렉트 해제
	}
	
	function changeLicenseType() {

		$('#_licenseChoice').jqGrid('saveRow',lastsel);
		//var list = data.list.rows;
		var list = $('#_licenseChoice').jqGrid('getRowData');
		var type = autoLicense(list);
		var obligationHtml = autoObligation(list);
		
		if (list.length == 0){
			type='';
			obligationHtml='';
		}
		
		if ('' != type) {
			$('#ltDiv').html('<span style="cursor: none; width: 150px;" class="btn btn-block btn-light btn-sm">' + type + '</span>');
		} else {
			$('#ltDiv').html(type);
		}
		
		$('#obDiv').html('');
		$(obligationHtml).appendTo('#obDiv');
		$('#_licenseChoice').jqGrid('editRow',lastsel);
	}
	
	
	//라이센스 묶음 처리
	function createMultiLicenseText(){
		var rows = $('#_licenseChoice').jqGrid('getRowData');
		var markTxt = '';
		
		rows.forEach(function(row, index, ref){
			 // row로 들어오는 데이터가 텍스트인지 element인지 확인.
			var olc = row.ossLicenseComb, lnm = row.licenseNameEx;
			var ossLicenseComb, licenseName;
			var url = '/license/edit/'+row.licenseId;

			ossLicenseComb = /<[a-z][\s\S]*>/i.test(olc) ? $("#" + $(olc).attr("id")).val() : olc;
			licenseName = /<[a-z][\s\S]*>/i.test(lnm) ? $("#" + $(lnm).attr("id")).val() : lnm;
			
			// mark 텍스트 그리기
			if(index!=0){
				markTxt += ' <span> '+ossLicenseComb+' </span> ';
			}
			
			markTxt+='<a href="#none" onclick=createTabInFrame("'+row.licenseId+'_License","'+url+'")>'+licenseName+'</a>';
		});
		
		var andTxts = markTxt.split('<span> OR </span>');
		
		markTxt = '';
		
		andTxts.forEach(function(andTxt, index, ref){
			var isAnd = andTxt.split('AND').length > 1;
			if(isAnd){
				markTxt += '('+andTxt+')';
			}else{
				markTxt += andTxt;
			}
			if(index != ref.length-1){
				markTxt += '<span> OR </span>';
			}
		});
		
		if(markTxt.split('OR').length == 1 && markTxt[0] =='(' && markTxt[markTxt.length-1] == ')'){
			markTxt = markTxt.substring(1,markTxt.length-1);
		}
		
		if(markTxt.indexOf('undefined') == -1){
			$('.licenseMulti .mark').html(markTxt);
		}
	}
	
	function getOssGridRows(elementId){
		var grid = $(elementId);
		var dataToSend = [];
		var rows = grid.jqGrid('getDataIDs');
		for(idx=0; idx < rows.length; idx++) {
			grid.jqGrid('saveRow', rows[idx]);
			var rowData = grid.jqGrid('getRowData', rows[idx]);
			dataToSend.push(rowData);
		}
		return dataToSend;
	}
	
	function validationDataSet(){
		var licenseDiv = "";
		var licenseChoiceLength = $("#_licenseChoice").jqGrid("getDataIDs").length;

		switch (licenseChoiceLength) {
			case 0:
				alertify.alert([[#{msg.oss.required.license}]], function(){});
				return false;
				break;
			case 1:
				licenseDiv = "S";
				break;
			default:
				licenseDiv = "M";
				break;
		}
		
		var rows = getOssGridRows('#_licenseChoice');
		
		$('input[name=licenseDiv]').val(licenseDiv);
				
		var dataIds = $('#_licenseChoice').jqGrid('getDataIDs');
		var newRows = [];
		var checkLicenses = [];
		dataIds.forEach(function(dataId){
			var rowData = $('#_licenseChoice').jqGrid('getRowData',dataId);
			var licenseName = rowData.licenseName;
			if( licenseName.indexOf('<div') > -1){
				rowData['licenseName'] = '';
			}
			checkLicenses.push(rowData.licenseNameEx);
			newRows.push(rowData);
		});
		
		$('input[name=ossLicensesJson]').val(JSON.stringify(newRows));
		
		var pattern = /\s/g;
		var patternFlag = false;
		var patternCheckFlag = false;
		$("[name='downloadLocations']").each(function(idx, cur){
			var value = $(cur).val().trim();
			$(cur).val(value);
			if (value.match(pattern)) {
				$(cur).parent().next("span.urltxt").empty();
				$(cur).parent().next("span.urltxt").css("display", "none");
				$(cur).parent().next().next("span.retxt").empty();
				$(cur).parent().next().next("span.retxt").html("Remove spaces").show();
				patternFlag = true;
				patternCheckFlag = true;
			}
		});
		if (patternFlag) alertify.error("DownloadLocation remove spaces", 0);
		patternFlag = false;
		$("[name='homepage']").each(function(idx, cur){
			var value = $(cur).val().trim();
			$(cur).val(value);
			if (value.match(pattern)) {
				$(cur).next("span.urltxt").empty();
				$(cur).next("span.urltxt").css("display", "none");
				$(cur).next().next("span.retxt").empty();
				$(cur).next().next("span.retxt").html("Remove spaces").show();
				patternFlag = true;
				patternCheckFlag = true;
			}
		});
		if (patternFlag) alertify.error("Homepage remove spaces", 0);
		if (patternCheckFlag) return false;
		
		var nicknameFormatErrorFlag = true;
		$("[name='ossNicknames']").each(function(idx, cur){
			var nickname = $(cur).val();
			
			if(nickname.indexOf(",") > -1){
				fn.checkNickName(cur);
				nicknameFormatErrorFlag = false;
			}
		});

		if(!nicknameFormatErrorFlag){
			alertify.alert("Formatting error", function(){});
			
			return false;
		}

		var duplicatedLicenseFlag = true;
 		if (checkLicenses.length > 0) {
 			$.each(checkLicenses, function(index, element){
 				$("[name='detectedLicenses']").each(function(idx, cur){
 	 				var detectedLicense = $(cur).val();
 	 				if (detectedLicense && element == detectedLicense) {
 	 					$('input[name=detectedLicenses]:eq('+idx+')').parent().next("span.retxt").html("License included in Declared").show();
 	 					duplicatedLicenseFlag = false;
 	 					return true;
 	 				}
 	 			});
 			});
 		}
	
 		if (!duplicatedLicenseFlag) {
 			alertify.error("License included in Declared", 0);
 			return false;
 		}
		
		return true;
	}
	
	//OSS등록로직
	function registSubmit(){
		if(validationDataSet()){
			$("#ossForm").ajaxForm({
				url :'/oss/validation',
	            type : 'POST',
	            dataType:"json",
	            cache : false,
		        success : onValidSuccess,
	            error : onError
		    }).submit();
		}
	}
	
	// OSS 삭제 체크 (기존에 CONF 상태로 등록된 OSS가 있는지 여부 검사)
	function checkExistOssConf(){
		var ossId = $('input[name=ossId]').val();
		
		$.ajax({
			url : '/oss/checkExistOssConf',
			type : 'GET',
			dataType : 'json',
			cache : false,
			data : {'ossId' : ossId},
			success : function(data){
				if (parseInt(data) > 0) {
					loading.hide();
					$('.ossSelectPop').show();
				} else if (parseInt(data) == 0) {
					deleteOssByOne();
				} else {
					loading.hide();
					alertify.error([[#{msg.common.valid2}]], 0);
				}
			},
			error : function(){
				loading.hide();
				alertify.error([[#{msg.common.valid2}]], 0);
			}
		});
	};	
	
	// OSS 삭제
	function deleteOssByOne(){
		var ossId = $('input[name=ossId]').val();
		var ossName = $('input[name=ossName]').val();
		var editorVal = $('#commentCont').next().find(".note-editable").html();

		var sendData = {
				ossId:ossId,
				ossName:ossName,
				newOssId:"N", // 단건일때 "N" 로 보냄 
				comment:editorVal
			};
			
		$.ajax({
			url :'/oss/delAjax',
            type : 'POST',
            data : sendData,
            dataType:"json",
            cache : false,
	        success : function(json){
	        	loading.hide();
				if (json.resCd == '10') {
					alertify.alert([[#{msg.common.success}]],function(){
						deleteTabInFrame('/oss/edit/'+ossId);
						reloadTabInframe('/oss/list');
					});
				} else {
					alertify.error([[#{msg.common.valid}]], 0);
				}
	        },
            error : function(){
            	loading.hide();
            	alertify.error([[#{msg.common.valid2}]], 0);
            }
		});
	};
	
	//V-Diff 체크
	function checkVdiff(func) {
		var rtnData = {};
		var rows = getOssGridRows('#_licenseChoice');
		var ossVersion = $('input[name=ossVersion]').val();
		var postData = {'ossId' : $('input[name=ossId]').val(), 'ossName' : $('input[name=ossName]').val(), 'license' : JSON.stringify(rows)};
		
		if ("save" == func && "" != ossVersion) {
			postData['ossVersion'] = ossVersion;
		}
		
		$.ajax({
			url : '/oss/checkVdiff',
			type : 'POST',
			data : JSON.stringify(postData),
			dataType : 'json',
			cache : false,
			async : false,
			contentType : 'application/json',
			success : function(json){
				rtnData = json.vFlag;
	        },
            error : function(){
            	alertify.error([[#{msg.common.valid2}]], 0);
            }
		});
		
		rtnData['ossVersion'] = ossVersion;
		return rtnData;
	};
	
	// 그리드 체크 메세지( gridStr 그리드 문자열 )
	function ossGridValidMsg(msgData,gridStr) {
		$.each(msgData,function(key,value) {
			if ("isValid" != key) {
				if (key.indexOf(".") > -1){
					if (key.indexOf("ossNicknames") > -1) {
						var _nickIndex = key.substring(key.lastIndexOf(".") +1, key.length) -1;
						$('input[name=ossNicknames]:eq('+_nickIndex+')').parent().next("span.retxt").html(value).show();
						$('input[name=ossNicknames]:eq('+_nickIndex+')').addClass("is-invalid");
					} else {
						var seqSuffix = key.split(".");
						var rowId = seqSuffix[1];
						// licenseId 일 경우 에러 메세지 타겟을 licenseNameEx 로 변경
						if(seqSuffix[0] === "licenseId"){
							seqSuffix[0] = "licenseNameEx";
						}
						var colName = $("#"+gridStr+" #"+rowId).parents("table").attr("id")+"_"+seqSuffix[0];
						// 그리드 메세지 그리기
						$("#"+gridStr+" #"+rowId+" td[aria-describedby=\""+colName+"\"]")
						.append('<div class=\"'+gridStr+"_"+rowId+' retxt"\">'+ value +'</div>');						
					}
					$("div.retxt").show();
				} else {
					if (key == 'ossNicknames'){
						$('input[name=ossNicknames]').parent().next("span.retxt").html(value).show();
						$('input[name=ossNicknames]').addClass("is-invalid");
					} else {
						if($('input[name='+key+']').length > 0) {
							$('input[name='+key+']').parent().next("div").find("span.retxt").html(value).show();
							$('input[name='+key+']').addClass("is-invalid");
						} else if($('textarea[name='+key+']').length > 0) {
							$('textarea[name='+key+']').next("span.retxt").html(value).show();
						} else if($('select[name='+k+']').length > 0) {
							$('select[name='+key+']').parent().siblings("span.retxt").html(value).show();
						}
					}
				}
				// 라셀 초기화
				lastsel = -1;
			}
		});
	};
	
	//유효성 체크 콜백함수
	function onValidSuccess(json, status){
		loading.hide();
		
		if(json.isValid == 'false') {
			if(json.validMsg == "hasDelNick") {
				// oss name을 변경하면서 nick name을 다시 확인 할 필요가 있는 경우
				
				// nick name 필드 초기화
				if ($("div.multiTxtSet > div").length > 1) {
					$("div.multiTxtSet").empty();
				}



				for (var k in json.resultData.addNickArr) {
                    console.log(json.resultData.addNickArr[k])
					let nickHtml 	= 	'<div class="col-2" style="margin-top: 5px;">';
					nickHtml 		+= 		'<div class="input-group card-tools">';
					nickHtml 		+=			'<input class="form-control" name="ossNicknames" type="text" value="'+json.resultData.addNickArr[k]+'"/>';
					nickHtml 		+=			'<button type="button" class="btn btn-tool" onclick="fn.removeTag(this);"><i class="fas fa-times"></i></button>';
					nickHtml 		+=		'</div>';
					nickHtml 		+=		'<span class="retxt"></span>';
					nickHtml 		+= 	'</div>';
					
					$('.multiTxtSet').append(nickHtml);
				}
				
				$('.smallDelete').on('click', function(){
					$(this).parent().remove();
				});
				
				var _alertMsg = [[#{msg.oss.nickname.exists}]];
				if(json.resultData.delNickArr) {
					_alertMsg += '<br/><br/><b>Removed Nick Name List</b><span style="text-decoration:line-through;">';
					for(var k in json.resultData.delNickArr) {
						_alertMsg += '<br/>' + json.resultData.delNickArr[k];
					}
					_alertMsg += '</span>';
				}
				
				alertify.alert(_alertMsg, function(){});
			} else if(json.validMsg == "rename"){
				if (typeof json.resultData !== 'undefined') {
					var data = json.resultData;
					var _alertMsg  = [[#{msg.oss.check.rename}]];
					for(var i in data){
						_alertMsg += '<br> - ' + data[i];
					}
					alertify.alert(_alertMsg, function(){});
				} else {
					alertify.alert('The OSS is the same, so it cannot be changed.', function(){});
				}
				
				renameFlag = 'N';
				$('input[name=renameFlag]').val(renameFlag);
			} else if(json.validMsg == "notChange"){
				alertify.alert([[#{msg.oss.name.nickname.sametime.notchange}]], function(){});
			} else if(json.resultData) {
				var _alertMsg  = [[#{msg.oss.nickname.exists}]];
					_alertMsg += '<br><br>' + 'When registering a new OSS or adding a version, it is not possible to delete the nickname of the existing OSS.';
				alertify.alert(_alertMsg, function(){});

				for(var k in json.resultData) {
					$(nickNameClone).appendTo('.multiTxtSet');
					$('.multiTxtSet input[type=text]:last').val(json.resultData[k]);
				}
				
				$('.smallDelete').on('click', function(){
					$(this).parent().remove();
				});
			} else if(json.validMsg == "deactivate"){
				alertify.error([[#{msg.oss.deactivated}]], 0);
			} else if(json.ossName == "Formatting error"){
				alertify.error([[#{msg.common.valid}]], 0);
				// 커스텀 에러 메세지 
				ossGridValidMsg(json, "_licenseChoice");
			} else {
				alertify.error([[#{msg.oss.duplicated}]], 0);
				// 커스텀 에러 메세지 
				ossGridValidMsg(json, "_licenseChoice");
			}
		} else if(json.isValid == 'true') {
			var data = checkVdiff('save');
			var v_flag = data.vFlag;
			
			if(v_flag == "Y"){
				if ("" != data.ossVersion) {
					if (typeof data.resultData != "undefined") {
						var checkList = data.resultData;
						var height = 0;
						let vDiffDiv = document.createElement('div');
						vDiffDiv.id = 'vDiffDiv';
						let h1 = document.createElement('h1');
						h1.innerHTML = [[#{msg.oss.confirm.ossVersion}]];
						vDiffDiv.appendChild(h1);
						vDiffDiv.appendChild(document.createElement('br'));
						height += 30;
						
						let table = document.createElement('table');
						table.style.width = '100%';
						$(table).css('border-collapse','collapse');
						let thead = document.createElement('thead');
						let tbody = document.createElement('tbody');
						
						let row_1 = document.createElement('tr');
						$(row_1).css('background-color','#a39d9b');
						row_1.style.height = "30";
						height += 30;
						
						let heading_1 = document.createElement('th');
						heading_1.style.border = '1px solid #444444';
						$(heading_1).css('font-weight','bold');
						$(heading_1).css('color','white');
						heading_1.innerHTML = "OSS Name (version)";
						
						let heading_2 = document.createElement('th');
						heading_2.style.border = '1px solid #444444';
						$(heading_2).css('font-weight','bold');
						$(heading_2).css('color','white');
						heading_2.innerHTML = "Declared License";
						
						row_1.appendChild(heading_1);
						row_1.appendChild(heading_2);
						
						thead.appendChild(row_1);
						table.appendChild(thead);
						
						for (var j in checkList) {
							var ossInfo = checkList[j].split("|")[0];
							var declaredLicense = checkList[j].split("|")[1];
							
							let row_2 = document.createElement('tr');
							row_2.style.height = "30";
							height += 30;
							
							let row_2_data_1 = document.createElement('td');
							row_2_data_1.style.border = '1px solid #444444';
							row_2_data_1.innerHTML = '&nbsp;' + ossInfo;
							
							let row_2_data_2 = document.createElement('td');
							row_2_data_2.style.border = '1px solid #444444';
							row_2_data_2.innerHTML = '&nbsp;' + declaredLicense;
							
							row_2.appendChild(row_2_data_1);
							row_2.appendChild(row_2_data_2);
							tbody.appendChild(row_2);
						}
						
						table.appendChild(tbody);
						vDiffDiv.appendChild(table);
						
						height = (height + 160) < 750 ? (height + 160) : 750;
						
						if (!alertify.firstVDiffDialog) {
							alertify.dialog('firstVDiffDialog', function() {
								var settings;
								
								return {
									setup: function() {
										var settings = alertify.confirm().settings;
										
										for (var prop in settings) {
											this.settings[prop] = settings[prop];
										}
										
										var setup = alertify.confirm().setup();
										
										setup.focus.element = 1;
										
										return setup;
									},
									settings: {
										oncontinue: null
									},
									callback: function(closeEvent) {
										alertify.confirm().callback.call(this, closeEvent);
									}
								};
							}, false, 'confirm');
							
							alertify.firstVDiffDialog(vDiffDiv)
							.set('onok', function(closeEvent){onRegist();})
							.set('oncancel', function(closeEvent){return;});
						} else {
							alertify.firstVDiffDialog(vDiffDiv)
							.set('onok', function(closeEvent){onRegist();})
							.set('oncancel', function(closeEvent){return;})
							.set('resizable', true).resizeTo('25%', height);
						}
					} else {
						onRegist();
					}
				} else {
					alertify.confirm([[#{msg.oss.confirm.ossVersion}]], function (e) {
						if (e) {
							onRegist();
						} else {
							return false;
						}
					});
				}
			} else if(v_flag == ""){
				alertify.error([[#{msg.common.valid2}]], 0);
				return;
			} else {
				onRegist();
			}
		}		
	};

	//유효성 체크 콜백함수
	function onDeleteValidSuccess(json, status){
		if(json.isValid == 'false') {
			loading.hide();
			
			if(json.validMsg == "hasDelNick") {
				// oss name을 변경하면서 nick name을 다시 확인 할 필요가 있는 경우
				
				// nick name 필드 초기화
				if($("div.multiTxtSet > div").length > 1) {
					$("div.multiTxtSet > div:not(:nth-child(1))").remove();
				}
				
				for(var k in json.resultData.addNickArr) {
					$(nickNameClone).appendTo('.multiTxtSet');
					$('.multiTxtSet input[type=text]:last').val(json.resultData.addNickArr[k]);
				}
				$('.smallDelete').on('click', function(){
					$(this).parent().remove();
				});
				var _alertMsg = [[#{msg.oss.nickname.exists}]];
				if(json.resultData.delNickArr) {
					_alertMsg += '<br/><br/><b>Removed Nick Name List</b><span style="text-decoration:line-through;">';
					for(var k in json.resultData.delNickArr) {
						_alertMsg += '<br/>' + json.resultData.delNickArr[k];
					}
					_alertMsg += '</span>';
				}
				alertify.alert(_alertMsg, function(){});
			} else if(json.resultData) {
				alertify.alert([[#{msg.oss.nickname.exists}]], function(){});
				for(var k in json.resultData) {
					$(nickNameClone).appendTo('.multiTxtSet');
					$('.multiTxtSet input[type=text]:last').val(json.resultData[k]);
				}
				$('.smallDelete').on('click', function(){
					$(this).parent().remove();
				});

			} else {
				alertify.error([[#{msg.common.valid}]], 0);
				// 커스텀 에러 메세지 
				ossGridValidMsg(json, "_licenseChoice");
			}

		} else if(json.isValid == 'true') {
			var v_flag = checkVdiff('delete');

			if (v_flag == "") {
				loading.hide();
				alertify.error([[#{msg.common.valid2}]], 0);
				return;
				
			} else {
				checkExistOssConf();
			}
		}		
	};
	
	//저장함수
	function onRegist(){
		loading.show();
		saveRow();
		var editorVal = $('#commentCont').next().find(".note-editable").html();
		$('input[name=comment]').val(replaceWithLink(editorVal));
		$("#ossForm").ajaxForm({
			url :'/oss/saveAjax',
            type : 'POST',
            dataType:"json",
            cache : false,
	        success : onRegistSuccess,
            error : onError
	    }).submit();
	};
	
	//등록성공콜백함수
	function onRegistSuccess(json, status){
		loading.hide();
		if(json.resCd == '10'){
			alertify.alert([[#{msg.common.success}]], function(){
				if(opener){
					// 현재 창이 팝업인 경우
					self.opener = null;self.close();
				} else {
					deleteTabInFrame('/oss/edit/'+json.ossId);
					reloadTabInframe('/oss/list');
				}
			});
		}else{
			alertify.error([[#{msg.common.valid2}]], 0);
			renameFlag = 'N';
			$('input[name=renameFlag]').val(renameFlag);
		}
	};
	
	// 색 설정
	function makeBackGroundColor(){
		var colors = [];
		var list = [];
		if (data.copyData) {
			list = data.copyData.ossLicenses;
		} else {
			if (data.list != null && typeof data.list.rows !== "undefined") {
				list = data.list.rows;
			}
		}
		
		var colorNames = [[${@CoCodeManager.getCodeNames(@CommonFunction.getCoConstDefVal("CD_LICENSE_BACKGROUND"))}]];
		for (var i in colorNames) {
			colors.push(colorNames[i]);
		}
		
		var lastColor = colors[0];
		for(var i=0; i<list.length; i++){
			var comb = list[i].ossLicenseComb;
			if(comb == 'AND'){
				$("#_licenseChoice").jqGrid("setRowData", list[i].ossLicenseIdx, false, {'background-color' : lastColor});
			}else if(comb == 'OR'){
				var flag = false;
				for(var j = 0; j<colors.length;j++){
					if(lastColor == colors[j]){
						lastColor = colors[j+1];
						$("#_licenseChoice").jqGrid("setRowData", list[i].ossLicenseIdx, false, {'background-color' : lastColor});
						flag = true;
					}else if(lastColor == colors[colors.length-1]){
						lastColor = colors[0];
						$("#_licenseChoice").jqGrid("setRowData", list[i].ossLicenseIdx, false, {'background-color' : lastColor});
						flag = true;
					}
					if(flag) break;
				}
			}
		}
	}
	
	function onPopupListSuccess(json, status){
		$('#_ossSelectList').jqGrid('clearGridData');
		$('#_ossSelectList').jqGrid('setGridParam',{data:json}).trigger('reloadGrid');
		
	}
	
	//에러엘럿
	function onError(data, status){
		alertify.error([[#{msg.common.valid2}]], 0);
		renameFlag = 'N';
		$('input[name=renameFlag]').val(renameFlag);
    };
    
	function showLicenseText(_licenseName) {
		if(!_licenseName) {
			var licenseChoiceLength = $("#_licenseChoice").jqGrid("getDataIDs").length;

			switch (licenseChoiceLength) {
				case 0:
					alertify.alert([[#{msg.oss.required.license}]], function(){});
					return false;
					break;
				case 1:
					$("input[name=licenseDiv]").val("S");
					break;
				default:
					$("input[name=licenseDiv]").val("M");
					break;
			}
		
			var _selectedRow = $("#_licenseChoice").jqGrid('getGridParam', "selrow" );
			if(_selectedRow) {
				var licenseNameEx = $('#_licenseChoice').jqGrid('getRowData',_selectedRow,'licenseNameOrg');
				licenseName = licenseNameEx['licenseNameEx'];
			} else {
				if($("#_licenseChoice").jqGrid("getDataIDs").length > 0) {
					_selectedRow = $("#_licenseChoice").jqGrid("getDataIDs")[0];
					licenseName = $('#_licenseChoice').jqGrid('getCell',_selectedRow,'licenseNameEx');
				}
			}
		} else {
			licenseName = _licenseName;
		}

		if(licenseName && licenseName != "") {
			$.ajax({
				url : '/license/getLicenseText',
				type : 'GET',
				dataType : 'json',
				cache : false,
				data : {licenseName : licenseName},
				success : function(data){
					if("false" != data.isValid) {
						$("#disp_licenseText").html(data.validMsg);
						licenseName = "";
					} else {
						$("#disp_licenseText").html("");
					}
				},
				error : function(){
					$("#disp_licenseText").html("");
				}
			});
		} else {
			$("#disp_licenseText").html("");
		}
	}


	// 다른 OSS로 이관하는 경우
	function mergeOssForDelete(newOssId) {
		$('.ossSelectPop').hide();
		$("#_ossMergeCheckList").jqGrid('GridUnload');
		$('.mergeOssCheckPop').show();
;
		$('#_ossMergeCheckList').jqGrid({
			url: `/oss/ossMergeCheckList/${ossId}/${newOssId}`,
			datatype: 'json',
			jsonReader:{
				repeatitems: false,
				id:'ossId',
				root:function(obj){return obj.rows;}
			},
			colNames:['ID', 'Merge', 'Version', 'License', 'License Type', 'Obligation', 'Copyright', 'Download Location', 'HomePage', 'delOssId'],
			colModel:[
				{name:'ossId', index: 'ossId', width:70, align:"center"},
				{name:'mergeStr', index: 'mergeStr', width:70, align:"center"},
				{name:'ossVersion',index:'ossVersion', width:80, align:"left"},
				{name:'licenseName',index:'licenseName', width:150, align:"left"},
				{name:'licenseType',index:'licenseType', width:80, align:"left"},
				{name:'obligation',index:'obligation', width:80, align:"left"},
				{name:'copyright',index:'copyright', width:150, align:"left"},
				{name:'downloadLocation',index:'downloadLocation', width:100, align:"left"},
				{name:'homepage',index:'homepage', width:100, align:"left"},
				{name:'delOssId',index:'delOssId', hidden:true}
			],
			autoencode: true,
			rowNum: 9999,
 			autowidth: true,
			gridview: true,
			sortname: 'ossVersion',
			viewrecords: true,
			sortorder: 'desc',
			loadonce:true,
			height: 'auto',
			loadComplete: function(id){
				$('#_ossMergeCheckList').jqGrid("setRowData",[[${ossId}]], false, {'background-color' : '#ada9a9'});
                $("#_ossMergeCheckList").jqGrid("setGridWidth", 560, true);
			},
			onSelectRow: function(id){
			},
			ondblClickRow: function(rowid,iRow,iCol,e) {
				// 체크 박스 영역 제외
				var row = $('#_ossMergeCheckList').jqGrid('getRowData', rowid);
				
				// 자기자신이 아닌 경우만
				if ('Duplicated' == row['mergeStr'] && row['delOssId'] && row['delOssId'] != [[${ossId}]]) {
					createTabInFrame(row['delOssId']+'_Opensource', '/oss/edit/'+row['delOssId']);
				}
				else if (row['ossId'] != [[${ossId}]]) {
					createTabInFrame(row['ossId']+'_Opensource', '/oss/edit/'+row['ossId']);
				}

			}
		});	
	}


	var fn_comment = {
    	getCommentList : function(param){
    		if (data.copyData) {
    			$('.commentList').remove();
        	} else {
        		$.ajax({
            		url : '/comment/getCusCommentList',
                	type : 'GET',
                	dataType : 'html',
                	cache : false,
                	data : param,
                	success : function(res){
                		$("#commentListBody").empty();
						$("#commentListBody").html(res);
                	},
                	error : function(xhr, ajaxOptions, thrownError){
                   		alertify.error([[#{msg.common.valid2}]], 0);
                	}
            	});
        	}
    	},
    	getMoreCommentsList : function() {
			commentsParam["moreFlag"] = "Y";
			fn_comment.getCommentList(commentsParam);
		},
		editComments : function(_commId, _referenceDiv, _referenceId) {
			$.ajax({
    			url : '/comment/getEditPopup',
				type : 'POST',
				data : {'commId' : _commId},
				dataType : 'html',
				cache : false,
				success : function(res){
					if(!alertify.editComments){
						alertify.dialog('editComments', function() {
							return {
								setup: function() {
									var settings = alertify.confirm().settings;
								
									for (var prop in settings) {
										this.settings[prop] = settings[prop];
									}
								
									var setup = alertify.confirm().setup();
									setup.buttons = [];
									setup.focus.element = 1;
								
									return setup;
								},
						    	hooks: {
						    		onshow: function() {
						        		this.elements.dialog.style.maxWidth = 'none';
						          		this.elements.dialog.style.width = '750px';
						        	}
								}
							};
						}, false, 'alert');
            		}
				
					alertify.editComments(res).set('title', 'Edit Comments');
					$("#updateComments").attr("onclick", "fn_comment.updateComments("+_commId+", "+_referenceDiv+", "+_referenceId+")");
					$("#commentEdit").summernote({minHeight: 200, maxHeight: 800, lang: "ko-KR"});
				}
    		});
		},
		updateComments : function (_commId, _referenceDiv, _referenceId) {
			if ("" == $("#commentEdit").next().find(".note-editable").text()) {
				alertify.alert("Please enter a comment", function(){});
				return false;
			} else {
				var param = {commId : _commId, contents : replaceWithLink($("#commentEdit").summernote('code')), referenceDiv: _referenceDiv, referenceId: _referenceId};
					$.ajax({
					url : '/comment/updateComment',
					type : 'POST',
					dataType : 'json',
					cache : false,
					data : param,
					success : function(json){
						alertify.success([[#{msg.common.success}]]);
						fn.closeAlertifyView();
						fn_comment.getCommentList(commentsParam);
					},
					error : function(){
						alertify.error([[#{msg.common.valid2}]], 0);
					}
				});
			}
		},
		deleteComments : function (_commId) {
			alertify.confirm("Are you sure you want to delete this comment?", function (e) {
				if (e) {
					$.ajax({
						url : '/comment/deleteComment',
						type : 'POST',
						dataType : 'json',
						cache : false,
						data : {'commId' : _commId},
						success : function(data){
							alertify.success([[#{msg.common.success}]]);
							fn.closeAlertifyView();
							fn_comment.getCommentList(commentsParam);
						},
						error : function(){
							alertify.error([[#{msg.common.valid2}]], 0);
						}
					});
				} else {
					return false;
				}
			});
		},
		closeAlertifyView : function () {
			fn.closeAlertifyView();
		}
	}

	var fn = {
		urlDuplication : function(target){
			var value = $(target).val().trim();
			$(target).val(value);
			
			if (value.charAt(value.length-1) == "/"){
				value = value.slice(0, -1); // 마지막 문자열 제거
				$(target).val(value);
			}
		
			var pattern = /\s/g;
			if (value.match(pattern)) {
				$(target).parent().next("span.urltxt").empty();
				$(target).parent().next("span.urltxt").css("display", "none");
				$(target).parent().next().next("span.retxt").empty();
				$(target).parent().next().next("span.retxt").html("Remove spaces").show();
			} else {
				$(target).parent().next().next("span.retxt").empty();
				$(target).parent().next().next("span.retxt").css("display", "none");
				
				$("input[name=validationType]").val('DOWNLOADLOCATION');
	    		$("[name='downloadLocation']").val(value);
				$("#ossForm").ajaxForm({
					url :'/oss/urlDuplicateValidation',
	            	type : 'POST',
	            	dataType:"json",
	           	 	cache : false,
		        	success : function(json) {
		        		if (json.externalData2) {
		        			if (typeof json.externalData2.downloadLocation !== 'undefined') {
			        			var downloadLocation = json.externalData2.downloadLocation;
			        			if (downloadLocation.indexOf("createTabInFrame") > -1) {
			        				downloadLocation = downloadLocation.replaceAll("createTabInFrame", "fn.loadUrl");
			        			}
			        		
			        			$(target).parent().next("span.urltxt").empty();
			        			$(target).parent().next("span.urltxt").html(downloadLocation).show();
			        			$(target).addClass("is-warning");
			        		}
		        		} else {
			        		$(target).parent().next("span.urltxt").empty();
		        		}
		        	},
	            	error : onError
		    	}).submit();
			}
		},
		urlDuplicationAll : function(){
			var pattern = /\s/g;
			var patternCnt = 0;
			
			$("[name='downloadLocations']").each(function(idx, cur){
				var value = $(cur).val().trim();
				$(cur).val(value);
				
				if (value.charAt(value.length-1) == "/"){
					value = value.slice(0, -1); // 마지막 문자열 제거
					$(target).val(value);
				}
				
				if (value.match(pattern)) {
					patternCnt++;
					$(cur).parent().next("span.urltxt").empty();
					$(cur).parent().next("span.urltxt").css("display", "none");
					$(cur).parent().next().next("span.retxt").empty();
					$(cur).parent().next().next("span.retxt").html("Remove spaces");
				}
			});
			
			if (patternCnt == 0) {
				$("input[name=validationType]").val('DOWNLOADLOCATIONS');
				$("#ossForm").ajaxForm({
					url :'/oss/urlDuplicateValidation',
	            	type : 'POST',
	           		dataType:"json",
	            	cache : false,
		        	success : function(json) {
		        		if (json.externalData2){
		        			var diffMsg = json.externalData2.downloadLocations.split("||");
						
							$("[name='downloadLocations']").each(function(idx, cur){
								var downloadLocation = $(cur).val();
								var msg = diffMsg.filter(function(a){
						        	return a.indexOf(downloadLocation) > -1;
						    	})[0];
							
								if(msg){
									msg = msg.split("@@")[1];
									var downloadLocation = msg.replaceAll("createTabInFrame", "fn.loadUrl");
									$(cur).parent().next("span.retxt").empty();
									$(cur).parent().next("span.urltxt").empty();
									$(cur).parent().next("span.urltxt").html(downloadLocation).show();
									$(cur).addClass("is-warning");
								}						
							});
						
		        		} else {
		        			$(".multiDownloadLocationSet > div > span.urltxt").empty();
		        		}
		        	
		        		fn.homepageDuplication($('input[name=homepage]'));
		        	},
	            	error : onError
		    	}).submit();
			}
		},
		homepageDuplication : function(target){
			var value = $(target).val().trim();
			$(target).val(value);

			if (value.charAt(value.length-1) == "/"){
				value = value.slice(0, -1); // 마지막 문자열 제거
				$(target).val(value);
			}
			
			var pattern = /\s/g;
			if (value.match(pattern)) {
				$(target).next("span.urltxt").empty();
				$(target).next("span.urltxt").css("display", "none");
				$(target).next().next("span.retxt").empty();
				$(target).next().next("span.retxt").html("Remove spaces").show();
			} else {
				$(target).next().next("span.retxt").empty();
				$(target).next().next("span.retxt").css("display", "none");
				
				$("input[name=validationType]").val('HOMEPAGE');
				
				$("#ossForm").ajaxForm({
					url :'/oss/urlDuplicateValidation',
	            	type : 'POST',
	            	dataType:"json",
	            	cache : false,
		        	success : function(json) {
		        		if (json.externalData2) {
		        			if (typeof json.externalData2.homepage !== 'undefined') {
		        				var homepageHtml = json.externalData2.homepage;
			        			if (homepageHtml.indexOf("createTabInFrame") > -1) {
			        				homepageHtml = homepageHtml.replaceAll("createTabInFrame", "fn.loadUrl");
			        			}
			        		
			        			$(target).parent().next().children().empty();
								$(target).parent().next().children().html(homepageHtml).show();
								$(target).addClass("is-warning");
		        			}
		        		} else {
							$(target).parent().next().children().empty();
		        		}
		        	},
	            	error : onError
		    	}).submit();
			}
		},
		checkValid : function(){
			var result = gLicenseData.filter(function(a){
				return a == "N";
			});
		
			if (result.length > 0){
				alertify.alert([[#{msg.oss.required.auto}]], function(){});
				return false;
			}
			return true;
		},
		checkNickName : function(target){
			var targetVal = $(target).val();

			if(targetVal.indexOf(",") > -1){
				$(target).parent().next("span.retxt").html("Formatting error").show();
			} else {
				$(target).parent().next("span.retxt").hide();
			}
		},
		replaceGetParamChar : function(_param) {
			_param = _param.replace(/&/g,"%26");
			_param = _param.replace(/\+/g,"%2B"); 
			return _param;
		},
		save : function() {
			if(fn.checkValid()){
				// 폼 에러 메세지 숨기기
				$("span.retxt").hide();
				// 그리드 에러 메세지 지우기
				$("div.retxt").remove();
				// remove input error class
				$("input").removeClass("is-invalid");
			
				// 멀티 일경우 라이센스는 1건 이상이어야 한다.
				var licenseDiv = "";
				var licenseChoiceLength = $("#_licenseChoice").jqGrid("getDataIDs").length;

				switch (licenseChoiceLength) {
					case 0:
						alertify.alert([[#{msg.oss.required.license}]], function(){});
						return false;
						break;
					case 1:
						$("input[name=licenseDiv]").val("S");
						licenseDiv = "S";
						break;
					default:
						$("input[name=licenseDiv]").val("M");
						licenseDiv = "M";
						break;
				}

				var rows = getOssGridRows('#_licenseChoice');
				var dataIds = $('#_licenseChoice').jqGrid('getDataIDs');
				var gridStr = "_licenseChoice";
				var jsValidResult = true;
		
				dataIds.forEach(function(dataId){
					var rowData = $('#_licenseChoice').jqGrid('getRowData',dataId);
					var licenseName = rowData.licenseNameEx;

					if (checkLicenseSelected(licenseName) == null) {
						var errRow = $("#"+gridStr+" #"+dataId+" td[aria-describedby='"+gridStr + "_licenseNameEx']");

						if (errRow) {
							errRow.append('<div class=\"'+gridStr+"_"+dataId+' retxt"\">'+ [[#{msg.oss.unknown.license}]] +'</div>');
						}

						$("div.retxt._licenseChoice_"+dataId).show();
					
						jsValidResult = false;
					}
				});
			
				if (!jsValidResult || !detectedLicenseValid) {
					alertify.error([[#{msg.common.valid}]], 0);
					$("span.retxt").show();
				
					return false;
				}

				var editorVal = $('#commentCont').summernote('code');
				var localDeactivateFlag = $("[name='deactivateFlag']").val();

				if (editorVal == "") {
					if (deactivateFlag == "N" 
						&& localDeactivateFlag == "Y"){ // deactivate Flag checked
						alertify.alert([[#{msg.oss.required.deactivate}]], function(){});
						return false;
					}

					if (deactivateFlag == "Y" 
						&& localDeactivateFlag == "N"){ // deactivate Flag unchecked
						alertify.alert([[#{msg.oss.required.activate}]], function(){});
						return false;
					}
				}
			
			alertify.confirm([[#{msg.common.confirm.save}]], function (e) {
				if (e) {
					// 세이브 전 그리드 처리
					$('#_licenseChoice').jqGrid('saveRow',lastsel);
					
					// 최종 세이브 호출
					registSubmit();
				} else {
					return false;
				}
			});
		}
	},
	showOssViewPage : function (obj) {
		var ossName = $(obj).parent().next().find('input').val();
		var ossVersion = $(obj).parent().parent().next().next().find('input').val();
		fn.showDetailPopup(ossName, ossVersion);
	},
	loadUrl : function (target, url) {
		var ossNameObj = url.split("?")[1];
		var ossName = ossNameObj.split("=")[1];
		var ossVersion = $("input[name=ossVersion]").val();
		fn.showDetailPopup(ossName, ossVersion);
	},
	showDetailPopup : function (ossName, ossVersion) {
		if ("" != ossName) {
			var _popup = null;
			
			if ("N/A" == ossVersion) {
				ossVersion = "";
			}
			
			$.ajax({
				url : '/oss/checkExistsOssByname',
				type : 'GET',
				dataType : 'json',
				cache : false,
				data : {ossName : ossName},
				contentType : 'application/json',
				success : function(data){
					if(data.isValid == 'true') {
						if(_popup == null || _popup.closed) {
							_popup = window.open('/oss/osspopup?ossName='+ossName+'&ossVersion='+ossVersion, 'ossViewPopup_'+ossName, 'width=900, height=700, toolbar=no, location=no, left=100, top=100');

							if(!_popup || _popup.closed || typeof _popup.closed=='undefined') {
								alertify.alert([[#{msg.common.window.allowpopup}]], function(){});
							}
						} else {
							_popup.close();
							_popup = window.open('/oss/osspopup?ossName='+ossName+'&ossVersion='+ossVersion, 'ossViewPopup_'+ossName, 'width=900, height=700, toolbar=no, location=no, left=100, top=100');
						}
					} else {
						alertify.alert([[#{msg.selfcheck.info.unconfirmed.oss}]], function(){});
					}
				},
				error : function(){
					alertify.error([[#{msg.common.valid2}]], 0);
				}
			});
		}
	},
	removeTag : function(obj) {
		$(obj).parent().parent().remove();
	},
	displayVulnerability : function (cellvalue, options, rowObject) {
		var display = "";

        if (parseInt(cellvalue) >= 9.0) {
            display = "<span class=\"badge badge-dark\" style=\"cursor: pointer;\" title=\""+ cellvalue +"\" onclick=\"openNVD('" + rowObject.cveId + "')\">CRITICAL</span>";
        } else if (parseInt(cellvalue) >= 7.0) {
            display = "<span class=\"badge badge-danger\" style=\"cursor: pointer;\" title=\""+ cellvalue +"\" onclick=\"openNVD('" + rowObject.cveId + "')\">HIGH</span>";
        } else if (parseInt(cellvalue) >= 4.0) {
            display = "<span class=\"badge badge-orange\" style=\"cursor: pointer;\" title=\""+ cellvalue +"\" onclick=\"openNVD('" + rowObject.cveId + "')\">MEDIUM</span>";
        } else if (parseInt(cellvalue) > 0) {
            display = "<span class=\"badge badge-warning\" style=\"cursor: pointer;\" title=\""+ cellvalue +"\" onclick=\"openNVD('" + rowObject.cveId + "')\">LOW</span>";
        } else if (parseInt(cellvalue) == 0 || cellvalue == undefined) {
            display = "<span style=\"font-size:0;\"></span>";
        } else {
            display = cellvalue;
        }
		
        return display;
	},
	closeAlertifyView : function() {
		$(".ajs-close").trigger("click");
	}
}
</script>
</th:block>