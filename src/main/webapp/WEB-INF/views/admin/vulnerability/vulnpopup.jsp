<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ include file="/WEB-INF/constants.jsp"%>
<%-- 관리자 화면 템플릿 --%>
<!DOCTYPE html>
<html>
	<head>
		<tiles:insertAttribute name="meta" />
		<tiles:insertAttribute name="scripts" />
		<script type="text/javascript">
		var isPopup = '${ossInfo.isPopup}';
		var totalRow = 0;	// Total vulnerability count

		$(document).ready(function() {
			$('#loading_wrap_popup').show();
			grid_fn.loadGrid();
			evt_fn.init();

			/**
			 * Set max vulnerability count can be exported
			 * gRowCnt variable is set
			 */
			setMaxRowCnt("${
				ct:getCodeExpString(ct:getConstDef('CD_EXCEL_DOWNLOAD'),
				ct:getConstDef('CD_MAX_ROW_COUNT'))}");
			
			var ossVersion = '${ossInfo.ossVersion}';
			
			if(ossVersion == ""){
				ossVersion = "-";
			}
			
			window.setTimeout(function(){
				var params =  {ossName : '${ossInfo.ossName}', ossVersion : ossVersion, vulnType : '${ossInfo.vulnType}'};

				$("#_vulnList").jqGrid('setGridParam', {postData:params, page : 1, url:'<c:url value="/vulnerability/getVulnList"/>'}).trigger('reloadGrid');
			}, 1000);
		});

		var grid_fn = {
			oldRowNum : 200,
			loadGrid : function(){
				$('#loading_wrap_popup').show();
				
				$('#_vulnList').jqGrid({
					datatype: 'json',
					jsonReader:{
						repeatitems: false,
						id:'ossId',
						root:function(obj){
							//기존의 RowNum 저장
							grid_fn.oldRowNum = +$(".ui-pg-selbox").val();
							
							//리스트 갯수에 따른 rowNum 변경
							$("#_vulnList").jqGrid('setGridParam', {rowNum:grid_fn.oldRowNum});
							$("#_vulnList").jqGrid('setGridParam', {defaultRowNum:grid_fn.oldRowNum});
							
							return obj.rows; 
						},
						page:function(obj){return obj.page;},
						total:function(obj){return obj.total;},
						records:function(obj){return obj.records;}
					},
					colNames: ['OSS Name', 'Version', 'Score', 'CVE ID', 'Modified Date', 'VulnSummary'],
					colModel: [
						{name: 'product', index: 'product', width: 80, align: 'left', template: searchStringOptions, hidden:false},
						{name: 'version', index: 'version', width: 60, align: 'left', template: searchStringOptions,  
							sorttype: function (cell, rowData) {
								var rtnVal = rowData.version;
								
								if(rtnVal.indexOf(".") > -1) {
									var rtnValTemp = rtnVal.substring(0, rtnVal.indexOf("."));
									var rtnValTemp2 = rtnVal.substring(rtnVal.indexOf(".")).replace(/\./g, '');

									rtnVal = LPAD(rtnValTemp, '0', 30) + "." + rtnValTemp2;
								} else {
									rtnVal = LPAD(rtnVal, '0', 30) + ".0";
								}
								
					            return rtnVal;
	                        }, hidden:false},
						{name: 'cvssScore', index: 'cvssScore', width: 30, align: 'center', sorttype: 'int', template: searchStringOptions},
						{name: 'cveId', index: 'cveId', width: 60, align: 'left', formatter: cveIdTag, unformat: unCveIdTag, template: searchStringOptions},
						{name: 'modiDate', index: 'modiDate', width: 40, align: 'left', formatter:'date', template: searchStringOptions, formatoptions: {srcformat: 'Y-m-d H:i:s.t', newformat: 'Y-m-d'}},
						{name: 'vulnSummary', index: 'vulnSummary', hidden:true},
					],
					onSelectRow: function(rowid,status,eventObject){
						var object = $("#_vulnList").jqGrid('getRowData', rowid);
						var result = "<ol>";
								result += "<li>ㆍ<b>CVE ID</b> : " + object.cveId+"</li>";
								result += "<li>ㆍ<b>Description</b> : " + object.vulnSummary+"</li>";
							result += "</ol>";
							
						$("#vulnDescInfo").html(result);
					},
					autoencode: true,
					autowidth: true,
					gridview: true,
					loadonce: false,
					height: 'auto',
					rowNum:${ct:getConstDef("DISP_PAGENATION_MAX")},
					sortname: 'cvssScore',
					sortorder: 'desc',
					rownumbers: true,
					rownumWidth:35,
					pager: '#vulnPager',
					rowNum: 200,
					rowList: [200, 500, 1000, 5000],
					loadComplete: function(data){
						$('#loading_wrap_popup').hide();
						
						if(data.records > 0) {
							var rowIdx = 0, rows = this.rows, rowsCount = rows.length, row, rowid, rowData, className;

							for(var _idx=0;_idx<rowsCount;_idx++) {
								row = rows[_idx];
								className = row.className;

								if (className.indexOf('jqgrow') !== -1) {
									rowid = row.id;
									$('#_vulnList').jqGrid("setSelection", rowid);

									break;
								}
							}
						}

						totalRow = data.records;	//Set searched vulnerabilities count
						$("#vulnPager_right").html('<div dir="ltr" style="text-align:right" class="ui-paging-info">Total : '+ totalRow +'</div>');
					}
				});
				
				$('#_vulnList').jqGrid('filterToolbar', {stringResult: true, searchOnEnter: true, searchOperators: true, defaultSearch: "cn"});
				$('#_vulnList').closest(".ui-jqgrid-bdiv").css({"height":"350px", "overflow-y" : "scroll"});
			}
		}
		
		/* CVE_ID 에 링크 추가 */
		function cveIdTag(cellvalue, options, rowObject){
			return "<a href='https://web.nvd.nist.gov/view/vuln/detail?vulnId="+cellvalue+"' class='urlLink' target='_blank'>"+cellvalue+"</a>";
		}

		/* CVE_ID 에 링크 제거 */
		function unCveIdTag(cellvalue, options, rowObject){
			return cellvalue;
		}

		/* Exports vulnerability data with xlsx format */
		function downloadExcel() {
			const makeRequestData = function() {
				const searchData = $("#_vulnList").jqGrid('getGridParam','postData');
				const parameter = {
					ossName: searchData.ossName,
					ossVersion: searchData.ossVersion,
					sidx: searchData.sidx,
					sord: searchData.sord,
					vulnType: searchData.vulnType,
				};
				const type = "vulnerabilityPopup";

				return {"parameter": JSON.stringify(parameter), type};
			};

			if(isMaximumRowCheck(totalRow)){
				$('#loading_wrap_popup').show(); //Show loading layout

				$.ajax({
					type: "POST",
					url: '<c:url value="/exceldownload/getExcelPost"/>',
					data: JSON.stringify(makeRequestData()),
					dataType : 'json',
					cache : false,
					contentType : 'application/json',
					success: function(data) {
						if("false" == data.isValid) {
							if(data.validMsg == "overflow") {
								alertify.error(getMsgMaxRowCnt(), 0);
							} else {
								alertify.error('<spring:message code="msg.common.valid2" />', 0);
							}
						} else {
							window.location =  '<c:url value="/exceldownload/getFile?id='+data.validMsg+'"/>';
						}
					},
					error: function(data) {
						alertify.error('<spring:message code="msg.common.valid2" />', 0);
					},
					complete: function(data) {
						$('#loading_wrap_popup').hide(); //hide loading layout, when ajax request finished
					}
				});
			}
		}
		
		var evt_fn = {
			init : function(){
				$("span[class='ui-icon ui-icon-seek-first'], span[class='ui-icon ui-icon-seek-prev'], span[class='ui-icon ui-icon-seek-next'], span[class='ui-icon ui-icon-seek-end']")
					.on("click", function(){
					    $("#loading_wrap_popup").show()
					});
				
				$("#pg_pager .ui-pg-input").on("keypress", function(e){
					var keyCode = e.keyCode;
	
					if(keyCode == "13"){
						$("#loading_wrap_popup").show();
					}
				});
				
				$("#pg_pager .ui-pg-selbox").on("change", function(){
					$("#loading_wrap_popup").show();
				});
			}
		};
		</script>
	</head>
	<body>
		<div id="loading_wrap_popup" class="loading" style="display:none;">
			<div class="loadingBlind"></div>
			<img src="${ctxPath}/images/loading.gif" alt="loading" />
		</div>
		<div id="wrap" style="padding-top: 10px;">
			<div  align="center" >
			<div class="jqGridSet" style="width: 95%;">
				<table id="_vulnList"><tr><td></td></tr></table>
				<div id="vulnPager"></div>
				<div class="btnLayout">
					<span class="right">
						<input type="button" value="Export" onclick="downloadExcel()" class="btnColor red btnExpor srcBtn" />
					</span>
				</div>
			</div>
			</div>
			<div id="vulnDescInfo" style="padding: 20px;">
			</div>
		</div>
	</body>
</html>
